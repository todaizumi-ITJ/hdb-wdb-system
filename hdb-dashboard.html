<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HDB - ç™ºä¿¡è€…æƒ…å ±ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .form-input:focus { border-color: #7c3aed; box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.15); }
    .tab-active { background-color: #7c3aed; color: white; }
    .tab-inactive { background-color: #e5e7eb; color: #374151; }
    .tab-inactive:hover { background-color: #d1d5db; }
    .elegant-header { background: linear-gradient(135deg, #4c1d95 0%, #7c3aed 50%, #a78bfa 100%); }
    .elegant-btn { background: linear-gradient(135deg, #5b21b6, #7c3aed); transition: all 0.3s ease; }
    .elegant-btn:hover { background: linear-gradient(135deg, #4c1d95, #6d28d9); transform: translateY(-1px); }
    .role-badge { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
    .role-a { background-color: #dbeafe; color: #1e40af; }
    .role-b { background-color: #fef3c7; color: #92400e; }
    .role-c { background-color: #d1fae5; color: #065f46; }
    .status-badge { display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
    .status-red { background-color: #fee2e2; color: #991b1b; }
    .status-yellow { background-color: #fef3c7; color: #92400e; }
    .status-green { background-color: #d1fae5; color: #065f46; }
    .status-gray { background-color: #f3f4f6; color: #4b5563; }
    /* å¼è­·å£«ä¾é ¼çŠ¶æ³ã‚’æœ€é‡è¦è¡¨ç¤º */
    /* ä¾é ¼æ¸ˆã¿ = å¼è­·å£«åç¾©ã§ã—ã‹é€ã‚Œãªã„ = èµ¤ï¼ˆæ³¨æ„ï¼‰ */
    .mandate-hero-yes {
      background: linear-gradient(135deg, #dc2626 0%, #f87171 100%);
      animation: pulse-red 1.5s ease-in-out infinite;
    }
    /* æœªä¾é ¼ = äº‹å‹™åç¾©OK = ç·‘ */
    .mandate-hero-no {
      background: linear-gradient(135deg, #059669 0%, #10b981 100%);
      animation: pulse-green 2s ease-in-out infinite;
    }
    .mandate-hero-pending {
      background: linear-gradient(135deg, #d97706 0%, #fbbf24 100%);
      animation: pulse-yellow 1.8s ease-in-out infinite;
    }
    @keyframes pulse-red {
      0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.5); }
      50% { box-shadow: 0 0 25px 15px rgba(220, 38, 38, 0.3); }
    }
    @keyframes pulse-green {
      0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(16, 185, 129, 0.2); }
    }
    @keyframes pulse-yellow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(217, 119, 6, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(217, 119, 6, 0.2); }
    }
    .card-hover { transition: all 0.2s ease; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .search-highlight { box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.3); }
    .timeline-item::before { content: ''; position: absolute; left: -1.5rem; top: 0.5rem; width: 0.75rem; height: 0.75rem; border-radius: 50%; background: #7c3aed; }
    .sticky-status { position: sticky; top: 0; z-index: 40; }
    /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      pointer-events: none;
    }
    .toast {
      pointer-events: auto;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      animation: toast-in 0.3s ease forwards;
      max-width: 400px;
    }
    .toast-success { background: #059669; color: white; }
    .toast-error { background: #dc2626; color: white; }
    .toast-warning { background: #d97706; color: white; }
    .toast-info { background: #7c3aed; color: white; }
    .toast-icon { flex-shrink: 0; width: 1.25rem; height: 1.25rem; }
    .toast-message { font-size: 0.875rem; line-height: 1.4; }
    .toast-close {
      margin-left: auto;
      background: none;
      border: none;
      color: inherit;
      opacity: 0.7;
      cursor: pointer;
      padding: 0.25rem;
    }
    .toast-close:hover { opacity: 1; }
    @keyframes toast-in {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes toast-out {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div id="toast-container" class="toast-container"></div>

  <!-- ========================================== -->
  <!-- ãƒ­ãƒ¼ãƒ«é¸æŠç”»é¢ï¼ˆæœ€åˆã®ç”»é¢ï¼‰ -->
  <!-- ========================================== -->
  <div id="role-select-screen" class="min-h-screen flex items-center justify-center">
    <div class="w-full max-w-2xl mx-4">
      <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="elegant-header text-white px-6 py-8 text-center relative">
          <a href="portal.html" class="absolute top-4 left-4 flex items-center gap-2 text-white/80 hover:text-white transition text-sm">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            ãƒãƒ¼ã‚¿ãƒ«ã¸
          </a>
          <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
          </div>
          <h1 class="text-2xl font-bold mb-2">HDB - ç™ºä¿¡è€…æƒ…å ±ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h1>
          <p class="text-purple-200">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
        </div>

        <div class="p-6 space-y-4">
          <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼åå…¥åŠ› -->
          <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 mb-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
            <input type="text" id="login-username" placeholder="ä¾‹ï¼šç”°ä¸­"
              class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg text-lg font-bold focus:outline-none focus:border-purple-500">
            <p class="text-xs text-gray-500 mt-2">â€» äº¤æ¸‰è¨˜éŒ²ãªã©ã«è¨˜éŒ²è€…ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™</p>
          </div>
          <!-- ãƒ­ãƒ¼ãƒ«A: äº‹å‹™æ‹…å½“ï¼ˆ3ã¤ã«åˆ†å‰²ï¼‰ -->
          <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
            <div class="flex items-center gap-2 mb-4">
              <span class="role-badge role-a">ãƒ­ãƒ¼ãƒ«A</span>
              <h3 class="font-bold text-gray-800">äº‹å‹™æ‹…å½“</h3>
            </div>
            <div class="grid grid-cols-3 gap-3">
              <!-- ç™»éŒ² -->
              <button onclick="enterRole('A', 'register')" class="p-4 bg-white hover:bg-blue-100 border border-blue-300 rounded-lg text-center transition">
                <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center mx-auto mb-2">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                  </svg>
                </div>
                <p class="font-bold text-gray-800 text-sm">ç™»éŒ²</p>
                <p class="text-xs text-gray-500 mt-1">é–‹ç¤ºçµæœç™»éŒ²</p>
              </button>
              <!-- æ›¸é¡é€ä»˜ -->
              <button onclick="enterRole('A', 'document')" class="p-4 bg-white hover:bg-blue-100 border border-blue-300 rounded-lg text-center transition">
                <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center mx-auto mb-2">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                  </svg>
                </div>
                <p class="font-bold text-gray-800 text-sm">æ›¸é¡é€ä»˜</p>
                <p class="text-xs text-gray-500 mt-1">é€šçŸ¥æ›¸ãƒ»å‚¬å‘Šæ›¸</p>
              </button>
              <!-- äº¤æ¸‰è¨˜éŒ² -->
              <button onclick="enterRole('A', 'negotiation')" class="p-4 bg-white hover:bg-blue-100 border border-blue-300 rounded-lg text-center transition">
                <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center mx-auto mb-2">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                  </svg>
                </div>
                <p class="font-bold text-gray-800 text-sm">äº¤æ¸‰è¨˜éŒ²</p>
                <p class="text-xs text-gray-500 mt-1">é›»è©±ãƒ»ãƒ¡ãƒ¢</p>
              </button>
            </div>
          </div>

          <!-- ãƒ­ãƒ¼ãƒ«B: ç®¡ç†è€… -->
          <button onclick="enterRole('B')" class="w-full p-6 bg-amber-50 hover:bg-amber-100 border-2 border-amber-200 rounded-xl text-left transition">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 bg-amber-500 rounded-lg flex items-center justify-center flex-shrink-0">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="role-badge role-b">ãƒ­ãƒ¼ãƒ«B</span>
                  <h3 class="font-bold text-gray-800">ç®¡ç†è€…</h3>
                </div>
                <p class="text-sm text-gray-600">å—ä»»ç®¡ç†ãƒ»HNç´ä»˜ã‘ãƒ»ä¿®æ­£</p>
                <p class="text-xs text-amber-600 mt-1">â†’ åå‰ãƒ»ç™ºä¿¡è€…IDãƒ»IPNã§æ¤œç´¢</p>
              </div>
            </div>
          </button>

          <!-- ãƒ­ãƒ¼ãƒ«C: å¼è­·å£« -->
          <button onclick="enterRole('C')" class="w-full p-6 bg-green-50 hover:bg-green-100 border-2 border-green-200 rounded-xl text-left transition">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center flex-shrink-0">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path>
                </svg>
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="role-badge role-c">ãƒ­ãƒ¼ãƒ«C</span>
                  <h3 class="font-bold text-gray-800">å¼è­·å£«</h3>
                </div>
                <p class="text-sm text-gray-600">çŠ¶æ³ç¢ºèªãƒ»åˆ¤æ–­ãƒ»å’Œè§£æˆç«‹</p>
                <p class="text-xs text-green-600 mt-1">â†’ åå‰ã§æ¤œç´¢ / è¦å¯¾å¿œä¸€è¦§</p>
              </div>
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- ãƒ­ãƒ¼ãƒ«A: äº‹å‹™æ‹…å½“UI -->
  <!-- ========================================== -->
  <div id="role-a-screen" class="hidden min-h-screen">
    <header class="bg-blue-600 text-white shadow-lg">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="role-badge bg-white/20 text-white">ãƒ­ãƒ¼ãƒ«A</span>
          <h1 class="text-lg font-bold">äº‹å‹™æ‹…å½“</h1>
        </div>
        <button onclick="backToRoleSelect()" class="text-blue-100 hover:text-white text-sm flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path>
          </svg>
          ãƒ­ãƒ¼ãƒ«é¸æŠã«æˆ»ã‚‹
        </button>
      </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 py-8">
      <!-- 2ã¤ã®ç™»éŒ²ã‚«ãƒ¼ãƒ‰ -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">

        <!-- ãƒ—ãƒ­ãƒã‚¤ãƒ€é–‹ç¤ºç™»éŒ² -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border-2 border-blue-200 hover:border-blue-400 transition-colors">
          <div class="bg-blue-600 text-white px-6 py-4">
            <h3 class="text-lg font-bold">ğŸ“„ ãƒ—ãƒ­ãƒã‚¤ãƒ€é–‹ç¤ºç™»éŒ²</h3>
            <p class="text-blue-100 text-sm">ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‹ã‚‰å±Šã„ãŸé–‹ç¤ºçµæœã‚’ç™»éŒ²</p>
          </div>
          <div class="p-6 space-y-4">
            <button onclick="openCsvUploadModal()" class="w-full py-4 bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-xl text-blue-700 font-medium flex items-center justify-center gap-3 transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
              </svg>
              CSVã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            </button>
            <button onclick="openNewDisclosureModal()" class="w-full py-4 bg-gray-50 hover:bg-gray-100 border-2 border-gray-200 rounded-xl text-gray-700 font-medium flex items-center justify-center gap-3 transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
              æ‰‹å‹•ã§å…¥åŠ›
            </button>
          </div>
        </div>

        <!-- å¼è­·å£«å—ä»»é€šçŸ¥ç™»éŒ² -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border-2 border-red-200 hover:border-red-400 transition-colors">
          <div class="bg-red-600 text-white px-6 py-4">
            <h3 class="text-lg font-bold">âš–ï¸ å¼è­·å£«å—ä»»é€šçŸ¥ç™»éŒ²</h3>
            <p class="text-red-100 text-sm">ç›¸æ‰‹æ–¹å¼è­·å£«ã‹ã‚‰ã®å—ä»»é€šçŸ¥ã‚’ç™»éŒ²</p>
          </div>
          <div class="p-6 space-y-4">
            <button onclick="openLawyerNoticeModal()" class="w-full py-4 bg-red-50 hover:bg-red-100 border-2 border-red-200 rounded-xl text-red-700 font-medium flex items-center justify-center gap-3 transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
              æ—¢å­˜ç™ºä¿¡è€…ã‹ã‚‰æ¤œç´¢
            </button>
            <button onclick="openLawyerNoticeManualModal()" class="w-full py-4 bg-gray-50 hover:bg-gray-100 border-2 border-gray-200 rounded-xl text-gray-700 font-medium flex items-center justify-center gap-3 transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
              æ‰‹å‹•ã§å…¥åŠ›
            </button>
          </div>
        </div>
      </div>

      <!-- æœ€è¿‘ã®ç™»éŒ² -->
      <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“ æœ€è¿‘ã®ç™»éŒ²</h3>
        <div id="recent-registrations" class="space-y-2">
          <div class="p-3 bg-blue-50 rounded-lg flex justify-between items-center">
            <div>
              <p class="font-medium">å±±ç”° å¤ªéƒ</p>
              <p class="text-xs text-gray-500">HN-000456 / 2026/01/30ç™»éŒ²</p>
            </div>
            <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded">é–‹ç¤º</span>
          </div>
          <div class="p-3 bg-red-50 rounded-lg flex justify-between items-center">
            <div>
              <p class="font-medium">éˆ´æœ¨ èŠ±å­ â†’ ä½è—¤å¼è­·å£«</p>
              <p class="text-xs text-gray-500">HN-000789 / 2026/01/29ç™»éŒ²</p>
            </div>
            <span class="text-xs px-2 py-1 bg-red-100 text-red-700 rounded">å—ä»»</span>
          </div>
          <div class="p-3 bg-gray-50 rounded-lg flex justify-between items-center">
            <div>
              <p class="font-medium">é«˜æ©‹ å››éƒ</p>
              <p class="text-xs text-gray-500">HN-000890 / 2026/01/28ç™»éŒ²</p>
            </div>
            <span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded">ç™»éŒ²æ¸ˆ</span>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ========================================== -->
  <!-- æ›¸é¡é€ä»˜ç”»é¢ï¼ˆäº‹å‹™æ‹…å½“ç”¨ï¼‰ -->
  <!-- ========================================== -->
  <div id="document-send-screen" class="hidden min-h-screen">
    <header class="bg-blue-600 text-white shadow-lg">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="role-badge bg-white/20 text-white">ãƒ­ãƒ¼ãƒ«A</span>
          <h1 class="text-lg font-bold">æ›¸é¡é€ä»˜</h1>
        </div>
        <button onclick="backToRoleSelect()" class="text-blue-100 hover:text-white text-sm flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path>
          </svg>
          ãƒ­ãƒ¼ãƒ«é¸æŠã«æˆ»ã‚‹
        </button>
      </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-6">
      <!-- æ›¸é¡é¸æŠãƒœã‚¿ãƒ³ -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <p class="text-sm text-gray-600 mb-4">é€ä»˜ã™ã‚‹æ›¸é¡ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        <div class="flex gap-3 items-stretch">
          <button onclick="filterByDocType(1)" id="btn-1" class="doc-type-btn flex-1 p-4 border-2 border-blue-500 bg-blue-50 rounded-xl text-center transition hover:bg-blue-100">
            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-2 text-white font-bold">1</div>
            <p class="font-bold text-blue-800">é€šçŸ¥æ›¸</p>
            <p class="text-xs text-gray-500 mt-1">åˆå›é€ä»˜</p>
          </button>
          <button onclick="filterByDocType(2)" id="btn-2" class="doc-type-btn flex-1 p-4 border-2 border-gray-200 bg-gray-50 rounded-xl text-center transition hover:bg-orange-50 hover:border-orange-300">
            <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center mx-auto mb-2 text-white font-bold">2</div>
            <p class="font-bold text-gray-800">ï¼’å›ç›®è­¦å‘Šæ›¸</p>
            <p class="text-xs text-gray-500 mt-1">é€šçŸ¥æ›¸é€ä»˜æ¸ˆ</p>
          </button>
          <button onclick="filterByDocType(3)" id="btn-3" class="doc-type-btn flex-1 p-4 border-2 border-gray-200 bg-gray-50 rounded-xl text-center transition hover:bg-red-50 hover:border-red-300">
            <div class="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center mx-auto mb-2 text-white font-bold">3</div>
            <p class="font-bold text-gray-800">ï¼“å›ç›®è­¦å‘Šæ›¸</p>
            <p class="text-xs text-gray-500 mt-1">2å›ç›®é€ä»˜æ¸ˆ</p>
          </button>
          <!-- 4å›ç›®ä»¥é™ã¯ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
          <div class="flex-1 p-4 border-2 border-gray-200 bg-gray-50 rounded-xl text-center">
            <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center mx-auto mb-2 text-white font-bold">4+</div>
            <select id="dropdown-warning" onchange="filterByDocType(parseInt(this.value))" class="w-full px-2 py-1 border border-gray-300 rounded-lg text-sm font-bold text-gray-800 bg-white">
              <option value="4">ï¼”å›ç›®è­¦å‘Šæ›¸</option>
              <option value="5">ï¼•å›ç›®è­¦å‘Šæ›¸</option>
              <option value="6">ï¼–å›ç›®è­¦å‘Šæ›¸</option>
              <option value="7">ï¼—å›ç›®è­¦å‘Šæ›¸</option>
              <option value="8">ï¼˜å›ç›®è­¦å‘Šæ›¸</option>
              <option value="9">ï¼™å›ç›®è­¦å‘Šæ›¸</option>
              <option value="10">10å›ç›®è­¦å‘Šæ›¸</option>
              <option value="11">11å›ç›®è­¦å‘Šæ›¸</option>
              <option value="12">12å›ç›®è­¦å‘Šæ›¸</option>
              <option value="13">13å›ç›®è­¦å‘Šæ›¸</option>
              <option value="14">14å›ç›®è­¦å‘Šæ›¸</option>
              <option value="15">15å›ç›®è­¦å‘Šæ›¸</option>
              <option value="16">16å›ç›®è­¦å‘Šæ›¸</option>
              <option value="17">17å›ç›®è­¦å‘Šæ›¸</option>
              <option value="18">18å›ç›®è­¦å‘Šæ›¸</option>
              <option value="19">19å›ç›®è­¦å‘Šæ›¸</option>
              <option value="20">20å›ç›®è­¦å‘Šæ›¸</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">4å›ç›®ä»¥é™</p>
          </div>
        </div>
      </div>

      <!-- èª¬æ˜ + ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
      <div id="doc-list-header" class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
        <div class="flex items-center justify-between">
          <p class="text-blue-800 text-sm">
            <span class="font-bold">ğŸ“‹ <span id="selected-doc-type">é€šçŸ¥æ›¸</span>é€ä»˜å¯¾è±¡è€…ä¸€è¦§</span>ï½œ
            ç›¸æ‰‹æ–¹å¼è­·å£«ãªã— ï¼ çµŒéæ—¥æ•°é † ï¼ ä¸Šé™100ä»¶
          </p>
          <div class="flex gap-2">
            <button onclick="exportCSV()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-bold flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
              </svg>
              CSVå‡ºåŠ›
            </button>
            <button onclick="markAsSent()" id="btn-mark-sent" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-bold flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              é€ä»˜æ¸ˆã¿ã«ã™ã‚‹ (<span id="selected-count">0</span>ä»¶)
            </button>
          </div>
        </div>
      </div>

      <!-- ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <table class="w-full">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="px-3 py-3 text-center">
                <input type="checkbox" id="select-all" onclick="toggleSelectAll()" class="w-5 h-5 rounded">
              </th>
              <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">æ°å</th>
              <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">ä½æ‰€</th>
              <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">é€ä»˜å›æ•°</th>
              <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">å‰å›é€ä»˜</th>
              <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">çµŒéæ—¥æ•°</th>
            </tr>
          </thead>
          <tbody id="doc-table-body" class="divide-y divide-gray-100">
            <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
          </tbody>
        </table>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <div id="doc-table-footer" class="px-4 py-3 bg-gray-50 border-t border-gray-200 flex items-center justify-between">
          <span class="text-sm text-gray-600">è¡¨ç¤ºä»¶æ•°ï¼š<span id="total-count">0</span>ä»¶ ï¼ ä¸Šé™100ä»¶</span>
          <div class="flex gap-2">
            <button onclick="exportCSV()" class="px-3 py-1 bg-green-100 hover:bg-green-200 text-green-700 rounded text-sm font-medium">CSVå‡ºåŠ›</button>
            <button onclick="markAsSent()" class="px-3 py-1 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded text-sm font-medium">é¸æŠã‚’é€ä»˜æ¸ˆã¿ã«</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ========================================== -->
  <!-- IPNç´ä»˜ã‘ç”»é¢ -->
  <!-- ========================================== -->
  <div id="ipn-link-screen" class="hidden min-h-screen">
    <header class="bg-orange-600 text-white shadow-lg">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="role-badge bg-white/20 text-white">ãƒ­ãƒ¼ãƒ«A</span>
          <h1 class="text-lg font-bold">ğŸ”— IPNç´ä»˜ã‘</h1>
        </div>
        <button onclick="closeIpnLinkScreen()" class="text-orange-100 hover:text-white text-sm flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path>
          </svg>
          ç™»éŒ²ç”»é¢ã«æˆ»ã‚‹
        </button>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-6">
      <!-- æ¤œç´¢ã‚¨ãƒªã‚¢ -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <h2 class="text-lg font-bold text-gray-800 mb-4">IPNãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢</h2>
        <p class="text-sm text-gray-500 mb-4">åˆ¥DBã‹ã‚‰IPNãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ã—ã¦ç™ºä¿¡è€…ã«ç´ä»˜ã‘ã¾ã™</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-2">IPã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input type="text" id="ipn-search-ip" placeholder="192.168.1.1"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-2">æ¨©åˆ©è€…</label>
            <select id="ipn-search-holder" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white">
              <option value="">ã™ã¹ã¦</option>
              <option value="Aç¤¾">Aç¤¾</option>
              <option value="Bç¤¾">Bç¤¾</option>
              <option value="Cç¤¾">Cç¤¾</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-2">ãƒ—ãƒ­ãƒã‚¤ãƒ€</label>
            <select id="ipn-search-provider" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white">
              <option value="">ã™ã¹ã¦</option>
              <option value="NTT">NTT</option>
              <option value="KDDI">KDDI</option>
              <option value="SoftBank">SoftBank</option>
              <option value="So-net">So-net</option>
            </select>
          </div>
        </div>
        <div class="flex gap-3">
          <button onclick="searchIpnData()" class="px-6 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-xl font-bold">
            ğŸ” æ¤œç´¢
          </button>
          <button onclick="clearIpnSearch()" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-bold">
            ã‚¯ãƒªã‚¢
          </button>
        </div>
      </div>

      <!-- æ¤œç´¢çµæœãƒ†ãƒ¼ãƒ–ãƒ« -->
      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
          <h3 class="font-bold text-gray-800">æ¤œç´¢çµæœ <span id="ipn-result-count" class="text-orange-500"></span></h3>
          <div class="text-sm text-gray-500">
            ç´ä»˜ã‘æ¸ˆã¿: <span class="text-green-600 font-bold" id="ipn-linked-count">0</span>ä»¶ /
            æœªç´ä»˜ã‘: <span class="text-orange-600 font-bold" id="ipn-unlinked-count">0</span>ä»¶
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600">çŠ¶æ…‹</th>
                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600">IPã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600">ãƒãƒ¼ãƒˆ</th>
                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600">æ™‚åˆ»</th>
                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600">ãƒ—ãƒ­ãƒã‚¤ãƒ€</th>
                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600">æ¨©åˆ©è€…</th>
                <th class="px-4 py-3 text-left text-xs font-bold text-gray-600">ä½œå“å</th>
                <th class="px-4 py-3 text-center text-xs font-bold text-gray-600">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="ipn-table-body" class="divide-y divide-gray-100">
              <!-- IPNãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </tbody>
          </table>
        </div>
        <div id="ipn-no-results" class="hidden p-8 text-center text-gray-400">
          æ¤œç´¢æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„
        </div>
      </div>
    </main>
  </div>

  <!-- IPNç´ä»˜ã‘ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="ipn-link-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden">
      <div class="bg-orange-500 text-white px-6 py-4">
        <h3 class="text-lg font-bold">ğŸ”— IPNã‚’ç™ºä¿¡è€…ã«ç´ä»˜ã‘</h3>
      </div>
      <div class="p-6">
        <div class="bg-orange-50 rounded-lg p-4 mb-4">
          <p class="text-sm text-gray-600 mb-1">ç´ä»˜ã‘ã‚‹IPN</p>
          <p class="font-bold text-gray-800" id="modal-ipn-info">-</p>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-600 mb-2">ç´ä»˜ã‘å…ˆã®ç™ºä¿¡è€…ã‚’æ¤œç´¢</label>
          <div class="flex gap-2">
            <input type="text" id="ipn-link-search" placeholder="åå‰ãƒ»IDãƒ»é›»è©±ç•ªå·ã§æ¤œç´¢"
              class="flex-1 px-4 py-3 border border-gray-300 rounded-lg">
            <button onclick="searchPersonForIpn()" class="px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg">æ¤œç´¢</button>
          </div>
        </div>
        <div id="ipn-link-person-list" class="max-h-48 overflow-y-auto space-y-2 mb-4">
          <!-- æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤º -->
        </div>
        <div id="ipn-selected-person" class="hidden bg-green-50 rounded-lg p-4 mb-4">
          <p class="text-sm text-gray-600 mb-1">é¸æŠä¸­ã®ç™ºä¿¡è€…</p>
          <p class="font-bold text-green-800" id="ipn-selected-person-name">-</p>
        </div>
      </div>
      <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3">
        <button onclick="closeIpnLinkModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button onclick="confirmIpnLink()" id="ipn-link-confirm-btn" disabled
          class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
          ç´ä»˜ã‘ã‚’ç¢ºå®š
        </button>
      </div>
    </div>
  </div>

  <!-- å—ä»»é€šçŸ¥ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="junin-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden max-h-[90vh] overflow-y-auto">
      <div class="bg-red-600 text-white px-6 py-4">
        <h3 class="text-lg font-bold">ğŸ“© å—ä»»é€šçŸ¥ã‚’ç™»éŒ²</h3>
        <p class="text-red-100 text-sm">å¼è­·å£«ã‹ã‚‰å—ä»»é€šçŸ¥ãŒå±Šã„ãŸå ´åˆã«ç™»éŒ²ã—ã¦ãã ã•ã„</p>
      </div>
      <div class="p-6">
        <!-- æ—¢å­˜/æ–°è¦é¸æŠ -->
        <div class="mb-6">
          <label class="block text-sm font-bold text-gray-700 mb-3">å¯¾è±¡ã®ç™ºä¿¡è€…</label>
          <div class="flex gap-4 mb-4">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="junin-person-type" value="existing" checked onchange="toggleJuninPersonType()">
              <span>æ—¢å­˜ã®ç™ºä¿¡è€…ã«è¿½åŠ </span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="junin-person-type" value="new" onchange="toggleJuninPersonType()">
              <span>æ–°è¦ç™ºä¿¡è€…ã¨ã—ã¦ç™»éŒ²</span>
            </label>
          </div>

          <!-- æ—¢å­˜ç™ºä¿¡è€…æ¤œç´¢ -->
          <div id="junin-existing-section">
            <div class="flex gap-2 mb-3">
              <input type="text" id="junin-search" placeholder="åå‰ãƒ»IDãƒ»é›»è©±ç•ªå·ã§æ¤œç´¢"
                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg">
              <button onclick="searchPersonForJunin()" class="px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg">æ¤œç´¢</button>
            </div>
            <div id="junin-person-list" class="max-h-32 overflow-y-auto space-y-2 mb-3">
              <!-- æ¤œç´¢çµæœ -->
            </div>
            <div id="junin-selected-person" class="hidden bg-blue-50 rounded-lg p-3 border-2 border-blue-300">
              <p class="text-xs text-gray-500">é¸æŠä¸­</p>
              <p class="font-bold text-blue-800" id="junin-selected-person-name">-</p>
            </div>
          </div>

          <!-- æ–°è¦ç™ºä¿¡è€…å…¥åŠ› -->
          <div id="junin-new-section" class="hidden space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">æ°å <span class="text-red-500">*</span></label>
                <input type="text" id="junin-new-name" placeholder="å±±ç”° å¤ªéƒ" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">é›»è©±ç•ªå·</label>
                <input type="text" id="junin-new-phone" placeholder="090-1234-5678" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">ä½æ‰€</label>
              <input type="text" id="junin-new-address" placeholder="æ±äº¬éƒ½..." class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
          </div>
        </div>

        <!-- å¼è­·å£«æƒ…å ±ï¼ˆå¿…é ˆï¼‰ -->
        <div class="bg-red-50 rounded-lg p-4 border border-red-200">
          <label class="block text-sm font-bold text-red-700 mb-3">âš  å¼è­·å£«æƒ…å ±ï¼ˆå¿…é ˆï¼‰</label>
          <div class="space-y-4">
            <!-- å¼è­·å£«ã‚³ãƒ¼ãƒ‰å…¥åŠ› -->
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">å¼è­·å£«ã‚³ãƒ¼ãƒ‰ <span class="text-red-500">*</span></label>
              <div class="flex gap-3 items-start">
                <div class="w-24">
                  <input type="text" id="junin-lawyer-code" maxlength="2" placeholder="TN"
                    oninput="onLawyerCodeInput()"
                    class="w-full px-4 py-3 border-2 border-red-300 rounded-lg text-center text-xl font-bold uppercase tracking-widest">
                </div>
                <div id="junin-lawyer-info" class="flex-1 bg-white rounded-lg p-3 border border-gray-200 min-h-[60px]">
                  <p class="text-gray-400 text-sm">2æ–‡å­—ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">å—ä»»é€šçŸ¥æ—¥ <span class="text-red-500">*</span></label>
              <input type="date" id="junin-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">å‚™è€ƒ</label>
              <textarea id="junin-note" rows="2" placeholder="ãã®ä»–é€£çµ¡äº‹é …ãªã©" class="w-full px-4 py-2 border border-gray-300 rounded-lg resize-none"></textarea>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3">
        <button onclick="closeJuninModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button onclick="confirmJuninRegistration()" id="junin-confirm-btn"
          class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold">
          å—ä»»é€šçŸ¥ã‚’ç™»éŒ²
        </button>
      </div>
    </div>
  </div>

  <!-- å¼è­·å£«å—ä»»é€šçŸ¥ æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="lawyer-notice-manual-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden max-h-[90vh] overflow-y-auto">
      <div class="bg-red-600 text-white px-6 py-4">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-bold">âš–ï¸ å¼è­·å£«å—ä»»é€šçŸ¥ç™»éŒ²ï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰</h3>
            <p class="text-red-100 text-sm">ç™ºä¿¡è€…æƒ…å ±ã¨å¼è­·å£«æƒ…å ±ã‚’å…¥åŠ›</p>
          </div>
          <button onclick="closeLawyerNoticeManualModal()" class="text-white/70 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="p-6">
        <!-- å¥‘ç´„è€…æƒ…å ± -->
        <div class="space-y-4 mb-6">
          <p class="text-sm font-bold text-gray-700 border-b pb-2">ğŸ“‹ å¥‘ç´„è€…æƒ…å ±</p>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">å¥‘ç´„è€…å <span class="text-red-500">*</span></label>
              <input type="text" id="lawyer-manual-name" placeholder="å±±ç”° å¤ªéƒ" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">ãµã‚ŠãŒãª</label>
              <input type="text" id="lawyer-manual-name-kana" placeholder="ã‚„ã¾ã  ãŸã‚ã†" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
          </div>
        </div>

        <!-- åˆ©ç”¨è€…æƒ…å ± -->
        <div class="space-y-4 mb-6">
          <p class="text-sm font-bold text-gray-700 border-b pb-2">ğŸ‘¤ åˆ©ç”¨è€…æƒ…å ±</p>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">åˆ©ç”¨è€…å</label>
              <input type="text" id="lawyer-manual-user-name" placeholder="å±±ç”° æ¬¡éƒ" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">ãµã‚ŠãŒãª</label>
              <input type="text" id="lawyer-manual-user-kana" placeholder="ã‚„ã¾ã  ã˜ã‚ã†" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
          </div>
        </div>

        <!-- é€£çµ¡å…ˆæƒ…å ± -->
        <div class="space-y-4 mb-6">
          <p class="text-sm font-bold text-gray-700 border-b pb-2">ğŸ“ é€£çµ¡å…ˆ</p>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">éƒµä¾¿ç•ªå·</label>
              <input type="text" id="lawyer-manual-postal" placeholder="123-4567" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div class="col-span-2">
              <label class="block text-sm font-medium text-gray-600 mb-1">ä½æ‰€ <span class="text-red-500">*</span></label>
              <input type="text" id="lawyer-manual-address" placeholder="æ±äº¬éƒ½æ–°å®¿åŒºè¥¿æ–°å®¿1-1-1" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">é›»è©±ç•ªå·</label>
              <input type="text" id="lawyer-manual-phone" placeholder="090-1234-5678" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">é›»å­ãƒ¡ãƒ¼ãƒ«</label>
              <input type="email" id="lawyer-manual-email" placeholder="example@email.com" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
          </div>
        </div>

        <!-- å¼è­·å£«æƒ…å ± -->
        <div class="space-y-4 mb-6 bg-red-50 p-4 rounded-lg border border-red-200">
          <p class="text-sm font-bold text-red-700 border-b border-red-200 pb-2">âš–ï¸ å¼è­·å£«æƒ…å ±</p>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">å¼è­·å£«ã‚³ãƒ¼ãƒ‰ <span class="text-red-500">*</span></label>
              <div class="flex gap-2">
                <input type="text" id="lawyer-manual-code" placeholder="L001" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" onblur="lookupLawyerByCodeManual()">
                <button onclick="openLawyerMasterSelectManual()" class="px-3 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-xs">
                  é¸æŠ
                </button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">å¼è­·å£«å</label>
              <input type="text" id="lawyer-manual-lawyer-name" placeholder="è‡ªå‹•å…¥åŠ›" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">å—ä»»æ—¥</label>
            <input type="date" id="lawyer-manual-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
        </div>

        <!-- ãƒ¡ãƒ¢ -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-600 mb-1">ãƒ¡ãƒ¢</label>
          <textarea id="lawyer-manual-memo" rows="2" placeholder="å‚™è€ƒãªã©..." class="w-full px-4 py-2 border border-gray-300 rounded-lg resize-none"></textarea>
        </div>
      </div>
      <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3">
        <button onclick="closeLawyerNoticeManualModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button onclick="saveLawyerNoticeManual()" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold">
          ç™»éŒ²
        </button>
      </div>
    </div>
  </div>

  <!-- å¼è­·å£«å—ä»»é€šçŸ¥ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="lawyer-notice-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden">
      <div class="bg-red-600 text-white px-6 py-4">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-bold">âš–ï¸ å¼è­·å£«å—ä»»é€šçŸ¥ç™»éŒ²</h3>
            <p class="text-red-100 text-sm">ç›¸æ‰‹æ–¹å¼è­·å£«ã‹ã‚‰ã®å—ä»»é€šçŸ¥ã‚’ç™»éŒ²</p>
          </div>
          <button onclick="closeLawyerNoticeModal()" class="text-white/70 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="p-6">
        <!-- ç™ºä¿¡è€…æ¤œç´¢ -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-600 mb-2">ç™ºä¿¡è€…ã‚’æ¤œç´¢ <span class="text-red-500">*</span></label>
          <div class="flex gap-2">
            <input type="text" id="lawyer-notice-search" placeholder="åå‰ã¾ãŸã¯HNç•ªå·ã§æ¤œç´¢"
              class="flex-1 px-4 py-2 border border-gray-300 rounded-lg">
            <button onclick="searchForLawyerNotice()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg">æ¤œç´¢</button>
          </div>
          <div id="lawyer-notice-search-result" class="mt-2 hidden">
            <!-- æ¤œç´¢çµæœ -->
          </div>
          <div id="lawyer-notice-selected" class="mt-3 hidden p-3 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-sm text-gray-500">é¸æŠä¸­:</p>
            <p class="font-bold text-red-800" id="lawyer-notice-selected-name"></p>
            <p class="text-xs text-gray-500" id="lawyer-notice-selected-hn"></p>
          </div>
        </div>

        <!-- å¼è­·å£«æƒ…å ± -->
        <div class="space-y-4">
          <p class="text-sm font-bold text-gray-700 border-b pb-2">å¼è­·å£«æƒ…å ±</p>
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">å¼è­·å£«ã‚³ãƒ¼ãƒ‰ <span class="text-red-500">*</span></label>
            <div class="flex gap-2">
              <input type="text" id="lawyer-notice-code" placeholder="ä¾‹: L001"
                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" onblur="lookupLawyerByCode()">
              <button onclick="openLawyerMasterSelect()" class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm">
                ä¸€è¦§ã‹ã‚‰é¸æŠ
              </button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">å¼è­·å£«å</label>
            <input type="text" id="lawyer-notice-name" placeholder="è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™" readonly
              class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">å—ä»»æ—¥</label>
            <input type="date" id="lawyer-notice-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-600 mb-1">å‚™è€ƒ</label>
            <textarea id="lawyer-notice-memo" rows="2" placeholder="é€£çµ¡äº‹é …ãªã©" class="w-full px-4 py-2 border border-gray-300 rounded-lg resize-none"></textarea>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3">
        <button onclick="closeLawyerNoticeModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button onclick="saveLawyerNotice()" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold">
          ç™»éŒ²
        </button>
      </div>
    </div>
  </div>

  <!-- CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="csv-upload-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden max-h-[90vh] overflow-y-auto">
      <div class="bg-blue-600 text-white px-6 py-4">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-bold">ğŸ“ CSVã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
            <p class="text-blue-100 text-sm">é–‹ç¤ºçµæœã‚’ä¸€æ‹¬ç™»éŒ²ã—ã¾ã™</p>
          </div>
          <button onclick="closeCsvUploadModal()" class="text-white/70 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="p-6">
        <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
        <div class="mb-6">
          <div class="border-2 border-dashed border-blue-300 rounded-xl p-8 text-center bg-blue-50/50 hover:bg-blue-50 transition-colors cursor-pointer" onclick="document.getElementById('csv-file-input').click()">
            <svg class="w-12 h-12 text-blue-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <p class="text-blue-600 font-medium mb-1">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
            <p class="text-sm text-gray-500">ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
            <input type="file" id="csv-file-input" accept=".csv" class="hidden" onchange="handleCsvFileSelect(event)">
          </div>
          <p id="csv-file-name" class="mt-2 text-sm text-gray-600 hidden"></p>
        </div>

        <!-- CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆèª¬æ˜ -->
        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
          <p class="text-sm font-medium text-gray-700 mb-2">ğŸ“‹ CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</p>
          <p class="text-xs text-gray-500 mb-2">ä»¥ä¸‹ã®ã‚«ãƒ©ãƒ ã‚’å«ã‚€CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
          <div class="text-xs text-gray-600 font-mono bg-white p-2 rounded border">
            å¥‘ç´„è€…å,ãµã‚ŠãŒãª,åˆ©ç”¨è€…å,åˆ©ç”¨è€…ãµã‚ŠãŒãª,éƒµä¾¿ç•ªå·,ä½æ‰€,é›»è©±ç•ªå·,é›»å­ãƒ¡ãƒ¼ãƒ«,ãƒ¡ãƒ¢
          </div>
        </div>

        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
        <div id="csv-preview-section" class="hidden mb-6">
          <div class="flex items-center justify-between mb-2">
            <p class="text-sm font-medium text-gray-700">ğŸ“ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</p>
            <span id="csv-preview-count" class="text-sm text-blue-600"></span>
          </div>
          <div class="max-h-48 overflow-y-auto border rounded-lg">
            <table class="w-full text-sm">
              <thead class="bg-gray-50 sticky top-0">
                <tr>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">å¥‘ç´„è€…å</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">ä½æ‰€</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">é›»è©±</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">åˆ©ç”¨è€…</th>
                </tr>
              </thead>
              <tbody id="csv-preview-tbody" class="divide-y divide-gray-100">
              </tbody>
            </table>
          </div>
        </div>

        <!-- é‡è¤‡ãƒã‚§ãƒƒã‚¯çµæœ -->
        <div id="csv-duplicate-section" class="hidden mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
          <p class="text-sm font-medium text-yellow-800 mb-2">âš ï¸ é‡è¤‡ã®å¯èƒ½æ€§ã‚ã‚Š</p>
          <div id="csv-duplicate-list" class="text-sm text-yellow-700"></div>
        </div>

        <!-- ãƒœã‚¿ãƒ³ -->
        <div class="flex gap-3">
          <button onclick="closeCsvUploadModal()" class="flex-1 py-3 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button id="csv-import-btn" onclick="executeCsvImport()" disabled class="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
            ç™»éŒ²ã™ã‚‹
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ–°è¦ç™ºä¿¡è€…ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="new-person-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden max-h-[90vh] overflow-y-auto">
      <div class="bg-purple-600 text-white px-6 py-4">
        <h3 class="text-lg font-bold">ğŸ“‹ æ–°è¦ç™ºä¿¡è€…ã‚’ç™»éŒ²</h3>
        <p class="text-purple-100 text-sm">é–‹ç¤ºçµæœã‹ã‚‰ç™ºä¿¡è€…æƒ…å ±ã‚’ç™»éŒ²ã—ã¾ã™</p>
      </div>
      <div class="p-6">
        <!-- å¥‘ç´„è€…æƒ…å ± -->
        <div class="space-y-4 mb-6">
          <p class="text-sm font-bold text-gray-700 border-b pb-2">ğŸ“‹ å¥‘ç´„è€…æƒ…å ±</p>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">å¥‘ç´„è€…å <span class="text-red-500">*</span></label>
              <input type="text" id="new-person-name" placeholder="å±±ç”° å¤ªéƒ" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">ãµã‚ŠãŒãª</label>
              <input type="text" id="new-person-name-kana" placeholder="ã‚„ã¾ã  ãŸã‚ã†" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
          </div>
        </div>

        <!-- åˆ©ç”¨è€…æƒ…å ± -->
        <div class="space-y-4 mb-6">
          <p class="text-sm font-bold text-gray-700 border-b pb-2">ğŸ‘¤ åˆ©ç”¨è€…æƒ…å ±</p>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">åˆ©ç”¨è€…å</label>
              <input type="text" id="new-person-user-name" placeholder="å±±ç”° æ¬¡éƒ" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">ãµã‚ŠãŒãª</label>
              <input type="text" id="new-person-user-kana" placeholder="ã‚„ã¾ã  ã˜ã‚ã†" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
          </div>
        </div>

        <!-- é€£çµ¡å…ˆæƒ…å ± -->
        <div class="space-y-4 mb-6">
          <p class="text-sm font-bold text-gray-700 border-b pb-2">ğŸ“ é€£çµ¡å…ˆ</p>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">éƒµä¾¿ç•ªå·</label>
              <input type="text" id="new-person-postal" placeholder="123-4567" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div class="col-span-2">
              <label class="block text-sm font-medium text-gray-600 mb-1">ä½æ‰€ <span class="text-red-500">*</span></label>
              <input type="text" id="new-person-address" placeholder="æ±äº¬éƒ½æ–°å®¿åŒºè¥¿æ–°å®¿1-1-1" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">é›»è©±ç•ªå·</label>
              <input type="text" id="new-person-phone" placeholder="090-1234-5678" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-1">é›»å­ãƒ¡ãƒ¼ãƒ«</label>
              <input type="email" id="new-person-email" placeholder="example@email.com" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>
          </div>
        </div>

        <!-- ãƒ¡ãƒ¢ -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-600 mb-1">ãƒ¡ãƒ¢</label>
          <textarea id="new-person-memo" rows="3" placeholder="å‚™è€ƒãªã©..." class="w-full px-4 py-2 border border-gray-300 rounded-lg resize-none"></textarea>
        </div>

        <!-- é¡ä¼¼ãƒã‚§ãƒƒã‚¯çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="similar-check-result" class="hidden mb-6">
          <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
            <p class="text-yellow-800 font-bold mb-2">âš  é¡ä¼¼ã™ã‚‹ç™ºä¿¡è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</p>
            <p class="text-sm text-yellow-700 mb-3">åŒä¸€äººç‰©ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
            <div id="similar-person-list" class="space-y-2 max-h-40 overflow-y-auto">
              <!-- é¡ä¼¼ç™ºä¿¡è€…ãƒªã‚¹ãƒˆ -->
            </div>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-6 py-4 flex justify-between">
        <button onclick="checkSimilarPersons()" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg">
          é¡ä¼¼ãƒã‚§ãƒƒã‚¯
        </button>
        <div class="flex gap-3">
          <button onclick="closeNewPersonModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button onclick="confirmNewPersonRegistration()" id="new-person-confirm-btn"
            class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-bold">
            ç™»éŒ²
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- äº¤æ¸‰è¨˜éŒ²ç”»é¢ï¼ˆäº‹å‹™æ‹…å½“ç”¨ï¼‰ -->
  <!-- ========================================== -->
  <div id="negotiation-screen" class="hidden min-h-screen">
    <header class="bg-blue-600 text-white shadow-lg">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="role-badge bg-white/20 text-white">ãƒ­ãƒ¼ãƒ«A</span>
          <h1 class="text-lg font-bold">äº¤æ¸‰è¨˜éŒ²</h1>
          <span class="text-blue-200 text-sm">ãƒ­ã‚°ã‚¤ãƒ³: <span id="nego-login-user" class="font-bold text-white">-</span></span>
        </div>
        <button onclick="backToRoleSelect()" class="text-blue-100 hover:text-white text-sm flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path>
          </svg>
          ãƒ­ãƒ¼ãƒ«é¸æŠã«æˆ»ã‚‹
        </button>
      </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-6">
      <!-- æ¤œç´¢ã‚¨ãƒªã‚¢ -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <h2 class="text-lg font-bold text-gray-800 mb-4">ç™ºä¿¡è€…ã‚’æ¤œç´¢</h2>
        <p class="text-sm text-gray-500 mb-3">ç™ºä¿¡è€…IDã€åå‰ã€é›»è©±ç•ªå·ã®ã„ãšã‚Œã‹ã§æ¤œç´¢ã§ãã¾ã™</p>
        <div class="flex gap-3">
          <input type="text" id="search-name-nego" placeholder="ä¾‹ï¼šHN-000456 / å±±ç”° å¤ªéƒ / 090-1234-5678"
            class="flex-1 px-4 py-3 text-lg border-2 border-blue-300 rounded-xl form-input">
          <button onclick="searchForNegotiation()" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-bold">
            æ¤œç´¢
          </button>
        </div>
      </div>

      <!-- æ¤œç´¢çµæœãƒªã‚¹ãƒˆï¼ˆè¤‡æ•°ä»¶ã®å ´åˆï¼‰ -->
      <div id="nego-search-results" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ” æ¤œç´¢çµæœ <span id="search-result-count" class="text-blue-500"></span></h3>
        <p class="text-sm text-gray-500 mb-4">å¯¾è±¡è€…ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠã—ã¦ãã ã•ã„</p>
        <div id="search-result-list" class="space-y-2 max-h-80 overflow-y-auto">
          <!-- æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>
      </div>

      <!-- æ¤œç´¢çµæœãƒ»è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆé¸æŠå¾Œã«è¡¨ç¤ºï¼‰ -->
      <div id="nego-result" class="hidden">
        <!-- å¯¾è±¡è€…æƒ…å ±ã‚«ãƒ¼ãƒ‰ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã¸ï¼‰ -->
        <div onclick="openPersonDetail()" class="bg-white rounded-xl shadow-lg p-6 mb-6 cursor-pointer hover:shadow-xl hover:bg-blue-50 transition-all border-2 border-transparent hover:border-blue-300">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center">
                <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
              </div>
              <div>
                <h3 class="text-xl font-bold text-gray-800" id="nego-person-name">å±±ç”° å¤ªéƒ</h3>
                <p class="text-gray-500"><span id="nego-person-id">HN-000456</span> ï½œ <span id="nego-person-phone">090-1234-5678</span></p>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <div id="nego-lawyer-status" class="px-4 py-2 bg-green-100 text-green-800 rounded-lg font-bold">
                æœ¬äººå¯¾å¿œ
              </div>
              <div class="text-blue-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </div>
            </div>
          </div>
          <!-- åŸºæœ¬æƒ…å ±ã‚µãƒãƒªãƒ¼ -->
          <div id="nego-person-summary" class="mt-4 pt-4 border-t border-gray-200 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div>
              <p class="text-gray-500">å’Œè§£çŠ¶æ³</p>
              <p id="nego-summary-settlement" class="font-bold text-gray-800">äº¤æ¸‰ä¸­</p>
            </div>
            <div>
              <p class="text-gray-500">è«‹æ±‚é¡</p>
              <p id="nego-summary-amount" class="font-bold text-gray-800">Â¥150,000</p>
            </div>
            <div>
              <p class="text-gray-500">æ›¸é¡é€ä»˜</p>
              <p id="nego-summary-docs" class="font-bold text-gray-800">2å›ç›®è­¦å‘Šæ›¸</p>
            </div>
            <div>
              <p class="text-gray-500">æœ€çµ‚é€£çµ¡</p>
              <p id="nego-summary-lastcontact" class="font-bold text-gray-800">3æ—¥å‰</p>
            </div>
          </div>
          <p class="text-xs text-blue-500 mt-3 text-right">ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º â†’</p>
        </div>

        <!-- è¨˜éŒ²å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“ äº¤æ¸‰è¨˜éŒ²ã‚’è¿½åŠ </h3>
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-2">é€£çµ¡ç¨®åˆ¥</label>
                <select id="nego-type" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-gray-800 bg-white">
                  <option value="phone">ğŸ“ é›»è©±</option>
                  <option value="email">ğŸ“§ ãƒ¡ãƒ¼ãƒ«</option>
                  <option value="other">ğŸ“‹ ãã®ä»–</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-2">æ—¥æ™‚</label>
                <input type="datetime-local" id="nego-datetime" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-2">å†…å®¹</label>
              <textarea id="nego-content" rows="4" placeholder="äº¤æ¸‰å†…å®¹ã‚’å…¥åŠ›..." class="w-full px-4 py-3 border border-gray-300 rounded-lg resize-none"></textarea>
            </div>
            <button onclick="addNegotiationRecord()" class="w-full py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-bold text-lg">
              è¨˜éŒ²ã‚’è¿½åŠ 
            </button>
          </div>
        </div>

        <!-- äº¤æ¸‰ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“œ äº¤æ¸‰å±¥æ­´</h3>
          <div id="nego-timeline" class="relative pl-6 border-l-2 border-blue-200 space-y-4">
            <!-- å‹•çš„ã«è¿½åŠ  -->
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ========================================== -->
  <!-- ãƒ­ãƒ¼ãƒ«B: ç®¡ç†è€…UI -->
  <!-- ========================================== -->
  <div id="role-b-screen" class="hidden min-h-screen">
    <header class="bg-amber-600 text-white shadow-lg">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="role-badge bg-white/20 text-white">ãƒ­ãƒ¼ãƒ«B</span>
          <h1 class="text-lg font-bold">ç®¡ç†è€…</h1>
        </div>
        <button onclick="backToRoleSelect()" class="text-amber-100 hover:text-white text-sm flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path>
          </svg>
          ãƒ­ãƒ¼ãƒ«é¸æŠã«æˆ»ã‚‹
        </button>
      </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-8">
      <!-- ãƒ¡ã‚¤ãƒ³æ¤œç´¢ã‚¨ãƒªã‚¢ -->
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-6 text-center">ç™ºä¿¡è€…ã‚’æ¤œç´¢</h2>

        <!-- åå‰æ¤œç´¢ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰ -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-600 mb-2">åå‰ã§æ¤œç´¢ï¼ˆã‚ˆãä½¿ã†ï¼‰</label>
          <div class="flex gap-3">
            <input type="text" id="search-name-b" placeholder="å±±ç”° å¤ªéƒ"
              class="flex-1 px-5 py-4 text-lg border-2 border-amber-300 rounded-xl form-input search-highlight">
            <button onclick="searchByName('B')" class="bg-amber-500 hover:bg-amber-600 text-white px-8 py-4 rounded-xl font-bold text-lg">
              æ¤œç´¢
            </button>
          </div>
        </div>

        <!-- ãã®ä»–ã®æ¤œç´¢ -->
        <div class="grid grid-cols-3 gap-4 pt-4 border-t border-gray-200">
          <div>
            <label class="block text-xs text-gray-500 mb-1">ç™ºä¿¡è€…IDã§æ¤œç´¢</label>
            <div class="flex gap-2">
              <input type="text" placeholder="HN-000000" class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg form-input">
              <button class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">æ¤œç´¢</button>
            </div>
          </div>
          <div>
            <label class="block text-xs text-gray-500 mb-1">IPNã§æ¤œç´¢</label>
            <div class="flex gap-2">
              <input type="text" placeholder="IPN-2026-000000" class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg form-input">
              <button class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">æ¤œç´¢</button>
            </div>
          </div>
          <div>
            <label class="block text-xs text-gray-500 mb-1">ä½æ‰€ã§æ¤œç´¢</label>
            <div class="flex gap-2">
              <input type="text" placeholder="æ–°å®¿åŒº" class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg form-input">
              <button class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">æ¤œç´¢</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-white rounded-xl shadow-md p-4 card-hover border-l-4 border-amber-500 cursor-pointer">
          <p class="text-sm text-gray-500">å—ä»»ç™»éŒ²å¾…ã¡</p>
          <p class="text-2xl font-bold text-amber-600">3ä»¶</p>
          <p class="text-xs text-gray-400 mt-1">â†’ ã‚¯ãƒªãƒƒã‚¯ã§ä¸€è¦§</p>
        </div>
        <div class="bg-white rounded-xl shadow-md p-4 card-hover border-l-4 border-purple-500 cursor-pointer">
          <p class="text-sm text-gray-500">HNç´ä»˜ã‘å¾…ã¡</p>
          <p class="text-2xl font-bold text-purple-600">7ä»¶</p>
          <p class="text-xs text-gray-400 mt-1">â†’ ã‚¯ãƒªãƒƒã‚¯ã§ä¸€è¦§</p>
        </div>
      </div>
    </main>
  </div>

  <!-- ========================================== -->
  <!-- ãƒ­ãƒ¼ãƒ«C: å¼è­·å£«UI -->
  <!-- ========================================== -->
  <div id="role-c-screen" class="hidden min-h-screen">
    <header class="bg-green-600 text-white shadow-lg">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="role-badge bg-white/20 text-white">ãƒ­ãƒ¼ãƒ«C</span>
          <h1 class="text-lg font-bold">å¼è­·å£«</h1>
        </div>
        <button onclick="backToRoleSelect()" class="text-green-100 hover:text-white text-sm flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path>
          </svg>
          ãƒ­ãƒ¼ãƒ«é¸æŠã«æˆ»ã‚‹
        </button>
      </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-8">
      <!-- ãƒ¡ã‚¤ãƒ³æ¤œç´¢ã‚¨ãƒªã‚¢ -->
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-6 text-center">ç™ºä¿¡è€…ã‚’æ¤œç´¢</h2>

        <!-- åå‰æ¤œç´¢ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰ -->
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-2">åå‰ã§æ¤œç´¢</label>
          <div class="flex gap-3">
            <input type="text" id="search-name-c" placeholder="å±±ç”° å¤ªéƒ"
              class="flex-1 px-5 py-4 text-lg border-2 border-green-300 rounded-xl form-input search-highlight">
            <button onclick="searchByName('C')" class="bg-green-500 hover:bg-green-600 text-white px-8 py-4 rounded-xl font-bold text-lg">
              æ¤œç´¢
            </button>
          </div>
        </div>
      </div>

      <!-- è¦å¯¾å¿œä¸€è¦§ -->
      <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="p-4 border-b border-gray-100 bg-amber-50">
          <h3 class="font-bold text-amber-800">âš  è¦å¯¾å¿œï¼ˆåˆ¤æ–­å¾…ã¡ï¼‰</h3>
        </div>
        <div class="divide-y divide-gray-100">
          <!-- ç›¸æ‰‹æ–¹å¼è­·å£«ã‚ã‚Šï¼šèµ¤èƒŒæ™¯ -->
          <div class="p-4 hover:bg-red-100 cursor-pointer bg-red-50 border-l-4 border-red-500" onclick="openPersonDetail('HN-000456', 'å±±ç”° å¤ªéƒ', 'yes')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center text-white font-bold text-lg">âš </div>
                <div>
                  <p class="font-bold text-gray-800">å±±ç”° å¤ªéƒ</p>
                  <p class="text-sm text-gray-500">HN-000456</p>
                </div>
              </div>
              <div class="text-right">
                <span class="px-3 py-1 bg-red-600 text-white rounded-full text-sm font-bold">âš  å¼è­·å£«ã‚ã‚Š</span>
                <p class="text-xs text-red-600 mt-1">ç”°ä¸­å¼è­·å£«</p>
              </div>
            </div>
          </div>
          <!-- ç¢ºèªä¸­ï¼šé»„è‰²èƒŒæ™¯ -->
          <div class="p-4 hover:bg-amber-100 cursor-pointer bg-amber-50 border-l-4 border-amber-500" onclick="openPersonDetail('HN-000345', 'é«˜æ©‹ ä¸‰éƒ', 'pending')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-amber-500 rounded-full flex items-center justify-center text-white font-bold text-lg">?</div>
                <div>
                  <p class="font-bold text-gray-800">é«˜æ©‹ ä¸‰éƒ</p>
                  <p class="text-sm text-gray-500">HN-000345</p>
                </div>
              </div>
              <div class="text-right">
                <span class="px-3 py-1 bg-amber-500 text-white rounded-full text-sm font-bold">ç¢ºèªä¸­</span>
                <p class="text-xs text-amber-600 mt-1">14æ—¥æ›´æ–°ãªã—</p>
              </div>
            </div>
          </div>
          <!-- æœ¬äººå¯¾å¿œï¼šç·‘èƒŒæ™¯ -->
          <div class="p-4 hover:bg-green-100 cursor-pointer bg-green-50 border-l-4 border-green-500" onclick="openPersonDetail('HN-000234', 'éˆ´æœ¨ æ¬¡éƒ', 'no')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold text-lg">â—‹</div>
                <div>
                  <p class="font-bold text-gray-800">éˆ´æœ¨ æ¬¡éƒ</p>
                  <p class="text-sm text-gray-500">HN-000234</p>
                </div>
              </div>
              <div class="text-right">
                <span class="px-3 py-1 bg-green-600 text-white rounded-full text-sm font-bold">æœ¬äººå¯¾å¿œ</span>
                <p class="text-xs text-green-600 mt-1">å¼è­·å£«ãªã—</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ========================================== -->
  <!-- å€‹äººè©³ç´°ç”»é¢ï¼ˆæ¤œç´¢çµæœã‹ã‚‰é·ç§»ï¼‰ -->
  <!-- ========================================== -->
  <div id="person-detail-screen" class="hidden min-h-screen">
    <header class="elegant-header text-white shadow-lg">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button onclick="backToSearch()" class="text-purple-200 hover:text-white flex items-center gap-1">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            æˆ»ã‚‹
          </button>
          <h1 class="text-lg font-bold">ç™ºä¿¡è€…è©³ç´°</h1>
        </div>
        <div id="current-role-badge" class="role-badge bg-white/20 text-white">ãƒ­ãƒ¼ãƒ«A</div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
      <!-- â˜…â˜…â˜…â˜…â˜… ç›¸æ‰‹æ–¹å¼è­·å£«çŠ¶æ³ï¼šæœ€é‡è¦è¡¨ç¤ºï¼ˆç”»é¢æœ€ä¸Šéƒ¨ãƒ»æœ€å¤§ã‚µã‚¤ã‚ºï¼‰ â˜…â˜…â˜…â˜…â˜… -->
      <div id="mandate-hero" class="mandate-hero-yes rounded-2xl shadow-2xl mb-6 p-6 text-white">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-5">
            <div class="w-20 h-20 bg-white/20 rounded-2xl flex items-center justify-center">
              <svg id="mandate-icon" class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
              </svg>
            </div>
            <div>
              <p class="text-white/80 text-sm font-medium mb-1">ç›¸æ‰‹æ–¹å¼è­·å£«</p>
              <p id="mandate-status-text" class="text-4xl font-black tracking-tight">âš  å¼è­·å£«ã‚ã‚Š</p>
              <p id="mandate-lawyer-text" class="text-lg text-white/90 mt-1">ç”°ä¸­æ³•å¾‹äº‹å‹™æ‰€ ç”°ä¸­å¼è­·å£«</p>
            </div>
          </div>
          <div id="mandate-doc-permission" class="text-right hidden">
          </div>
        </div>
      </div>

      <!-- å€‹äººæƒ…å ±ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="sticky-status bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
        <div class="p-4 border-b border-gray-100">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
              </div>
              <div>
                <h2 class="text-xl font-bold text-gray-800" id="detail-name">å±±ç”° å¤ªéƒ</h2>
                <p class="text-gray-500" id="detail-hn-id">HN-000456</p>
              </div>
            </div>
            <div class="text-right text-sm text-gray-500">
              æœ€çµ‚æ›´æ–°ï¼š2026/01/30 14:30
            </div>
          </div>
        </div>

        <!-- å’Œè§£çŠ¶æ³è¡¨ç¤º -->
        <div class="p-4">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs text-gray-500 mb-1">å’Œè§£çŠ¶æ³</p>
              <span class="status-badge status-yellow">
                <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
                äº¤æ¸‰ä¸­
              </span>
            </div>
            <div class="text-xs text-yellow-700 bg-yellow-50 px-3 py-1.5 rounded-lg">
              æœ€çµ‚äº¤æ¸‰ï¼š2026/01/28ï¼ˆ3æ—¥å‰ï¼‰
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <div class="flex gap-2 mb-6 overflow-x-auto">
        <button onclick="switchTab('info')" class="tab-btn tab-active px-4 py-2 rounded-lg font-medium whitespace-nowrap" data-tab="info">
          åŸºæœ¬æƒ…å ±
        </button>
        <button onclick="switchTab('disclosure')" class="tab-btn tab-inactive px-4 py-2 rounded-lg font-medium whitespace-nowrap" data-tab="disclosure">
          é–‹ç¤ºçµæœ
        </button>
        <button onclick="switchTab('documents')" class="tab-btn tab-inactive px-4 py-2 rounded-lg font-medium whitespace-nowrap" data-tab="documents">
          æ›¸é¡é€ä»˜
        </button>
        <button onclick="switchTab('negotiation')" class="tab-btn tab-inactive px-4 py-2 rounded-lg font-medium whitespace-nowrap" data-tab="negotiation">
          äº¤æ¸‰è¨˜éŒ²
        </button>
        <button onclick="switchTab('settlement')" class="tab-btn tab-inactive px-4 py-2 rounded-lg font-medium whitespace-nowrap" data-tab="settlement">
          å’Œè§£ç®¡ç†
        </button>
      </div>

      <!-- ã‚¿ãƒ–1: åŸºæœ¬æƒ…å ± -->
      <div id="tab-info" class="tab-content">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- å·¦ã‚«ãƒ©ãƒ : å¥‘ç´„è€…ãƒ»åˆ©ç”¨è€…æƒ…å ± -->
          <div class="space-y-6">
            <!-- å¥‘ç´„è€…æƒ…å ± -->
            <div class="bg-white rounded-xl shadow-md p-6">
              <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span>ğŸ“</span> å¥‘ç´„è€…æƒ…å ±
              </h3>
              <div class="space-y-3">
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <span class="text-sm text-gray-500">å¥‘ç´„è€…å</span>
                    <p class="font-medium text-gray-800" id="detail-contractor-name">å±±ç”° å¤ªéƒ</p>
                  </div>
                  <div>
                    <span class="text-sm text-gray-500">ãµã‚ŠãŒãª</span>
                    <p class="font-medium text-gray-800" id="detail-contractor-kana">ã‚„ã¾ã  ãŸã‚ã†</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- åˆ©ç”¨è€…æƒ…å ± -->
            <div class="bg-white rounded-xl shadow-md p-6">
              <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span>ğŸ‘¤</span> åˆ©ç”¨è€…æƒ…å ±
              </h3>
              <div class="space-y-3">
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <span class="text-sm text-gray-500">åˆ©ç”¨è€…å</span>
                    <p class="font-medium text-gray-800" id="detail-user-name">å±±ç”° æ¬¡éƒ</p>
                  </div>
                  <div>
                    <span class="text-sm text-gray-500">ãµã‚ŠãŒãª</span>
                    <p class="font-medium text-gray-800" id="detail-user-kana">ã‚„ã¾ã  ã˜ã‚ã†</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- å³ã‚«ãƒ©ãƒ : é€£çµ¡å…ˆãƒ»ãƒ¡ãƒ¢ -->
          <div class="space-y-6">
            <!-- é€£çµ¡å…ˆ -->
            <div class="bg-white rounded-xl shadow-md p-6">
              <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span>ğŸ“</span> é€£çµ¡å…ˆ
              </h3>
              <div class="space-y-3">
                <div class="grid grid-cols-3 gap-4">
                  <div>
                    <span class="text-sm text-gray-500">éƒµä¾¿ç•ªå·</span>
                    <p class="font-medium text-gray-800" id="detail-postal">123-4567</p>
                  </div>
                  <div class="col-span-2">
                    <span class="text-sm text-gray-500">ä½æ‰€</span>
                    <p class="font-medium text-gray-800" id="detail-address">æ±äº¬éƒ½æ–°å®¿åŒºè¥¿æ–°å®¿1-1-1</p>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <span class="text-sm text-gray-500">é›»è©±ç•ªå·</span>
                    <p class="font-medium text-gray-800" id="detail-phone">090-1234-5678</p>
                  </div>
                  <div>
                    <span class="text-sm text-gray-500">é›»å­ãƒ¡ãƒ¼ãƒ«</span>
                    <p class="font-medium text-gray-800" id="detail-email">yamada@example.com</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- ãƒ¡ãƒ¢ -->
            <div class="bg-white rounded-xl shadow-md p-6">
              <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span>ğŸ“</span> ãƒ¡ãƒ¢
              </h3>
              <div class="bg-gray-50 rounded-lg p-4 min-h-[80px]">
                <p class="text-gray-700 whitespace-pre-wrap" id="detail-memo">å‚™è€ƒãªã©...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚¿ãƒ–2: é–‹ç¤ºçµæœ -->
      <div id="tab-disclosure" class="tab-content hidden">
        <div class="bg-white rounded-xl shadow-md p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“‹ é–‹ç¤ºçµæœä¸€è¦§</h3>
          <div id="disclosure-ipn-list" class="space-y-2">
            <div class="p-3 bg-gray-50 rounded-lg hover:bg-blue-50 cursor-pointer">
              <div class="flex justify-between items-center">
                <div>
                  <p class="font-medium text-blue-800">IPN-2026-001234</p>
                  <p class="text-xs text-gray-500">NTTãƒ‰ã‚³ãƒ¢ / 2026/01/10é–‹ç¤º</p>
                </div>
                <span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded">é–‹ç¤ºæ¸ˆ</span>
              </div>
            </div>
            <div class="p-3 bg-gray-50 rounded-lg hover:bg-blue-50 cursor-pointer">
              <div class="flex justify-between items-center">
                <div>
                  <p class="font-medium text-blue-800">IPN-2026-001235</p>
                  <p class="text-xs text-gray-500">KDDI / 2026/01/12é–‹ç¤º</p>
                </div>
                <span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded">é–‹ç¤ºæ¸ˆ</span>
              </div>
            </div>
          </div>
          <div id="disclosure-ipn-empty" class="hidden text-center py-4 text-gray-400">
            é–‹ç¤ºçµæœã¯ã‚ã‚Šã¾ã›ã‚“
          </div>
        </div>
      </div>

      <!-- ã‚¿ãƒ–3: æ›¸é¡é€ä»˜ -->
      <div id="tab-documents" class="tab-content hidden">
        <div id="doc-send-guard" class="mb-6 p-4 rounded-xl bg-green-50 border border-green-200">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
              <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            </div>
            <div>
              <p class="font-bold text-green-800">ğŸŸ¢ å¼è­·å£«å—ä»»æ¸ˆï¼ˆä½è—¤å¼è­·å£«ï¼‰</p>
              <p class="text-sm text-green-700">å¼è­·å£«åç¾©æ›¸é¡ï¼šé€ä»˜å¯</p>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">æ›¸é¡é€ä»˜</h3>
            <div class="space-y-3">
              <div>
                <p class="text-sm font-medium text-gray-600 mb-2">äº‹å‹™åç¾©æ›¸é¡</p>
                <div class="flex flex-wrap gap-2">
                  <button class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm hover:bg-blue-200">äº‹å®Ÿé€šçŸ¥æ›¸</button>
                  <button class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm hover:bg-blue-200">ä»»æ„é€£çµ¡æ›¸</button>
                </div>
              </div>
              <div>
                <p class="text-sm font-medium text-gray-600 mb-2">å¼è­·å£«åç¾©æ›¸é¡</p>
                <div class="flex flex-wrap gap-2">
                  <button class="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm hover:bg-purple-200">å’Œè§£ææ¡ˆæ›¸</button>
                  <button class="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm hover:bg-purple-200">å‚¬å‘Šæ›¸</button>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">é€ä»˜å±¥æ­´</h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between py-2 border-b border-gray-100">
                <span>2026/01/28 å‚¬å‘Šæ›¸</span>
                <span class="text-purple-600">å¼è­·å£«åç¾©</span>
              </div>
              <div class="flex justify-between py-2 border-b border-gray-100">
                <span>2026/01/22 å’Œè§£ææ¡ˆæ›¸</span>
                <span class="text-purple-600">å¼è­·å£«åç¾©</span>
              </div>
              <div class="flex justify-between py-2 border-b border-gray-100">
                <span>2026/01/10 äº‹å®Ÿé€šçŸ¥æ›¸</span>
                <span class="text-blue-600">äº‹å‹™åç¾©</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚¿ãƒ–4: äº¤æ¸‰è¨˜éŒ² -->
      <div id="tab-negotiation" class="tab-content hidden">
        <div class="bg-white rounded-xl shadow-md p-6">
          <h3 class="text-lg font-bold text-gray-800 mb-4">äº¤æ¸‰ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h3>
          <div class="relative pl-6 border-l-2 border-purple-200 space-y-4">
            <div class="relative timeline-item">
              <div class="flex items-center gap-2 mb-1">
                <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">é›»è©±</span>
                <span class="text-sm text-gray-500">2026/01/28 14:30</span>
              </div>
              <p class="text-gray-800 text-sm">æœ¬äººã‚ˆã‚Šé›»è©±ã€‚å‚¬å‘Šæ›¸ã‚’å—é ˜ã€‚åˆ†å‰²å›æ•°å¢—åŠ ã‚’å¸Œæœ›ã€‚</p>
            </div>
            <div class="relative timeline-item">
              <div class="flex items-center gap-2 mb-1">
                <span class="px-2 py-0.5 bg-gray-100 text-gray-700 rounded text-xs">å†…éƒ¨ãƒ¡ãƒ¢</span>
                <span class="text-sm text-gray-500">2026/01/25 10:00</span>
              </div>
              <p class="text-gray-800 text-sm">å¼è­·å£«åˆ¤æ–­ï¼š5å›åˆ†å‰²ã¾ã§å¯ã€‚</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚¿ãƒ–5: å’Œè§£ç®¡ç† -->
      <div id="tab-settlement" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- å·¦å´: å’Œè§£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
          <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">å’Œè§£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
            <div class="space-y-3">
              <div class="flex items-center gap-3 p-4 bg-yellow-50 border-2 border-yellow-300 rounded-lg cursor-pointer" onclick="selectSettlementStatus('negotiating')">
                <input type="radio" name="settlement" id="status-negotiating" checked class="w-5 h-5">
                <div>
                  <span class="font-medium text-yellow-800">ğŸŸ¡ äº¤æ¸‰ä¸­</span>
                  <p class="text-sm text-yellow-700">ã‚„ã‚Šå–ã‚Šã‚ã‚Šãƒ»å’Œè§£æœªæˆç«‹</p>
                </div>
              </div>
              <div class="flex items-center gap-3 p-4 bg-gray-50 border-2 border-gray-200 rounded-lg cursor-pointer" onclick="selectSettlementStatus('settled')">
                <input type="radio" name="settlement" id="status-settled" class="w-5 h-5">
                <div>
                  <span class="font-medium text-green-700">ğŸŸ¢ å’Œè§£æˆç«‹</span>
                  <p class="text-sm text-gray-500">åˆæ„ã‚ã‚Šãƒ»WDBé€£æº</p>
                </div>
              </div>
              <div class="flex items-center gap-3 p-4 bg-gray-50 border-2 border-gray-200 rounded-lg cursor-pointer" onclick="selectSettlementStatus('ended')">
                <input type="radio" name="settlement" id="status-ended" class="w-5 h-5">
                <div>
                  <span class="font-medium text-gray-600">â¬› çµ‚äº†</span>
                  <p class="text-sm text-gray-500">å’Œè§£ä¸æˆç«‹ãƒ»å¯¾å¿œçµ‚äº†</p>
                </div>
              </div>
            </div>
          </div>

          <!-- å³å´: å’Œè§£å¥‘ç´„ã®å†…å®¹ -->
          <div class="bg-white rounded-xl shadow-md p-6" id="settlement-details-section">
            <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“‹ å’Œè§£å¥‘ç´„ã®å†…å®¹</h3>
            <div class="space-y-4">
              <!-- å’Œè§£æ—¥ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">å’Œè§£æ—¥</label>
                <input type="date" id="settlement-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
              </div>

              <!-- å’Œè§£é‡‘é¡ç·é¡ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">å’Œè§£é‡‘é¡ç·é¡</label>
                <div class="relative">
                  <input type="number" id="settlement-total-amount" placeholder="0" class="w-full px-3 py-2 pr-8 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                  <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">å††</span>
                </div>
              </div>

              <!-- æ”¯æ‰•æ–¹æ³• -->
              <div class="grid grid-cols-2 gap-4">
                <!-- æœˆæ¬¡ã®æ”¯æ‰•é¡ -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">æœˆæ¬¡ã®æ”¯æ‰•é¡</label>
                  <div class="relative">
                    <input type="number" id="settlement-monthly-amount" placeholder="0" class="w-full px-3 py-2 pr-8 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">å††</span>
                  </div>
                </div>
                <!-- å›æ•° -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">å›æ•°</label>
                  <div class="relative">
                    <input type="number" id="settlement-installment-count" placeholder="1" min="1" class="w-full px-3 py-2 pr-8 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">å›</span>
                  </div>
                </div>
              </div>

              <!-- åˆå›æ”¯æ‰•æ—¥ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">åˆå›æ”¯æ‰•æ—¥</label>
                <input type="date" id="settlement-first-payment-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
              </div>

              <!-- è¡¨æ˜ä¿è¨¼ã®æœ‰ç„¡ -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">è¡¨æ˜ä¿è¨¼ã®æœ‰ç„¡</label>
                <div class="flex gap-4">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="representation-warranty" value="yes" class="w-4 h-4 text-green-600">
                    <span class="text-sm">ã‚ã‚Š</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="representation-warranty" value="no" class="w-4 h-4 text-green-600">
                    <span class="text-sm">ãªã—</span>
                  </label>
                </div>
              </div>

              <!-- å’Œè§£æ›¸PDF -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">å’Œè§£æ›¸PDF</label>
                <div id="settlement-pdf-dropzone" class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-green-400 transition-colors cursor-pointer" onclick="document.getElementById('settlement-pdf-input').click()">
                  <input type="file" id="settlement-pdf-input" accept=".pdf" class="hidden" onchange="handleSettlementPdfUpload(event)">
                  <div id="settlement-pdf-placeholder">
                    <svg class="w-8 h-8 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <p class="text-sm text-gray-500">ã‚¯ãƒªãƒƒã‚¯ã—ã¦PDFã‚’é¸æŠ</p>
                    <p class="text-xs text-gray-400 mt-1">ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
                  </div>
                  <div id="settlement-pdf-info" class="hidden">
                    <div class="flex items-center justify-center gap-2 text-green-600">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      <span id="settlement-pdf-filename" class="font-medium"></span>
                    </div>
                    <button type="button" onclick="event.stopPropagation(); removeSettlementPdf();" class="mt-2 text-sm text-red-500 hover:text-red-700">å‰Šé™¤</button>
                  </div>
                </div>
              </div>

              <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
              <div class="pt-4 border-t">
                <button onclick="saveSettlementDetails()" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  å’Œè§£æƒ…å ±ã‚’ä¿å­˜
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    let currentRole = 'A';
    let currentSubRole = '';
    let loginUsername = '';

    // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function showToast(message, type = 'info', duration = 4000) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;

      // ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¨­å®š
      const icons = {
        success: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
        error: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
        warning: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',
        info: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
      };

      // æ”¹è¡Œã‚’<br>ã«å¤‰æ›
      const formattedMessage = message.replace(/\n/g, '<br>');

      toast.innerHTML = `
        ${icons[type] || icons.info}
        <span class="toast-message">${formattedMessage}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      `;

      container.appendChild(toast);

      // è‡ªå‹•ã§æ¶ˆãˆã‚‹
      setTimeout(() => {
        toast.style.animation = 'toast-out 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // ãƒ­ãƒ¼ãƒ«é¸æŠ
    function enterRole(role, subRole) {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒã‚§ãƒƒã‚¯
      const usernameInput = document.getElementById('login-username');
      if (usernameInput && !usernameInput.value.trim()) {
        showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        usernameInput.focus();
        return;
      }
      loginUsername = usernameInput ? usernameInput.value.trim() : '';

      currentRole = role;
      currentSubRole = subRole || '';
      document.getElementById('role-select-screen').classList.add('hidden');

      // äº‹å‹™æ‹…å½“ã®ã‚µãƒ–ãƒ­ãƒ¼ãƒ«åˆ†å²
      if (role === 'A' && subRole === 'document') {
        document.getElementById('document-send-screen').classList.remove('hidden');
      } else if (role === 'A' && subRole === 'register') {
        document.getElementById('role-a-screen').classList.remove('hidden');
        // TODO: ç™»éŒ²å°‚ç”¨UIã«åˆ‡ã‚Šæ›¿ãˆ
      } else if (role === 'A' && subRole === 'negotiation') {
        document.getElementById('negotiation-screen').classList.remove('hidden');
        document.getElementById('nego-login-user').textContent = loginUsername;
        initNegotiationScreen();
      } else {
        document.getElementById('role-' + role.toLowerCase() + '-screen').classList.remove('hidden');
      }
    }

    // é€ä»˜ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openSendModal(hnId, name) {
      showToast('é€ä»˜ç™»éŒ²ï¼š' + name + 'ï¼ˆ' + hnId + 'ï¼‰\n\né€ä»˜æ›¸é¡ã‚’é¸æŠã—ã¦é€ä»˜æ—¥ã‚’è¨˜éŒ²ã—ã¾ã™ï¼ˆãƒ‡ãƒ¢ï¼‰', 'info');
    }

    // æ›¸é¡ã‚¿ã‚¤ãƒ—åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆå›æ•°ãƒ™ãƒ¼ã‚¹ï¼‰
    let currentDocNum = 1;

    // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿéš›ã¯DBã‹ã‚‰å–å¾—ï¼‰
    // count = éå»ã®é€ä»˜å›æ•°ã€æ¬¡ã«é€ã‚‹ã®ã¯ count+1 å›ç›®
    const allData = [
      // é€šçŸ¥æ›¸å¯¾è±¡ï¼ˆ0å›é€ä»˜æ¸ˆã¿ï¼‰
      { hn: 'HN-000111', name: 'ä½è—¤ ä¸€éƒ', address: 'æ±äº¬éƒ½æ¸‹è°·åŒºé“ç„å‚1-2-3', count: 0, lastDoc: null, lastDate: null, days: null },
      { hn: 'HN-000222', name: 'ç”°æ‘ èŠ±å­', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚åŒ—åŒºæ¢…ç”°2-3-4', count: 0, lastDoc: null, lastDate: null, days: null },
      { hn: 'HN-000666', name: 'ä¼Šè—¤ ç¾ç©‚', address: 'äº¬éƒ½åºœäº¬éƒ½å¸‚ä¸­äº¬åŒºæ²³åŸç”º1-2-3', count: 0, lastDoc: null, lastDate: null, days: null },
      // 2å›ç›®è­¦å‘Šæ›¸å¯¾è±¡ï¼ˆ1å›é€ä»˜æ¸ˆã¿ï¼‰
      { hn: 'HN-000333', name: 'ä¸­æ‘ å¥å¤ª', address: 'æ„›çŸ¥çœŒåå¤å±‹å¸‚ä¸­åŒºæ „3-4-5', count: 1, lastDoc: 'é€šçŸ¥æ›¸', lastDate: '2025/12/01', days: 61 },
      { hn: 'HN-000444', name: 'æœ¨æ‘ ç¾å’²', address: 'ç¦å²¡çœŒç¦å²¡å¸‚åšå¤šåŒºåšå¤šé§…å‰4-5-6', count: 1, lastDoc: 'é€šçŸ¥æ›¸', lastDate: '2025/12/15', days: 47 },
      { hn: 'HN-000555', name: 'æ¸¡è¾º ç›´æ¨¹', address: 'åŒ—æµ·é“æœ­å¹Œå¸‚ä¸­å¤®åŒºåŒ—5æ¡è¥¿6-7-8', count: 1, lastDoc: 'é€šçŸ¥æ›¸', lastDate: '2026/01/20', days: 11 },
      // 3å›ç›®è­¦å‘Šæ›¸å¯¾è±¡ï¼ˆ2å›é€ä»˜æ¸ˆã¿ï¼‰
      { hn: 'HN-000234', name: 'éˆ´æœ¨ æ¬¡éƒ', address: 'æ±äº¬éƒ½æ–°å®¿åŒºæ–°å®¿5-6-7', count: 2, lastDoc: '2å›ç›®è­¦å‘Šæ›¸', lastDate: '2026/01/05', days: 26 },
      { hn: 'HN-000777', name: 'å±±æœ¬ å¤ªä¸€', address: 'ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚ä¸­åŒºæœ¬ç”º1-2-3', count: 2, lastDoc: '2å›ç›®è­¦å‘Šæ›¸', lastDate: '2025/12/20', days: 42 },
      // 4å›ç›®è­¦å‘Šæ›¸å¯¾è±¡ï¼ˆ3å›é€ä»˜æ¸ˆã¿ï¼‰
      { hn: 'HN-000888', name: 'åŠ è—¤ è£•å­', address: 'åŸ¼ç‰çœŒã•ã„ãŸã¾å¸‚å¤§å®®åŒºæ¡œæœ¨ç”º1-2-3', count: 3, lastDoc: '3å›ç›®è­¦å‘Šæ›¸', lastDate: '2025/12/10', days: 52 },
      // 5å›ç›®è­¦å‘Šæ›¸å¯¾è±¡ï¼ˆ4å›é€ä»˜æ¸ˆã¿ï¼‰
      { hn: 'HN-000999', name: 'æ¾æœ¬ èª ', address: 'å…µåº«çœŒç¥æˆ¸å¸‚ä¸­å¤®åŒºä¸‰å®®ç”º1-2-3', count: 4, lastDoc: '4å›ç›®è­¦å‘Šæ›¸', lastDate: '2025/11/20', days: 72 },
      // 10å›ç›®è­¦å‘Šæ›¸å¯¾è±¡ï¼ˆ9å›é€ä»˜æ¸ˆã¿ï¼‰
      { hn: 'HN-001010', name: 'äº•ä¸Š çœŸç†', address: 'åºƒå³¶çœŒåºƒå³¶å¸‚ä¸­åŒºç´™å±‹ç”º1-2-3', count: 9, lastDoc: '9å›ç›®è­¦å‘Šæ›¸', lastDate: '2025/10/15', days: 108 },
    ];

    function getDocTypeName(num) {
      if (num === 1) return 'é€šçŸ¥æ›¸';
      return num + 'å›ç›®è­¦å‘Šæ›¸';
    }

    function filterByDocType(num) {
      currentDocNum = num;

      // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°ï¼ˆ1ã€œ3ã¯ãƒœã‚¿ãƒ³ã€4ä»¥é™ã¯ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ï¼‰
      document.querySelectorAll('.doc-type-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'bg-blue-50', 'border-orange-500', 'bg-orange-50', 'border-red-500', 'bg-red-50', 'border-purple-500', 'bg-purple-50');
        btn.classList.add('border-gray-200', 'bg-gray-50');
      });

      if (num <= 3) {
        const selectedBtn = document.getElementById('btn-' + num);
        const colors = { 1: 'blue', 2: 'orange', 3: 'red' };
        selectedBtn.classList.remove('border-gray-200', 'bg-gray-50');
        selectedBtn.classList.add('border-' + colors[num] + '-500', 'bg-' + colors[num] + '-50');
        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('dropdown-warning').value = '4';
      } else {
        // 4ä»¥é™ã¯ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®å€¤ã‚’è¨­å®š
        document.getElementById('dropdown-warning').value = num;
      }

      // ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
      document.getElementById('selected-doc-type').textContent = getDocTypeName(num);

      // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆcount = num - 1 ã®äººãŒå¯¾è±¡ï¼‰
      const filteredData = allData.filter(row => row.count === num - 1);
      renderTable(filteredData);
    }

    function renderTable(data) {
      const tbody = document.getElementById('doc-table-body');
      const totalCount = document.getElementById('total-count');

      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">å¯¾è±¡è€…ãŒã„ã¾ã›ã‚“</td></tr>';
        totalCount.textContent = '0';
        updateSelectedCount();
        return;
      }

      // çµŒéæ—¥æ•°ã§ã‚½ãƒ¼ãƒˆï¼ˆnullã¯å…ˆé ­ã€ãã‚Œä»¥å¤–ã¯é™é †ï¼‰
      data.sort((a, b) => {
        if (a.days === null && b.days === null) return 0;
        if (a.days === null) return -1;
        if (b.days === null) return -1;
        return b.days - a.days;
      });

      let html = '';
      data.forEach(row => {
        const bgClass = row.days === null ? 'bg-red-50 hover:bg-red-100' :
                        row.days >= 40 ? 'hover:bg-orange-50' :
                        row.days >= 20 ? 'hover:bg-yellow-50' : 'hover:bg-gray-50';

        const daysDisplay = row.days === null ?
          '<span class="px-3 py-1 bg-red-600 text-white rounded-full text-sm font-bold">æœªé€ä»˜</span>' :
          row.days >= 40 ? '<span class="px-3 py-1 bg-orange-500 text-white rounded-full text-sm font-bold">' + row.days + 'æ—¥</span>' :
          row.days >= 20 ? '<span class="px-3 py-1 bg-yellow-500 text-white rounded-full text-sm font-bold">' + row.days + 'æ—¥</span>' :
          '<span class="px-3 py-1 bg-gray-400 text-white rounded-full text-sm font-bold">' + row.days + 'æ—¥</span>';

        const countBadgeColor = row.count === 0 ? 'gray' : row.count === 1 ? 'blue' : row.count === 2 ? 'purple' : 'red';

        html += `
          <tr class="${bgClass}" data-hn="${row.hn}">
            <td class="px-3 py-3 text-center">
              <input type="checkbox" class="row-checkbox w-5 h-5 rounded" data-hn="${row.hn}" data-name="${row.name}" data-address="${row.address}" onchange="updateSelectedCount()">
            </td>
            <td class="px-4 py-3">
              <p class="font-bold text-gray-800">${row.name}</p>
              <p class="text-xs text-gray-500">${row.hn}</p>
            </td>
            <td class="px-4 py-3 text-sm text-gray-600">${row.address}</td>
            <td class="px-4 py-3 text-center">
              <span class="px-2 py-1 bg-${countBadgeColor}-200 rounded text-sm font-bold">${row.count}å›</span>
            </td>
            <td class="px-4 py-3 text-sm">
              ${row.lastDoc ? `<p class="text-gray-800">${row.lastDoc}</p><p class="text-xs text-gray-500">${row.lastDate}</p>` : '<span class="text-gray-400">ï¼</span>'}
            </td>
            <td class="px-4 py-3 text-center">${daysDisplay}</td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
      totalCount.textContent = data.length;
      document.getElementById('select-all').checked = false;
      updateSelectedCount();
    }

    // å…¨é¸æŠãƒˆã‚°ãƒ«
    function toggleSelectAll() {
      const selectAll = document.getElementById('select-all');
      const checkboxes = document.querySelectorAll('.row-checkbox');
      checkboxes.forEach(cb => cb.checked = selectAll.checked);
      updateSelectedCount();
    }

    // é¸æŠä»¶æ•°æ›´æ–°
    function updateSelectedCount() {
      const checked = document.querySelectorAll('.row-checkbox:checked').length;
      document.getElementById('selected-count').textContent = checked;
      const btn = document.getElementById('btn-mark-sent');
      btn.disabled = checked === 0;
    }

    // CSVå‡ºåŠ›
    function exportCSV() {
      const checkboxes = document.querySelectorAll('.row-checkbox:checked');
      if (checkboxes.length === 0) {
        showToast('CSVã«å‡ºåŠ›ã™ã‚‹å¯¾è±¡ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
        return;
      }

      const docTypeName = getDocTypeName(currentDocNum);
      let csv = 'ç™ºä¿¡è€…ID,æ°å,ä½æ‰€,é€ä»˜æ›¸é¡\n';
      checkboxes.forEach(cb => {
        const hn = cb.dataset.hn;
        const name = cb.dataset.name;
        const address = cb.dataset.address;
        csv += `"${hn}","${name}","${address}","${docTypeName}"\n`;
      });

      // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
      a.download = `webletter_${docTypeName}_${today}.csv`;
      a.click();
      URL.revokeObjectURL(url);

      showToast(checkboxes.length + 'ä»¶ã®CSVã‚’å‡ºåŠ›ã—ã¾ã—ãŸã€‚\nWebãƒ¬ã‚¿ãƒ¼ã§é€ä»˜ã—ã¦ãã ã•ã„ã€‚', 'success');
    }

    // é€ä»˜æ¸ˆã¿ã«ã™ã‚‹
    function markAsSent() {
      const checkboxes = document.querySelectorAll('.row-checkbox:checked');
      if (checkboxes.length === 0) {
        showToast('é€ä»˜æ¸ˆã¿ã«ã™ã‚‹å¯¾è±¡ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
        return;
      }

      const names = [];
      checkboxes.forEach(cb => names.push(cb.dataset.name));

      if (confirm(checkboxes.length + 'ä»¶ã‚’é€ä»˜æ¸ˆã¿ã«ã—ã¾ã™ã‹ï¼Ÿ\n\n' + names.join('\n'))) {
        // å®Ÿéš›ã¯DBã«é€ä»˜è¨˜éŒ²ã‚’ç™»éŒ²
        checkboxes.forEach(cb => {
          const row = cb.closest('tr');
          row.classList.add('opacity-50', 'line-through');
          cb.disabled = true;
        });
        showToast(checkboxes.length + 'ä»¶ã‚’é€ä»˜æ¸ˆã¿ã«ã—ã¾ã—ãŸã€‚', 'success');
        updateSelectedCount();
      }
    }

    // ========================================
    // çµ±ä¸€ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
    // ========================================
    let currentNegoPerson = null;
    let negoTimeline = [];

    // ç™ºä¿¡è€…ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆã™ã¹ã¦ã®æƒ…å ±ã‚’ä¸€å…ƒç®¡ç†ï¼‰
    const personData = {
      'HN-000456': {
        hn: 'HN-000456',
        name: 'å±±ç”° å¤ªéƒ',
        phone: '090-1234-5678',
        address: 'æ±äº¬éƒ½æ–°å®¿åŒºè¥¿æ–°å®¿1-1-1',
        hasLawyer: false,
        lawyerName: null,
        settlement: 'äº¤æ¸‰ä¸­',
        amount: 150000,
        docStatus: '2å›ç›®è­¦å‘Šæ›¸',
        lastContact: '2026/01/28',
        // ç´ä»˜ã‘IPNä¸€è¦§
        linkedIpns: ['IPN-003'],
        // äº¤æ¸‰è¨˜éŒ²
        negoHistory: [
          { type: 'phone', datetime: '2026/01/28 14:30', content: 'æœ¬äººã‚ˆã‚Šé›»è©±ã€‚å‚¬å‘Šæ›¸ã‚’å—é ˜ã€‚åˆ†å‰²å›æ•°å¢—åŠ ã‚’å¸Œæœ›ã€‚', user: 'ä½è—¤' },
          { type: 'email', datetime: '2026/01/25 10:00', content: 'åˆ†å‰²æ‰•ã„ã®æ¡ä»¶ã«ã¤ã„ã¦å•ã„åˆã‚ã›ãƒ¡ãƒ¼ãƒ«ã‚ã‚Šã€‚', user: 'ç”°ä¸­' },
          { type: 'phone', datetime: '2026/01/20 16:00', content: 'åˆå›é€£çµ¡ã€‚å’Œè§£ã®æ„æ€ã‚ã‚Šã€‚', user: 'ä½è—¤' },
        ],
        // æ›¸é¡é€ä»˜å±¥æ­´
        docHistory: [
          { type: 'é€šçŸ¥æ›¸', date: '2026/01/05', user: 'ç”°ä¸­' },
          { type: '1å›ç›®è­¦å‘Šæ›¸', date: '2026/01/15', user: 'ä½è—¤' },
          { type: '2å›ç›®è­¦å‘Šæ›¸', date: '2026/01/25', user: 'ç”°ä¸­' },
        ]
      },
      'HN-000457': {
        hn: 'HN-000457',
        name: 'å±±ç”° èŠ±å­',
        phone: '090-1234-9999',
        address: 'æ±äº¬éƒ½æ¸‹è°·åŒºæ¸‹è°·2-2-2',
        hasLawyer: false,
        lawyerName: null,
        settlement: 'æœªç€æ‰‹',
        amount: 80000,
        docStatus: 'é€šçŸ¥æ›¸',
        lastContact: '2026/01/20',
        linkedIpns: [],
        negoHistory: [],
        docHistory: [
          { type: 'é€šçŸ¥æ›¸', date: '2026/01/20', user: 'éˆ´æœ¨' },
        ]
      },
      'HN-000458': {
        hn: 'HN-000458',
        name: 'å±±ç”° ä¸€éƒ',
        phone: '090-5555-1234',
        address: 'æ±äº¬éƒ½å“å·åŒºå¤§å´3-3-3',
        hasLawyer: true,
        lawyerName: 'ä½è—¤å¼è­·å£«ï¼ˆä½è—¤æ³•å¾‹äº‹å‹™æ‰€ï¼‰',
        settlement: 'å’Œè§£æˆç«‹',
        amount: 200000,
        docStatus: '3å›ç›®è­¦å‘Šæ›¸',
        lastContact: '2026/01/25',
        linkedIpns: [],
        negoHistory: [
          { type: 'phone', datetime: '2026/01/25 10:00', content: 'å¼è­·å£«ã‚ˆã‚Šé€£çµ¡ã€‚å’Œè§£æ¡ä»¶ã«ã¤ã„ã¦å”è­°ã€‚', user: 'ç”°ä¸­' },
        ],
        docHistory: [
          { type: 'é€šçŸ¥æ›¸', date: '2026/01/10', user: 'ç”°ä¸­' },
          { type: '1å›ç›®è­¦å‘Šæ›¸', date: '2026/01/18', user: 'ä½è—¤' },
        ]
      },
      'HN-000234': {
        hn: 'HN-000234',
        name: 'éˆ´æœ¨ æ¬¡éƒ',
        phone: '080-9876-5432',
        address: 'ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚ä¸­åŒº4-4-4',
        hasLawyer: false,
        lawyerName: null,
        settlement: 'äº¤æ¸‰ä¸­',
        amount: 120000,
        docStatus: '1å›ç›®è­¦å‘Šæ›¸',
        lastContact: '2026/01/15',
        linkedIpns: ['IPN-006'],
        negoHistory: [
          { type: 'phone', datetime: '2026/01/15 11:00', content: 'é›»è©±ã‚ã‚Šã€‚æ”¯æ‰•ã„èƒ½åŠ›ã«ã¤ã„ã¦ç›¸è«‡ã€‚', user: 'éˆ´æœ¨' },
        ],
        docHistory: [
          { type: 'é€šçŸ¥æ›¸', date: '2026/01/08', user: 'ä½è—¤' },
          { type: '1å›ç›®è­¦å‘Šæ›¸', date: '2026/01/15', user: 'ç”°ä¸­' },
        ]
      },
      'HN-000235': {
        hn: 'HN-000235',
        name: 'éˆ´æœ¨ ç¾å’²',
        phone: '080-9876-1111',
        address: 'ç¥å¥ˆå·çœŒå·å´å¸‚å¹¸åŒº5-5-5',
        hasLawyer: false,
        lawyerName: null,
        settlement: 'æœªç€æ‰‹',
        amount: 50000,
        docStatus: 'æœªé€ä»˜',
        lastContact: '-',
        linkedIpns: [],
        negoHistory: [],
        docHistory: []
      },
      'HN-000345': {
        hn: 'HN-000345',
        name: 'é«˜æ©‹ ä¸‰éƒ',
        phone: '070-1111-2222',
        address: 'åƒè‘‰çœŒåƒè‘‰å¸‚ä¸­å¤®åŒº6-6-6',
        hasLawyer: true,
        lawyerName: 'ç”°ä¸­å¼è­·å£«ï¼ˆç”°ä¸­æ³•å¾‹äº‹å‹™æ‰€ï¼‰',
        settlement: 'çµ‚äº†',
        amount: 300000,
        docStatus: '4å›ç›®è­¦å‘Šæ›¸',
        lastContact: '2026/01/10',
        linkedIpns: [],
        negoHistory: [
          { type: 'other', datetime: '2026/01/10 15:00', content: 'å’Œè§£æ›¸å—é ˜ã€‚å…¥é‡‘ç¢ºèªæ¸ˆã¿ã€‚', user: 'ä½è—¤' },
        ],
        docHistory: [
          { type: 'é€šçŸ¥æ›¸', date: '2025/12/01', user: 'ç”°ä¸­' },
          { type: '1å›ç›®è­¦å‘Šæ›¸', date: '2025/12/15', user: 'ä½è—¤' },
          { type: '2å›ç›®è­¦å‘Šæ›¸', date: '2025/12/28', user: 'ç”°ä¸­' },
          { type: '3å›ç›®è­¦å‘Šæ›¸', date: '2026/01/05', user: 'éˆ´æœ¨' },
        ]
      },
    };

    // å¼è­·å£«ãƒã‚¹ã‚¿ãƒ¼ï¼ˆç®¡ç†è€…ã®ã¿ç™»éŒ²å¯ã€ã‚³ãƒ¼ãƒ‰ã¯ä¸å¤‰ï¼‰
    const lawyerMaster = {
      'TN': { code: 'TN', name: 'ç”°ä¸­ ä¸€éƒ', office: 'ç”°ä¸­æ³•å¾‹äº‹å‹™æ‰€', phone: '03-1234-5678' },
      'ST': { code: 'ST', name: 'ä½è—¤ èŠ±å­', office: 'ä½è—¤æ³•å¾‹äº‹å‹™æ‰€', phone: '03-2345-6789' },
      'YM': { code: 'YM', name: 'å±±æœ¬ å¤ªéƒ', office: 'å±±æœ¬ãƒ»éˆ´æœ¨æ³•å¾‹äº‹å‹™æ‰€', phone: '03-3456-7890' },
      'SK': { code: 'SK', name: 'éˆ´æœ¨ æ¬¡éƒ', office: 'éˆ´æœ¨ç·åˆæ³•å¾‹äº‹å‹™æ‰€', phone: '06-1111-2222' },
      'WD': { code: 'WD', name: 'æ¸¡è¾º ä¸‰éƒ', office: 'æ¸¡è¾ºæ³•å¾‹äº‹å‹™æ‰€', phone: '052-333-4444' },
    };

    // å¼è­·å£«ã‚³ãƒ¼ãƒ‰ã‹ã‚‰æƒ…å ±ã‚’å–å¾—
    function getLawyerByCode(code) {
      if (!code) return null;
      return lawyerMaster[code.toUpperCase()] || null;
    }

    // å¼è­·å£«ã®ãƒ•ãƒ«è¡¨ç¤ºåã‚’å–å¾—
    function getLawyerDisplayName(code) {
      const lawyer = getLawyerByCode(code);
      if (!lawyer) return null;
      return `${lawyer.name}ï¼ˆ${lawyer.office}ï¼‰`;
    }

    // IPNãƒ‡ãƒ¼ã‚¿ï¼ˆåˆ¥DBæƒ³å®šã ãŒå‚ç…§ç”¨ï¼‰
    const ipnData = [
      { id: 'IPN-001', ip: '192.168.1.100', port: 51413, datetime: '2026/01/25 14:32:15', provider: 'NTT', holder: 'Aç¤¾', title: 'æ˜ ç”»ã‚¿ã‚¤ãƒˆãƒ«A', linked: false, linkedTo: null },
      { id: 'IPN-002', ip: '192.168.1.100', port: 51413, datetime: '2026/01/20 09:15:42', provider: 'NTT', holder: 'Aç¤¾', title: 'æ˜ ç”»ã‚¿ã‚¤ãƒˆãƒ«B', linked: false, linkedTo: null },
      { id: 'IPN-003', ip: '10.0.0.50', port: 6881, datetime: '2026/01/22 18:45:33', provider: 'KDDI', holder: 'Bç¤¾', title: 'ã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆX', linked: true, linkedTo: 'HN-000456' },
      { id: 'IPN-004', ip: '172.16.0.25', port: 51413, datetime: '2026/01/18 22:10:05', provider: 'SoftBank', holder: 'Aç¤¾', title: 'æ˜ ç”»ã‚¿ã‚¤ãƒˆãƒ«C', linked: false, linkedTo: null },
      { id: 'IPN-005', ip: '192.168.2.200', port: 8999, datetime: '2026/01/15 11:25:18', provider: 'So-net', holder: 'Cç¤¾', title: 'éŸ³æ¥½ã‚¢ãƒ«ãƒãƒ Y', linked: false, linkedTo: null },
      { id: 'IPN-006', ip: '10.0.0.50', port: 6881, datetime: '2026/01/28 16:05:22', provider: 'KDDI', holder: 'Bç¤¾', title: 'ã‚²ãƒ¼ãƒ ã‚½ãƒ•ãƒˆZ', linked: true, linkedTo: 'HN-000234' },
      { id: 'IPN-007', ip: '192.168.1.100', port: 51413, datetime: '2026/01/30 08:45:10', provider: 'NTT', holder: 'Cç¤¾', title: 'ã‚¢ãƒ‹ãƒ¡ä½œå“W', linked: false, linkedTo: null },
    ];

    // IPNãƒ‡ãƒ¼ã‚¿ã‚’IDã§å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
    function getIpnById(ipnId) {
      return ipnData.find(d => d.id === ipnId);
    }

    // ç™ºä¿¡è€…ã«ç´ä»˜ã„ãŸIPNã‚’å–å¾—
    function getLinkedIpns(hn) {
      const person = personData[hn];
      if (!person || !person.linkedIpns) return [];
      return person.linkedIpns.map(id => getIpnById(id)).filter(Boolean);
    }

    function initNegotiationScreen() {
      // æ¤œç´¢çµæœã‚’éè¡¨ç¤º
      document.getElementById('nego-result').classList.add('hidden');
      document.getElementById('nego-search-results').classList.add('hidden');
      document.getElementById('search-name-nego').value = '';
      // æ—¥æ™‚ã‚’ç¾åœ¨ã«è¨­å®š
      const now = new Date();
      const datetime = now.toISOString().slice(0, 16);
      if (document.getElementById('nego-datetime')) {
        document.getElementById('nego-datetime').value = datetime;
      }
    }

    function searchForNegotiation() {
      const searchQuery = document.getElementById('search-name-nego').value.trim();
      if (!searchQuery) {
        showToast('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }

      // æ¤œç´¢ã‚¯ã‚¨ãƒªã‚’æ­£è¦åŒ–ï¼ˆãƒã‚¤ãƒ•ãƒ³ã‚„ç©ºç™½ã‚’é™¤å»ã—ã¦æ¯”è¼ƒç”¨ï¼‰
      const normalizedQuery = searchQuery.replace(/[-\s]/g, '').toLowerCase();

      // ç°¡æ˜“æ¤œç´¢ï¼ˆIDã€åå‰ã€é›»è©±ç•ªå·ã§éƒ¨åˆ†ä¸€è‡´ï¼‰- è¤‡æ•°ä»¶å¯¾å¿œ
      const results = [];
      for (const key in personData) {
        const person = personData[key];
        const normalizedHn = person.hn.replace(/[-\s]/g, '').toLowerCase();
        const normalizedName = person.name.replace(/[-\s]/g, '').toLowerCase();
        const normalizedPhone = person.phone.replace(/[-\s]/g, '').toLowerCase();

        // IDã€åå‰ã€é›»è©±ç•ªå·ã®ã„ãšã‚Œã‹ã§ãƒãƒƒãƒ
        if (normalizedHn.includes(normalizedQuery) || normalizedQuery.includes(normalizedHn) ||
            normalizedName.includes(normalizedQuery) || normalizedQuery.includes(normalizedName) ||
            normalizedPhone.includes(normalizedQuery) || normalizedQuery.includes(normalizedPhone)) {
          results.push(personData[key]);
        }
      }

      // æ¤œç´¢çµæœãƒªã‚¹ãƒˆã‚’éè¡¨ç¤ºã«ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('nego-search-results').classList.add('hidden');
      document.getElementById('nego-result').classList.add('hidden');

      if (results.length === 0) {
        showToast('è©²å½“ã™ã‚‹ç™ºä¿¡è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'warning');
        return;
      } else if (results.length === 1) {
        // 1ä»¶ã®ã¿ï¼šç›´æ¥è¡¨ç¤º
        selectPerson(results[0]);
      } else {
        // è¤‡æ•°ä»¶ï¼šãƒªã‚¹ãƒˆè¡¨ç¤º
        showSearchResults(results);
      }
    }

    // æ¤œç´¢çµæœãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
    function showSearchResults(results) {
      const listEl = document.getElementById('search-result-list');
      document.getElementById('search-result-count').textContent = `ï¼ˆ${results.length}ä»¶ï¼‰`;

      let html = '';
      results.forEach(person => {
        const lawyerBadge = person.hasLawyer
          ? `<span class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded">å¼è­·å£«ã‚ã‚Š</span>`
          : `<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded">æœ¬äººå¯¾å¿œ</span>`;

        html += `
          <div onclick="selectPersonById('${person.hn}')"
               class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-300 cursor-pointer transition-colors">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
              </div>
              <div>
                <p class="font-bold text-gray-800">${person.name}</p>
                <p class="text-sm text-gray-500">${person.hn} ï½œ ${person.phone}</p>
              </div>
            </div>
            ${lawyerBadge}
          </div>
        `;
      });

      listEl.innerHTML = html;
      document.getElementById('nego-search-results').classList.remove('hidden');
    }

    // IDã§é¸æŠ
    function selectPersonById(hn) {
      const person = personData[hn];
      if (person) {
        selectPerson(person);
      }
    }

    // å¯¾è±¡è€…ã‚’é¸æŠã—ã¦è©³ç´°è¡¨ç¤º
    function selectPerson(person) {
      currentNegoPerson = person;

      // æ¤œç´¢çµæœãƒªã‚¹ãƒˆã‚’éè¡¨ç¤º
      document.getElementById('nego-search-results').classList.add('hidden');

      // è¡¨ç¤ºæ›´æ–°
      document.getElementById('nego-person-name').textContent = person.name;
      document.getElementById('nego-person-id').textContent = person.hn;
      document.getElementById('nego-person-phone').textContent = person.phone || '-';

      const lawyerStatus = document.getElementById('nego-lawyer-status');
      if (person.hasLawyer) {
        lawyerStatus.textContent = 'âš  å¼è­·å£«ã‚ã‚Š: ' + (person.lawyerName || '');
        lawyerStatus.className = 'px-4 py-2 bg-red-100 text-red-800 rounded-lg font-bold';
      } else {
        lawyerStatus.textContent = 'æœ¬äººå¯¾å¿œ';
        lawyerStatus.className = 'px-4 py-2 bg-green-100 text-green-800 rounded-lg font-bold';
      }

      // åŸºæœ¬æƒ…å ±ã‚µãƒãƒªãƒ¼è¡¨ç¤º
      document.getElementById('nego-summary-settlement').textContent = person.settlement || '-';
      document.getElementById('nego-summary-amount').textContent = person.amount ? 'Â¥' + person.amount.toLocaleString() : '-';
      document.getElementById('nego-summary-docs').textContent = person.docStatus || '-';

      // æœ€çµ‚é€£çµ¡æ—¥ã‹ã‚‰çµŒéæ—¥æ•°ã‚’è¨ˆç®—
      if (person.lastContact && person.lastContact !== '-') {
        const lastDate = new Date(person.lastContact);
        const today = new Date();
        const diffDays = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
        document.getElementById('nego-summary-lastcontact').textContent = diffDays + 'æ—¥å‰';
      } else {
        document.getElementById('nego-summary-lastcontact').textContent = '-';
      }

      // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤ºï¼ˆçµ±ä¸€ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼‰
      negoTimeline = person.negoHistory || [];
      renderNegoTimeline();

      // æ—¥æ™‚ã‚’ç¾åœ¨ã«è¨­å®š
      const now = new Date();
      document.getElementById('nego-datetime').value = now.toISOString().slice(0, 16);
      document.getElementById('nego-content').value = '';

      // çµæœè¡¨ç¤º
      document.getElementById('nego-result').classList.remove('hidden');
    }

    // è©³ç´°ç”»é¢ã‚’é–‹ãï¼ˆãƒ­ãƒ¼ãƒ«Aã®ãƒ¡ã‚¤ãƒ³ç”»é¢ã«é·ç§»ï¼‰
    function openPersonDetail() {
      if (!currentNegoPerson) return;

      // ãƒ¡ã‚¤ãƒ³ã®ãƒ­ãƒ¼ãƒ«Aç”»é¢ã«é·ç§»ã—ã€è©²å½“è€…ã‚’è¡¨ç¤º
      document.getElementById('negotiation-screen').classList.add('hidden');
      document.getElementById('roleA-main').classList.remove('hidden');

      // ãƒ­ãƒ¼ãƒ«Aã®ãƒ¡ã‚¤ãƒ³ç”»é¢ã§è©²å½“è€…ã‚’åå‰æ¤œç´¢
      const searchInput = document.getElementById('search-name-a');
      if (searchInput) {
        searchInput.value = currentNegoPerson.name;
        searchByName('A');
      }
    }

    function renderNegoTimeline() {
      const container = document.getElementById('nego-timeline');

      if (negoTimeline.length === 0) {
        container.innerHTML = '<p class="text-gray-400 py-4">ã¾ã äº¤æ¸‰è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      const typeIcons = {
        phone: { icon: 'ğŸ“', label: 'é›»è©±', color: 'blue' },
        email: { icon: 'ğŸ“§', label: 'ãƒ¡ãƒ¼ãƒ«', color: 'green' },
        other: { icon: 'ğŸ“‹', label: 'ãã®ä»–', color: 'gray' }
      };

      let html = '';
      negoTimeline.forEach(record => {
        const t = typeIcons[record.type] || typeIcons.other;
        html += `
          <div class="relative pl-2">
            <div class="absolute -left-8 top-1 w-4 h-4 bg-${t.color}-500 rounded-full"></div>
            <div class="flex items-center gap-2 mb-1">
              <span class="px-2 py-0.5 bg-${t.color}-100 text-${t.color}-700 rounded text-xs font-bold">${t.icon} ${t.label}</span>
              <span class="text-sm text-gray-500">${record.datetime}</span>
              <span class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs">è¨˜éŒ²: ${record.user || '-'}</span>
            </div>
            <p class="text-gray-800 text-sm">${record.content}</p>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function addNegotiationRecord() {
      const type = document.getElementById('nego-type').value;
      const datetime = document.getElementById('nego-datetime').value;
      const content = document.getElementById('nego-content').value.trim();

      if (!content) {
        showToast('å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }

      // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
      const dt = new Date(datetime);
      const formatted = dt.toLocaleString('ja-JP', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
      }).replace(/\//g, '/');

      // æ–°ã—ã„è¨˜éŒ²ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
      const newRecord = {
        type: type,
        datetime: formatted,
        content: content,
        user: loginUsername
      };

      // ãƒ­ãƒ¼ã‚«ãƒ«è¡¨ç¤ºç”¨ã«è¿½åŠ 
      negoTimeline.unshift(newRecord);

      // personDataã«ã‚‚ä¿å­˜ï¼ˆçµ±ä¸€ãƒ‡ãƒ¼ã‚¿ï¼‰
      if (currentNegoPerson && personData[currentNegoPerson.hn]) {
        if (!personData[currentNegoPerson.hn].negoHistory) {
          personData[currentNegoPerson.hn].negoHistory = [];
        }
        personData[currentNegoPerson.hn].negoHistory.unshift(newRecord);

        // æœ€çµ‚é€£çµ¡æ—¥ã‚‚æ›´æ–°
        personData[currentNegoPerson.hn].lastContact = formatted.split(' ')[0];
      }

      // å†æç”»
      renderNegoTimeline();

      // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
      document.getElementById('nego-content').value = '';
      const now = new Date();
      document.getElementById('nego-datetime').value = now.toISOString().slice(0, 16);

      showToast('äº¤æ¸‰è¨˜éŒ²ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
    }

    // åˆæœŸè¡¨ç¤º
    document.addEventListener('DOMContentLoaded', function() {
      if (document.getElementById('doc-table-body')) {
        filterByDocType(1);
      }
      // å’Œè§£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
      if (document.getElementById('settlement-status-cards')) {
        renderSettlementStatus();
      }
    });

    // å’Œè§£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€è¦§
    const settlementConfig = {
      'æœªç€æ‰‹': { color: 'gray', icon: 'â³' },
      'äº¤æ¸‰ä¸­': { color: 'blue', icon: 'ğŸ’¬' },
      'å’Œè§£æˆç«‹': { color: 'green', icon: 'ğŸ¤' },
      'è¨´è¨Ÿä¸­': { color: 'red', icon: 'âš–ï¸' },
      'çµ‚äº†': { color: 'purple', icon: 'âœ…' }
    };

    function renderSettlementStatus() {
      const container = document.getElementById('settlement-status-cards');
      if (!container) return;

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã«ã‚«ã‚¦ãƒ³ãƒˆ
      const counts = {};
      Object.keys(settlementConfig).forEach(s => counts[s] = 0);

      Object.values(personData).forEach(person => {
        const status = person.settlement || 'æœªç€æ‰‹';
        if (counts[status] !== undefined) {
          counts[status]++;
        }
      });

      let html = '';
      Object.keys(settlementConfig).forEach(status => {
        const config = settlementConfig[status];
        const count = counts[status];
        const bgColor = count > 0 ? `bg-${config.color}-50 border-${config.color}-200` : 'bg-gray-50 border-gray-200';
        const textColor = count > 0 ? `text-${config.color}-700` : 'text-gray-400';

        html += `
          <div onclick="showSettlementList('${status}')"
               class="border-2 ${bgColor} rounded-lg p-3 cursor-pointer hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
              <span class="text-lg">${config.icon}</span>
              <span class="text-2xl font-bold ${textColor}">${count}</span>
            </div>
            <p class="text-sm ${textColor} mt-1">${status}</p>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function showSettlementList(status) {
      const persons = Object.values(personData).filter(p => p.settlement === status);

      document.getElementById('settlement-list-title').textContent = status;
      document.getElementById('settlement-list-count').textContent = `ï¼ˆ${persons.length}ä»¶ï¼‰`;

      const body = document.getElementById('settlement-list-body');

      if (persons.length === 0) {
        body.innerHTML = '<p class="text-gray-400 py-4 text-center">è©²å½“ãªã—</p>';
      } else {
        let html = '';
        persons.forEach(person => {
          const lawyerBadge = person.hasLawyer
            ? '<span class="px-2 py-0.5 bg-red-100 text-red-600 text-xs rounded">å¼è­·å£«ã‚ã‚Š</span>'
            : '';
          const ipnCount = person.linkedIpns ? person.linkedIpns.length : 0;

          // æœ€çµ‚é€£çµ¡ã‹ã‚‰ã®çµŒéæ—¥æ•°
          let daysSince = '-';
          if (person.lastContact && person.lastContact !== '-') {
            const lastDate = new Date(person.lastContact);
            const today = new Date();
            const diff = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
            daysSince = diff + 'æ—¥å‰';
          }

          html += `
            <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <p class="font-bold text-gray-800">${person.name}</p>
                  ${lawyerBadge}
                </div>
                <p class="text-xs text-gray-500">${person.hn} | ${person.phone}</p>
                <p class="text-xs text-gray-400 mt-1">IPN: ${ipnCount}ä»¶ | æœ€çµ‚é€£çµ¡: ${daysSince}</p>
              </div>
              <div class="text-right">
                <p class="text-sm font-bold text-gray-700">Â¥${(person.amount || 0).toLocaleString()}</p>
                <p class="text-xs text-gray-500">${person.docStatus || '-'}</p>
              </div>
            </div>
          `;
        });
        body.innerHTML = html;
      }

      document.getElementById('settlement-list-section').classList.remove('hidden');
    }

    function closeSettlementList() {
      document.getElementById('settlement-list-section').classList.add('hidden');
    }

    // ãƒ­ãƒ¼ãƒ«é¸æŠã«æˆ»ã‚‹
    function backToRoleSelect() {
      document.querySelectorAll('[id$="-screen"]').forEach(el => el.classList.add('hidden'));
      document.getElementById('role-select-screen').classList.remove('hidden');
    }

    // æ¤œç´¢ã‹ã‚‰æˆ»ã‚‹
    function backToSearch() {
      document.getElementById('person-detail-screen').classList.add('hidden');
      document.getElementById('role-' + currentRole.toLowerCase() + '-screen').classList.remove('hidden');
    }

    // ========================================
    // IPNç´ä»˜ã‘æ©Ÿèƒ½
    // ========================================
    let selectedIpn = null;
    let selectedLinkPerson = null;

    function openIpnLinkScreen() {
      document.getElementById('roleA-main').classList.add('hidden');
      document.getElementById('ipn-link-screen').classList.remove('hidden');
      // åˆæœŸè¡¨ç¤º
      renderIpnTable(ipnData);
    }

    function closeIpnLinkScreen() {
      document.getElementById('ipn-link-screen').classList.add('hidden');
      document.getElementById('roleA-main').classList.remove('hidden');
    }

    function searchIpnData() {
      const ip = document.getElementById('ipn-search-ip').value.trim();
      const holder = document.getElementById('ipn-search-holder').value;
      const provider = document.getElementById('ipn-search-provider').value;

      let results = ipnData.filter(item => {
        if (ip && !item.ip.includes(ip)) return false;
        if (holder && item.holder !== holder) return false;
        if (provider && item.provider !== provider) return false;
        return true;
      });

      renderIpnTable(results);
    }

    function clearIpnSearch() {
      document.getElementById('ipn-search-ip').value = '';
      document.getElementById('ipn-search-holder').value = '';
      document.getElementById('ipn-search-provider').value = '';
      renderIpnTable(ipnData);
    }

    function renderIpnTable(data) {
      const tbody = document.getElementById('ipn-table-body');
      const noResults = document.getElementById('ipn-no-results');

      if (data.length === 0) {
        tbody.innerHTML = '';
        noResults.classList.remove('hidden');
        noResults.textContent = 'è©²å½“ã™ã‚‹IPNãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
        document.getElementById('ipn-result-count').textContent = '';
        return;
      }

      noResults.classList.add('hidden');
      document.getElementById('ipn-result-count').textContent = `ï¼ˆ${data.length}ä»¶ï¼‰`;

      // ç´ä»˜ã‘æ¸ˆã¿ãƒ»æœªç´ä»˜ã‘ã‚«ã‚¦ãƒ³ãƒˆ
      const linkedCount = data.filter(d => d.linked).length;
      document.getElementById('ipn-linked-count').textContent = linkedCount;
      document.getElementById('ipn-unlinked-count').textContent = data.length - linkedCount;

      // åŒä¸€IPã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const ipGroups = {};
      data.forEach(item => {
        if (!ipGroups[item.ip]) {
          ipGroups[item.ip] = [];
        }
        ipGroups[item.ip].push(item);
      });

      let html = '';

      // IPã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«è¡¨ç¤º
      Object.keys(ipGroups).forEach(ip => {
        const group = ipGroups[ip];
        const unlinkedInGroup = group.filter(i => !i.linked);
        const linkedInGroup = group.filter(i => i.linked);

        // åŒä¸€IPã§ç´ä»˜ã‘æ¸ˆã¿ãŒã‚ã‚Œã°ã€ãã®ç™ºä¿¡è€…ã‚’å€™è£œã¨ã—ã¦è¡¨ç¤º
        let linkedPersonInfo = '';
        if (linkedInGroup.length > 0) {
          const linkedHn = linkedInGroup[0].linkedTo;
          const linkedPerson = personData[linkedHn];
          if (linkedPerson) {
            linkedPersonInfo = `<span class="text-green-600 text-xs">ï¼ˆ${linkedPerson.name}ã«${linkedInGroup.length}ä»¶ç´ä»˜æ¸ˆï¼‰</span>`;
          }
        }

        // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆåŒä¸€IPã«è¤‡æ•°ã‚ã‚‹å ´åˆï¼‰
        if (group.length > 1) {
          const unlinkedCount = unlinkedInGroup.length;
          html += `
            <tr class="bg-blue-50 border-t-2 border-blue-300">
              <td colspan="7" class="px-4 py-2">
                <div class="flex items-center gap-3">
                  <span class="font-mono font-bold text-blue-700">${ip}</span>
                  <span class="text-sm text-gray-600">ï¼ˆ${group.length}ä»¶ï¼‰</span>
                  ${linkedPersonInfo}
                </div>
              </td>
              <td class="px-4 py-2 text-center">
                ${unlinkedCount > 1 ? `<button onclick="openBulkIpnLinkModal('${ip}')" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm">ã¾ã¨ã‚ã¦ç´ä»˜ã‘ï¼ˆ${unlinkedCount}ä»¶ï¼‰</button>` : ''}
              </td>
            </tr>
          `;
        }

        // å„IPNè¡Œ
        group.forEach(item => {
          const statusBadge = item.linked
            ? `<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">ç´ä»˜æ¸ˆ</span>`
            : `<span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded-full">æœªç´ä»˜</span>`;

          const linkedInfo = item.linked ? `<span class="text-xs text-gray-400 block">${item.linkedTo}</span>` : '';

          const actionBtn = item.linked
            ? `<button class="px-3 py-1 bg-gray-200 text-gray-500 rounded text-sm cursor-not-allowed" disabled>ç´ä»˜æ¸ˆ</button>`
            : `<button onclick="openIpnLinkModal('${item.id}')" class="px-3 py-1 bg-orange-500 hover:bg-orange-600 text-white rounded text-sm">ç´ä»˜ã‘</button>`;

          html += `
            <tr class="hover:bg-gray-50 ${item.linked ? 'bg-green-50/30' : ''}">
              <td class="px-4 py-3">${statusBadge}${linkedInfo}</td>
              <td class="px-4 py-3 font-mono text-sm">${item.ip}</td>
              <td class="px-4 py-3 font-mono text-sm">${item.port}</td>
              <td class="px-4 py-3 text-sm">${item.datetime}</td>
              <td class="px-4 py-3 text-sm">${item.provider}</td>
              <td class="px-4 py-3 text-sm">${item.holder}</td>
              <td class="px-4 py-3 text-sm font-medium">${item.title}</td>
              <td class="px-4 py-3 text-center">${actionBtn}</td>
            </tr>
          `;
        });
      });

      tbody.innerHTML = html;
    }

    // ã¾ã¨ã‚ã¦ç´ä»˜ã‘ãƒ¢ãƒ¼ãƒ€ãƒ«
    let bulkIpnIds = [];

    function openBulkIpnLinkModal(ip) {
      // åŒä¸€IPã®æœªç´ä»˜ã‘IPNã‚’å–å¾—
      bulkIpnIds = ipnData.filter(d => d.ip === ip && !d.linked).map(d => d.id);
      if (bulkIpnIds.length === 0) return;

      selectedLinkPerson = null;

      // åŒä¸€IPã§æ—¢ã«ç´ä»˜ã‘æ¸ˆã¿ã®ç™ºä¿¡è€…ãŒã„ã‚Œã°å€™è£œã¨ã—ã¦è¡¨ç¤º
      const linkedSameIp = ipnData.find(d => d.ip === ip && d.linked);
      let suggestedPerson = null;
      if (linkedSameIp && linkedSameIp.linkedTo) {
        suggestedPerson = personData[linkedSameIp.linkedTo];
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«æƒ…å ±æ›´æ–°
      const ipnList = bulkIpnIds.map(id => {
        const ipn = ipnData.find(d => d.id === id);
        return `${ipn.datetime} - ${ipn.title}`;
      }).join('<br>');

      document.getElementById('modal-ipn-info').innerHTML = `
        <span class="text-orange-600 font-bold">${ip}</span>ï¼ˆ${bulkIpnIds.length}ä»¶ï¼‰<br>
        <div class="text-sm text-gray-600 mt-2 max-h-24 overflow-y-auto">${ipnList}</div>
      `;

      // ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('ipn-link-search').value = '';
      document.getElementById('ipn-link-person-list').innerHTML = '';
      document.getElementById('ipn-selected-person').classList.add('hidden');
      document.getElementById('ipn-link-confirm-btn').disabled = true;

      // å€™è£œãŒã„ã‚Œã°è‡ªå‹•ã§è¡¨ç¤º
      if (suggestedPerson) {
        document.getElementById('ipn-link-person-list').innerHTML = `
          <div class="bg-green-50 border-2 border-green-300 rounded-lg p-3 mb-2">
            <p class="text-xs text-green-600 mb-1">ğŸ’¡ åŒä¸€IPã§ç´ä»˜ã‘æ¸ˆã¿ã®ç™ºä¿¡è€…</p>
            <div onclick="selectPersonForIpn('${suggestedPerson.hn}')"
                 class="flex items-center justify-between p-2 bg-white rounded cursor-pointer hover:bg-green-100">
              <div>
                <p class="font-bold text-gray-800">${suggestedPerson.name}</p>
                <p class="text-xs text-gray-500">${suggestedPerson.hn} | ${suggestedPerson.phone}</p>
              </div>
              <span class="text-green-600 text-sm">é¸æŠ â†’</span>
            </div>
          </div>
        `;
      }

      document.getElementById('ipn-link-modal').classList.remove('hidden');
    }

    function openIpnLinkModal(ipnId) {
      selectedIpn = ipnData.find(d => d.id === ipnId);
      selectedLinkPerson = null;
      bulkIpnIds = []; // å˜ä½“ãƒ¢ãƒ¼ãƒ‰

      if (!selectedIpn) return;

      // åŒä¸€IPã§æ—¢ã«ç´ä»˜ã‘æ¸ˆã¿ã®ç™ºä¿¡è€…ãŒã„ã‚Œã°å€™è£œã¨ã—ã¦è¡¨ç¤º
      const linkedSameIp = ipnData.find(d => d.ip === selectedIpn.ip && d.linked && d.id !== ipnId);
      let suggestedPerson = null;
      if (linkedSameIp && linkedSameIp.linkedTo) {
        suggestedPerson = personData[linkedSameIp.linkedTo];
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«æƒ…å ±æ›´æ–°
      document.getElementById('modal-ipn-info').innerHTML = `
        <span class="text-orange-600">${selectedIpn.ip}:${selectedIpn.port}</span><br>
        <span class="text-sm text-gray-600">${selectedIpn.datetime} | ${selectedIpn.provider} | ${selectedIpn.holder} | ${selectedIpn.title}</span>
      `;

      // ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('ipn-link-search').value = '';
      document.getElementById('ipn-selected-person').classList.add('hidden');
      document.getElementById('ipn-link-confirm-btn').disabled = true;

      // å€™è£œãŒã„ã‚Œã°è‡ªå‹•ã§è¡¨ç¤º
      if (suggestedPerson) {
        document.getElementById('ipn-link-person-list').innerHTML = `
          <div class="bg-green-50 border-2 border-green-300 rounded-lg p-3 mb-2">
            <p class="text-xs text-green-600 mb-1">ğŸ’¡ åŒä¸€IPã§ç´ä»˜ã‘æ¸ˆã¿ã®ç™ºä¿¡è€…</p>
            <div onclick="selectPersonForIpn('${suggestedPerson.hn}')"
                 class="flex items-center justify-between p-2 bg-white rounded cursor-pointer hover:bg-green-100">
              <div>
                <p class="font-bold text-gray-800">${suggestedPerson.name}</p>
                <p class="text-xs text-gray-500">${suggestedPerson.hn} | ${suggestedPerson.phone}</p>
              </div>
              <span class="text-green-600 text-sm">é¸æŠ â†’</span>
            </div>
          </div>
        `;
      } else {
        document.getElementById('ipn-link-person-list').innerHTML = '';
      }

      document.getElementById('ipn-link-modal').classList.remove('hidden');
    }

    function closeIpnLinkModal() {
      document.getElementById('ipn-link-modal').classList.add('hidden');
      selectedIpn = null;
      selectedLinkPerson = null;
    }

    function searchPersonForIpn() {
      const query = document.getElementById('ipn-link-search').value.trim();
      if (!query) return;

      const normalizedQuery = query.replace(/[-\s]/g, '').toLowerCase();
      const results = [];

      for (const key in personData) {
        const person = personData[key];
        const normalizedHn = person.hn.replace(/[-\s]/g, '').toLowerCase();
        const normalizedName = person.name.replace(/[-\s]/g, '').toLowerCase();
        const normalizedPhone = person.phone.replace(/[-\s]/g, '').toLowerCase();

        if (normalizedHn.includes(normalizedQuery) || normalizedQuery.includes(normalizedHn) ||
            normalizedName.includes(normalizedQuery) || normalizedQuery.includes(normalizedName) ||
            normalizedPhone.includes(normalizedQuery) || normalizedQuery.includes(normalizedPhone)) {
          results.push(person);
        }
      }

      const listEl = document.getElementById('ipn-link-person-list');
      if (results.length === 0) {
        listEl.innerHTML = '<p class="text-gray-400 text-sm py-2">è©²å½“ã™ã‚‹ç™ºä¿¡è€…ãŒã„ã¾ã›ã‚“</p>';
        return;
      }

      let html = '';
      results.forEach(person => {
        html += `
          <div onclick="selectPersonForIpn('${person.hn}')"
               class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-300 cursor-pointer">
            <div>
              <p class="font-bold text-gray-800">${person.name}</p>
              <p class="text-xs text-gray-500">${person.hn} | ${person.phone}</p>
            </div>
          </div>
        `;
      });
      listEl.innerHTML = html;
    }

    function selectPersonForIpn(hn) {
      selectedLinkPerson = personData[hn];
      if (!selectedLinkPerson) return;

      document.getElementById('ipn-selected-person').classList.remove('hidden');
      document.getElementById('ipn-selected-person-name').textContent = `${selectedLinkPerson.name} (${selectedLinkPerson.hn})`;
      document.getElementById('ipn-link-confirm-btn').disabled = false;
    }

    function confirmIpnLink() {
      if (!selectedLinkPerson) return;

      // ã¾ã¨ã‚ã¦ç´ä»˜ã‘ãƒ¢ãƒ¼ãƒ‰ã‹å˜ä½“ãƒ¢ãƒ¼ãƒ‰ã‹åˆ¤å®š
      const idsToLink = bulkIpnIds.length > 0 ? bulkIpnIds : (selectedIpn ? [selectedIpn.id] : []);

      if (idsToLink.length === 0) return;

      // ç™ºä¿¡è€…ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const person = personData[selectedLinkPerson.hn];
      if (!person) return;

      if (!person.linkedIpns) {
        person.linkedIpns = [];
      }

      // å„IPNã‚’ç´ä»˜ã‘
      idsToLink.forEach(ipnId => {
        const ipn = ipnData.find(d => d.id === ipnId);
        if (ipn) {
          ipn.linked = true;
          ipn.linkedTo = selectedLinkPerson.hn;
        }
        if (!person.linkedIpns.includes(ipnId)) {
          person.linkedIpns.push(ipnId);
        }
      });

      const countMsg = idsToLink.length > 1 ? `${idsToLink.length}ä»¶ã®` : '';
      showToast(`${countMsg}IPNã‚’ç´ä»˜ã‘ã¾ã—ãŸ\n\nç™ºä¿¡è€…: ${selectedLinkPerson.name} (${selectedLinkPerson.hn})`, 'success');

      // ãƒªã‚»ãƒƒãƒˆ
      bulkIpnIds = [];
      selectedIpn = null;

      closeIpnLinkModal();
      renderIpnTable(ipnData);
    }

    // ========================================
    // å—ä»»é€šçŸ¥ç™»éŒ²æ©Ÿèƒ½
    // ========================================
    let selectedJuninPerson = null;

    function openJuninModal() {
      // ãƒªã‚»ãƒƒãƒˆ
      selectedJuninPerson = null;
      document.getElementById('junin-search').value = '';
      document.getElementById('junin-person-list').innerHTML = '';
      document.getElementById('junin-selected-person').classList.add('hidden');
      document.getElementById('junin-new-name').value = '';
      document.getElementById('junin-new-phone').value = '';
      document.getElementById('junin-new-address').value = '';
      document.getElementById('junin-lawyer-code').value = '';
      document.getElementById('junin-lawyer-info').innerHTML = '<p class="text-gray-400 text-sm">2æ–‡å­—ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>';
      document.getElementById('junin-note').value = '';

      // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('junin-date').value = today;

      // æ—¢å­˜ç™ºä¿¡è€…ãƒ¢ãƒ¼ãƒ‰ã«
      document.querySelector('input[name="junin-person-type"][value="existing"]').checked = true;
      toggleJuninPersonType();

      document.getElementById('junin-modal').classList.remove('hidden');
    }

    // å¼è­·å£«ã‚³ãƒ¼ãƒ‰å…¥åŠ›æ™‚ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
    function onLawyerCodeInput() {
      const code = document.getElementById('junin-lawyer-code').value.trim().toUpperCase();
      const infoDiv = document.getElementById('junin-lawyer-info');

      if (code.length < 2) {
        infoDiv.innerHTML = '<p class="text-gray-400 text-sm">2æ–‡å­—ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>';
        return;
      }

      const lawyer = getLawyerByCode(code);
      if (lawyer) {
        infoDiv.innerHTML = `
          <div class="text-green-700">
            <p class="font-bold text-lg">${lawyer.name}</p>
            <p class="text-sm">${lawyer.office}</p>
            <p class="text-xs text-gray-500">TEL: ${lawyer.phone}</p>
          </div>
        `;
      } else {
        infoDiv.innerHTML = `
          <div class="text-red-600">
            <p class="font-bold">âš  è©²å½“ãªã—</p>
            <p class="text-sm">ã‚³ãƒ¼ãƒ‰ã€Œ${code}ã€ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
          </div>
        `;
      }
    }

    function closeJuninModal() {
      document.getElementById('junin-modal').classList.add('hidden');
    }

    function toggleJuninPersonType() {
      const isExisting = document.querySelector('input[name="junin-person-type"]:checked').value === 'existing';
      document.getElementById('junin-existing-section').classList.toggle('hidden', !isExisting);
      document.getElementById('junin-new-section').classList.toggle('hidden', isExisting);
    }

    function searchPersonForJunin() {
      const query = document.getElementById('junin-search').value.trim();
      if (!query) return;

      const normalizedQuery = query.replace(/[-\s]/g, '').toLowerCase();
      const results = [];

      for (const key in personData) {
        const person = personData[key];
        const normalizedHn = person.hn.replace(/[-\s]/g, '').toLowerCase();
        const normalizedName = person.name.replace(/[-\s]/g, '').toLowerCase();
        const normalizedPhone = person.phone.replace(/[-\s]/g, '').toLowerCase();

        if (normalizedHn.includes(normalizedQuery) || normalizedQuery.includes(normalizedHn) ||
            normalizedName.includes(normalizedQuery) || normalizedQuery.includes(normalizedName) ||
            normalizedPhone.includes(normalizedQuery) || normalizedQuery.includes(normalizedPhone)) {
          results.push(person);
        }
      }

      const listEl = document.getElementById('junin-person-list');
      if (results.length === 0) {
        listEl.innerHTML = '<p class="text-gray-400 text-sm py-2">è©²å½“ãªã—ã€‚ã€Œæ–°è¦ç™ºä¿¡è€…ã¨ã—ã¦ç™»éŒ²ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>';
        return;
      }

      let html = '';
      results.forEach(person => {
        const lawyerBadge = person.hasLawyer
          ? '<span class="px-2 py-0.5 bg-red-100 text-red-600 text-xs rounded">å¼è­·å£«ã‚ã‚Š</span>'
          : '';
        html += `
          <div onclick="selectPersonForJunin('${person.hn}')"
               class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-300 cursor-pointer">
            <div>
              <p class="font-bold text-gray-800">${person.name} ${lawyerBadge}</p>
              <p class="text-xs text-gray-500">${person.hn} | ${person.phone}</p>
            </div>
          </div>
        `;
      });
      listEl.innerHTML = html;
    }

    function selectPersonForJunin(hn) {
      selectedJuninPerson = personData[hn];
      if (!selectedJuninPerson) return;

      document.getElementById('junin-selected-person').classList.remove('hidden');
      document.getElementById('junin-selected-person-name').textContent = `${selectedJuninPerson.name} (${selectedJuninPerson.hn})`;
    }

    // äºŒé‡ç™»éŒ²é˜²æ­¢ï¼šé¡ä¼¼ç™ºä¿¡è€…ã‚’æ¤œç´¢
    function findSimilarPersons(name, phone, address) {
      const similar = [];
      const normalizedName = name.replace(/[\sã€€]/g, '').toLowerCase();
      const normalizedPhone = phone.replace(/[-\s]/g, '');

      // åå‰ã®å§“ã ã‘æŠ½å‡ºï¼ˆæœ€åˆã®æ–‡å­—åˆ—ï¼‰
      const lastName = name.split(/[\sã€€]/)[0];

      for (const key in personData) {
        const person = personData[key];
        let matchScore = 0;
        let matchReasons = [];

        // åå‰ã®é¡ä¼¼åº¦ãƒã‚§ãƒƒã‚¯
        const pName = person.name.replace(/[\sã€€]/g, '').toLowerCase();
        const pLastName = person.name.split(/[\sã€€]/)[0];

        // å®Œå…¨ä¸€è‡´
        if (normalizedName === pName) {
          matchScore += 100;
          matchReasons.push('åå‰å®Œå…¨ä¸€è‡´');
        }
        // å§“ãŒä¸€è‡´
        else if (lastName === pLastName) {
          matchScore += 30;
          matchReasons.push('å§“ä¸€è‡´');
        }
        // åå‰ã«å«ã¾ã‚Œã‚‹
        else if (normalizedName.includes(pName) || pName.includes(normalizedName)) {
          matchScore += 20;
          matchReasons.push('åå‰éƒ¨åˆ†ä¸€è‡´');
        }

        // é›»è©±ç•ªå·ãƒã‚§ãƒƒã‚¯
        if (phone && phone !== '-') {
          const pPhone = person.phone.replace(/[-\s]/g, '');
          if (normalizedPhone === pPhone) {
            matchScore += 100;
            matchReasons.push('é›»è©±ç•ªå·ä¸€è‡´');
          } else if (normalizedPhone.slice(-4) === pPhone.slice(-4) && normalizedPhone.length > 4) {
            matchScore += 30;
            matchReasons.push('é›»è©±ç•ªå·ä¸‹4æ¡ä¸€è‡´');
          }
        }

        // ä½æ‰€ãƒã‚§ãƒƒã‚¯
        if (address && address !== '-' && person.address && person.address !== '-') {
          // ç°¡æ˜“çš„ãªä½æ‰€æ¯”è¼ƒï¼ˆå¸‚åŒºç”ºæ‘ãƒ¬ãƒ™ãƒ«ï¼‰
          const addrPart = address.slice(0, 10);
          const pAddrPart = person.address.slice(0, 10);
          if (addrPart === pAddrPart) {
            matchScore += 20;
            matchReasons.push('ä½æ‰€é¡ä¼¼');
          }
        }

        // ã‚¹ã‚³ã‚¢ãŒ30ä»¥ä¸Šãªã‚‰é¡ä¼¼ã¨åˆ¤å®š
        if (matchScore >= 30) {
          similar.push({ ...person, matchScore, matchReasons });
        }
      }

      // ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆ
      similar.sort((a, b) => b.matchScore - a.matchScore);
      return similar.slice(0, 5); // ä¸Šä½5ä»¶
    }

    function confirmJuninRegistration() {
      const isExisting = document.querySelector('input[name="junin-person-type"]:checked').value === 'existing';
      const lawyerCode = document.getElementById('junin-lawyer-code').value.trim().toUpperCase();
      const juninDate = document.getElementById('junin-date').value;

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šå¼è­·å£«ã‚³ãƒ¼ãƒ‰
      if (!lawyerCode || lawyerCode.length !== 2) {
        showToast('å¼è­·å£«ã‚³ãƒ¼ãƒ‰ï¼ˆ2æ–‡å­—ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        document.getElementById('junin-lawyer-code').focus();
        return;
      }
      const lawyer = getLawyerByCode(lawyerCode);
      if (!lawyer) {
        showToast(`å¼è­·å£«ã‚³ãƒ¼ãƒ‰ã€Œ${lawyerCode}ã€ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\næ­£ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`, 'error');
        document.getElementById('junin-lawyer-code').focus();
        return;
      }
      if (!juninDate) {
        showToast('å—ä»»é€šçŸ¥æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        document.getElementById('junin-date').focus();
        return;
      }

      let targetPerson;

      if (isExisting) {
        if (!selectedJuninPerson) {
          showToast('ç™ºä¿¡è€…ã‚’æ¤œç´¢ã—ã¦é¸æŠã—ã¦ãã ã•ã„', 'warning');
          return;
        }
        targetPerson = selectedJuninPerson;
      } else {
        // æ–°è¦ç™ºä¿¡è€…
        const newName = document.getElementById('junin-new-name').value.trim();
        const newPhone = document.getElementById('junin-new-phone').value.trim() || '-';
        const newAddress = document.getElementById('junin-new-address').value.trim() || '-';

        if (!newName) {
          showToast('æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
          document.getElementById('junin-new-name').focus();
          return;
        }

        // äºŒé‡ç™»éŒ²é˜²æ­¢ï¼šé¡ä¼¼ãƒã‚§ãƒƒã‚¯
        const similarPersons = findSimilarPersons(newName, newPhone, newAddress);
        if (similarPersons.length > 0) {
          const personList = similarPersons.map(p => `ãƒ»${p.name}ï¼ˆ${p.hn}ï¼‰${p.phone}`).join('\n');
          const confirmMsg = `âš  é¡ä¼¼ã™ã‚‹ç™ºä¿¡è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼š\n\n${personList}\n\næœ¬å½“ã«æ–°è¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆåŒä¸€äººç‰©ãªã‚‰ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã—ã¦æ—¢å­˜ç™ºä¿¡è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼‰`;
          if (!confirm(confirmMsg)) {
            return;
          }
        }

        // æ–°ã—ã„HN-IDã‚’ç”Ÿæˆï¼ˆãƒ‡ãƒ¢ï¼‰
        const newHn = 'HN-' + String(Date.now()).slice(-6);
        targetPerson = {
          hn: newHn,
          name: newName,
          phone: newPhone,
          address: newAddress,
          hasLawyer: false,
          lawyerName: null,
          settlement: 'æœªç€æ‰‹',
          amount: 0,
          docStatus: 'æœªé€ä»˜',
          lastContact: '-',
          linkedIpns: [],
          negoHistory: [],
          docHistory: []
        };

        // personDataã«è¿½åŠ 
        personData[newHn] = targetPerson;
      }

      // å¼è­·å£«æƒ…å ±ã‚’è¨­å®šï¼ˆã‚³ãƒ¼ãƒ‰ã§ç®¡ç†ï¼‰
      const fullLawyerName = getLawyerDisplayName(lawyerCode);

      targetPerson.hasLawyer = true;
      targetPerson.lawyerCode = lawyerCode;  // ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜
      targetPerson.lawyerName = fullLawyerName;

      // å—ä»»é€šçŸ¥ã®å±¥æ­´ã‚’è¨˜éŒ²
      if (!targetPerson.negoHistory) {
        targetPerson.negoHistory = [];
      }
      targetPerson.negoHistory.unshift({
        type: 'other',
        datetime: juninDate + ' 00:00',
        content: `ã€å—ä»»é€šçŸ¥ã€‘${fullLawyerName}ã‚ˆã‚Šå—ä»»é€šçŸ¥å—é ˜ï¼ˆã‚³ãƒ¼ãƒ‰: ${lawyerCode}ï¼‰`,
        user: loginUsername || 'ã‚·ã‚¹ãƒ†ãƒ '
      });

      targetPerson.lastContact = juninDate;

      // ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      showToast(`å—ä»»é€šçŸ¥ã‚’ç™»éŒ²ã—ã¾ã—ãŸ\n\nç™ºä¿¡è€…: ${targetPerson.name} (${targetPerson.hn})\nå¼è­·å£«: ${fullLawyerName}\nå—ä»»æ—¥: ${juninDate}\n\nâš  æ›¸é¡ã¯å¼è­·å£«å®›ã«é€ä»˜ã—ã¦ãã ã•ã„`, 'success', 6000);

      closeJuninModal();

      // å’Œè§£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å†æç”»
      renderSettlementStatus();
    }

    // åå‰ã§æ¤œç´¢
    function searchByName(role) {
      const name = document.getElementById('search-name-' + role.toLowerCase()).value;
      if (name) {
        openPersonDetail('HN-000456', name);
      } else {
        showToast('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
      }
    }

    // å€‹äººè©³ç´°ç”»é¢ã‚’é–‹ã
    function openPersonDetail(hnId, name, mandateStatus) {
      document.querySelectorAll('[id$="-screen"]').forEach(el => el.classList.add('hidden'));
      document.getElementById('person-detail-screen').classList.remove('hidden');

      // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¸æ›´æ–°
      const roleBadge = document.getElementById('current-role-badge');
      roleBadge.textContent = 'ãƒ­ãƒ¼ãƒ«' + currentRole;

      // åå‰ãƒ»IDæ›´æ–°ï¼ˆå®Ÿéš›ã¯DBã‹ã‚‰å–å¾—ï¼‰
      if (name) {
        document.getElementById('detail-name').textContent = name;
      }
      document.getElementById('detail-hn-id').textContent = hnId;

      // â˜…â˜…â˜… å¼è­·å£«ä¾é ¼çŠ¶æ³ã®è¡¨ç¤ºæ›´æ–° â˜…â˜…â˜…
      updateMandateHero(mandateStatus || 'yes');
    }

    // å¼è­·å£«ä¾é ¼çŠ¶æ³ãƒ’ãƒ¼ãƒ­ãƒ¼æ›´æ–°
    function updateMandateHero(status) {
      const hero = document.getElementById('mandate-hero');
      const icon = document.getElementById('mandate-icon');
      const statusText = document.getElementById('mandate-status-text');
      const lawyerText = document.getElementById('mandate-lawyer-text');
      const docPermission = document.getElementById('mandate-doc-permission');

      // ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
      hero.classList.remove('mandate-hero-yes', 'mandate-hero-no', 'mandate-hero-pending');

      if (status === 'yes') {
        // ç›¸æ‰‹æ–¹ãŒå¼è­·å£«ã«ä¾é ¼æ¸ˆã¿ = èµ¤ï¼ˆæ³¨æ„ãƒ»å¼è­·å£«åç¾©ã§é€ä»˜ï¼‰
        hero.classList.add('mandate-hero-yes');
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>';
        statusText.textContent = 'âš  å¼è­·å£«ã‚ã‚Š';
        lawyerText.textContent = 'ç”°ä¸­æ³•å¾‹äº‹å‹™æ‰€ ç”°ä¸­å¼è­·å£«';
        lawyerText.classList.remove('hidden');
        docPermission.classList.add('hidden');
      } else if (status === 'no') {
        // ç›¸æ‰‹æ–¹ãŒå¼è­·å£«ãªã— = ç·‘ï¼ˆæœ¬äººå¯¾å¿œï¼‰
        hero.classList.add('mandate-hero-no');
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>';
        statusText.textContent = 'æœ¬äººå¯¾å¿œ';
        lawyerText.textContent = 'ç›¸æ‰‹æ–¹ã«å¼è­·å£«ãªã—';
        lawyerText.classList.remove('hidden');
        docPermission.classList.add('hidden');
      } else if (status === 'pending') {
        hero.classList.add('mandate-hero-pending');
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
        statusText.textContent = '? ç¢ºèªä¸­';
        lawyerText.textContent = 'å¼è­·å£«æœ‰ç„¡ã‚’ç¢ºèªä¸­';
        lawyerText.classList.remove('hidden');
        docPermission.classList.add('hidden');
      }
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(el => {
        el.classList.remove('tab-active');
        el.classList.add('tab-inactive');
      });
      document.getElementById('tab-' + tabId).classList.remove('hidden');
      document.querySelector(`[data-tab="${tabId}"]`).classList.remove('tab-inactive');
      document.querySelector(`[data-tab="${tabId}"]`).classList.add('tab-active');
    }

    // ã‚¿ã‚¹ã‚¯ä¸€è¦§è¡¨ç¤º
    function showTaskList(type) {
      showToast(type + 'ã®ä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒ¢ï¼‰', 'info');
    }

    // æ–°è¦ç™ºä¿¡è€…ç™»éŒ²
    let selectedIpnsForNewPerson = [];

    function openNewDisclosureModal() {
      // ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('new-person-name').value = '';
      document.getElementById('new-person-name-kana').value = '';
      document.getElementById('new-person-user-name').value = '';
      document.getElementById('new-person-user-kana').value = '';
      document.getElementById('new-person-postal').value = '';
      document.getElementById('new-person-address').value = '';
      document.getElementById('new-person-phone').value = '';
      document.getElementById('new-person-email').value = '';
      document.getElementById('new-person-memo').value = '';
      document.getElementById('similar-check-result').classList.add('hidden');

      document.getElementById('new-person-modal').classList.remove('hidden');
    }

    function closeNewPersonModal() {
      document.getElementById('new-person-modal').classList.add('hidden');
    }

    // ===================================================
    // CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
    // ===================================================
    let csvParsedData = [];

    function openCsvUploadModal() {
      // ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('csv-file-input').value = '';
      document.getElementById('csv-file-name').classList.add('hidden');
      document.getElementById('csv-preview-section').classList.add('hidden');
      document.getElementById('csv-duplicate-section').classList.add('hidden');
      document.getElementById('csv-import-btn').disabled = true;
      csvParsedData = [];

      document.getElementById('csv-upload-modal').classList.remove('hidden');
    }

    function closeCsvUploadModal() {
      document.getElementById('csv-upload-modal').classList.add('hidden');
    }

    // ===================================================
    // å¼è­·å£«å—ä»»é€šçŸ¥ç™»éŒ²
    // ===================================================
    let selectedPersonForLawyer = null;

    function openLawyerNoticeModal() {
      // ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('lawyer-notice-search').value = '';
      document.getElementById('lawyer-notice-search-result').classList.add('hidden');
      document.getElementById('lawyer-notice-selected').classList.add('hidden');
      document.getElementById('lawyer-notice-code').value = '';
      document.getElementById('lawyer-notice-name').value = '';
      document.getElementById('lawyer-notice-date').value = new Date().toISOString().slice(0, 10);
      document.getElementById('lawyer-notice-memo').value = '';
      selectedPersonForLawyer = null;

      document.getElementById('lawyer-notice-modal').classList.remove('hidden');
    }

    function closeLawyerNoticeModal() {
      document.getElementById('lawyer-notice-modal').classList.add('hidden');
    }

    function searchForLawyerNotice() {
      const query = document.getElementById('lawyer-notice-search').value.trim();
      if (!query) {
        showToast('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }

      // åå‰ã¾ãŸã¯HNã§æ¤œç´¢
      const results = Object.values(personData).filter(p =>
        p.name.includes(query) || p.hn.includes(query.toUpperCase())
      ).slice(0, 5);

      const resultDiv = document.getElementById('lawyer-notice-search-result');

      if (results.length === 0) {
        resultDiv.innerHTML = '<p class="text-sm text-gray-500 py-2">è©²å½“è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
        resultDiv.classList.remove('hidden');
        return;
      }

      let html = '<div class="space-y-1">';
      results.forEach(p => {
        const lawyerBadge = p.hasLawyer ? '<span class="text-xs px-1 py-0.5 bg-red-100 text-red-600 rounded ml-2">å¼è­·å£«ã‚ã‚Š</span>' : '';
        html += `
          <div class="p-2 bg-gray-50 hover:bg-blue-50 rounded cursor-pointer flex justify-between items-center" onclick="selectPersonForLawyer('${p.hn}')">
            <div>
              <span class="font-medium">${p.name}</span>${lawyerBadge}
              <span class="text-xs text-gray-500 ml-2">${p.hn}</span>
            </div>
            <span class="text-blue-500 text-sm">é¸æŠ</span>
          </div>
        `;
      });
      html += '</div>';
      resultDiv.innerHTML = html;
      resultDiv.classList.remove('hidden');
    }

    function selectPersonForLawyer(hn) {
      const person = personData[hn];
      if (!person) return;

      selectedPersonForLawyer = person;

      document.getElementById('lawyer-notice-search-result').classList.add('hidden');
      document.getElementById('lawyer-notice-selected').classList.remove('hidden');
      document.getElementById('lawyer-notice-selected-name').textContent = person.name;
      document.getElementById('lawyer-notice-selected-hn').textContent = person.hn + ' / ' + (person.address || '');
    }

    function lookupLawyerByCode() {
      const code = document.getElementById('lawyer-notice-code').value.trim();
      if (!code) return;

      const lawyer = lawyerMaster[code];
      if (lawyer) {
        document.getElementById('lawyer-notice-name').value = lawyer.name;
      } else {
        document.getElementById('lawyer-notice-name').value = '';
      }
    }

    function openLawyerMasterSelect() {
      // å¼è­·å£«ãƒã‚¹ã‚¿ãƒ¼ä¸€è¦§ã‹ã‚‰é¸æŠï¼ˆç°¡æ˜“ç‰ˆï¼‰
      let options = Object.entries(lawyerMaster).map(([code, l]) => `${code}: ${l.name}`).join('\n');
      const selected = prompt('å¼è­·å£«ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:\n\n' + options);
      if (selected) {
        const code = selected.split(':')[0].trim();
        document.getElementById('lawyer-notice-code').value = code;
        lookupLawyerByCode();
      }
    }

    function saveLawyerNotice() {
      if (!selectedPersonForLawyer) {
        showToast('ç™ºä¿¡è€…ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
        return;
      }

      const code = document.getElementById('lawyer-notice-code').value.trim();
      const name = document.getElementById('lawyer-notice-name').value.trim();
      const date = document.getElementById('lawyer-notice-date').value;
      const memo = document.getElementById('lawyer-notice-memo').value.trim();

      if (!code) {
        showToast('å¼è­·å£«ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }

      // ç™ºä¿¡è€…ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      selectedPersonForLawyer.hasLawyer = true;
      selectedPersonForLawyer.lawyerCode = code;
      selectedPersonForLawyer.lawyerName = name || lawyerMaster[code]?.name || '';
      selectedPersonForLawyer.lawyerDate = date;
      selectedPersonForLawyer.lawyerMemo = memo;

      showToast(`å—ä»»é€šçŸ¥ã‚’ç™»éŒ²ã—ã¾ã—ãŸ\n\nç™ºä¿¡è€…: ${selectedPersonForLawyer.name}\nå¼è­·å£«: ${selectedPersonForLawyer.lawyerName}`, 'success');
      closeLawyerNoticeModal();
      updateRecentRegistrations();
    }

    // å¼è­·å£«å—ä»»é€šçŸ¥ æ‰‹å‹•å…¥åŠ›
    function openLawyerNoticeManualModal() {
      // ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('lawyer-manual-name').value = '';
      document.getElementById('lawyer-manual-name-kana').value = '';
      document.getElementById('lawyer-manual-user-name').value = '';
      document.getElementById('lawyer-manual-user-kana').value = '';
      document.getElementById('lawyer-manual-postal').value = '';
      document.getElementById('lawyer-manual-address').value = '';
      document.getElementById('lawyer-manual-phone').value = '';
      document.getElementById('lawyer-manual-email').value = '';
      document.getElementById('lawyer-manual-code').value = '';
      document.getElementById('lawyer-manual-lawyer-name').value = '';
      document.getElementById('lawyer-manual-date').value = new Date().toISOString().slice(0, 10);
      document.getElementById('lawyer-manual-memo').value = '';

      document.getElementById('lawyer-notice-manual-modal').classList.remove('hidden');
    }

    function closeLawyerNoticeManualModal() {
      document.getElementById('lawyer-notice-manual-modal').classList.add('hidden');
    }

    function lookupLawyerByCodeManual() {
      const code = document.getElementById('lawyer-manual-code').value.trim();
      if (!code) return;

      const lawyer = lawyerMaster[code];
      if (lawyer) {
        document.getElementById('lawyer-manual-lawyer-name').value = lawyer.name;
      } else {
        document.getElementById('lawyer-manual-lawyer-name').value = '';
      }
    }

    function openLawyerMasterSelectManual() {
      let options = Object.entries(lawyerMaster).map(([code, l]) => `${code}: ${l.name}`).join('\n');
      const selected = prompt('å¼è­·å£«ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:\n\n' + options);
      if (selected) {
        const code = selected.split(':')[0].trim();
        document.getElementById('lawyer-manual-code').value = code;
        lookupLawyerByCodeManual();
      }
    }

    function saveLawyerNoticeManual() {
      const name = document.getElementById('lawyer-manual-name').value.trim();
      const address = document.getElementById('lawyer-manual-address').value.trim();
      const lawyerCode = document.getElementById('lawyer-manual-code').value.trim();

      if (!name) {
        showToast('å¥‘ç´„è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }
      if (!address) {
        showToast('ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }
      if (!lawyerCode) {
        showToast('å¼è­·å£«ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }

      // æ–°ã—ã„HNç•ªå·ã‚’ç”Ÿæˆ
      const newHn = `HN-${String(Math.floor(Math.random() * 900000) + 100000)}`;

      // ç™ºä¿¡è€…ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
      personData[newHn] = {
        hn: newHn,
        name: name,
        nameKana: document.getElementById('lawyer-manual-name-kana').value.trim(),
        userName: document.getElementById('lawyer-manual-user-name').value.trim(),
        userKana: document.getElementById('lawyer-manual-user-kana').value.trim(),
        postal: document.getElementById('lawyer-manual-postal').value.trim(),
        address: address,
        phone: document.getElementById('lawyer-manual-phone').value.trim(),
        email: document.getElementById('lawyer-manual-email').value.trim(),
        memo: document.getElementById('lawyer-manual-memo').value.trim(),
        status: 'äº¤æ¸‰ä¸­',
        hasLawyer: true,
        lawyerCode: lawyerCode,
        lawyerName: document.getElementById('lawyer-manual-lawyer-name').value.trim() || lawyerMaster[lawyerCode]?.name || '',
        lawyerDate: document.getElementById('lawyer-manual-date').value,
        registeredAt: new Date().toISOString().slice(0, 10).replace(/-/g, '/')
      };

      const lawyerName = personData[newHn].lawyerName;
      showToast(`ç™»éŒ²ã—ã¾ã—ãŸ\n\nç™ºä¿¡è€…: ${name}\nå¼è­·å£«: ${lawyerName}\nHN: ${newHn}`, 'success');
      closeLawyerNoticeManualModal();
      updateRecentRegistrations();
    }

    function handleCsvFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      document.getElementById('csv-file-name').textContent = `ğŸ“„ ${file.name}`;
      document.getElementById('csv-file-name').classList.remove('hidden');

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        parseCsvForHdb(text);
      };
      reader.readAsText(file, 'Shift_JIS');
    }

    function parseCsvForHdb(csvText) {
      const lines = csvText.split(/\r?\n/).filter(line => line.trim());
      if (lines.length < 2) {
        showToast('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      // ãƒ˜ãƒƒãƒ€ãƒ¼è§£æ
      const headerLine = lines[0];
      const headers = headerLine.split(',').map(h => h.trim().replace(/"/g, ''));

      // ã‚«ãƒ©ãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ¤œç´¢
      const findCol = (names) => {
        for (const name of names) {
          const idx = headers.findIndex(h => h.includes(name));
          if (idx !== -1) return idx;
        }
        return -1;
      };

      const nameIdx = findCol(['å¥‘ç´„è€…å', 'æ°å', 'åå‰', 'name']);
      const nameKanaIdx = findCol(['ãµã‚ŠãŒãª', 'ã‹ãª', 'kana']);
      const userNameIdx = findCol(['åˆ©ç”¨è€…å', 'åˆ©ç”¨è€…']);
      const userKanaIdx = findCol(['åˆ©ç”¨è€…ãµã‚ŠãŒãª', 'åˆ©ç”¨è€…ã‹ãª']);
      const postalIdx = findCol(['éƒµä¾¿ç•ªå·', 'ã€’', 'postal']);
      const addressIdx = findCol(['ä½æ‰€', 'address']);
      const phoneIdx = findCol(['é›»è©±', 'tel', 'phone']);
      const emailIdx = findCol(['ãƒ¡ãƒ¼ãƒ«', 'mail', 'email']);
      const memoIdx = findCol(['ãƒ¡ãƒ¢', 'å‚™è€ƒ', 'memo', 'note']);

      if (nameIdx === -1 || addressIdx === -1) {
        showToast('å¿…é ˆã‚«ãƒ©ãƒ ï¼ˆå¥‘ç´„è€…åã€ä½æ‰€ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        return;
      }

      csvParsedData = [];
      const duplicates = [];

      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
        if (cols.length < 2) continue;

        const name = cols[nameIdx] || '';
        const nameKana = nameKanaIdx !== -1 ? cols[nameKanaIdx] || '' : '';
        const userName = userNameIdx !== -1 ? cols[userNameIdx] || '' : '';
        const userKana = userKanaIdx !== -1 ? cols[userKanaIdx] || '' : '';
        const postal = postalIdx !== -1 ? cols[postalIdx] || '' : '';
        const address = cols[addressIdx] || '';
        const phone = phoneIdx !== -1 ? cols[phoneIdx] || '' : '';
        const email = emailIdx !== -1 ? cols[emailIdx] || '' : '';
        const memo = memoIdx !== -1 ? cols[memoIdx] || '' : '';

        if (!name || !address) continue;

        // é‡è¤‡ãƒã‚§ãƒƒã‚¯
        const similar = findSimilarPersons(name, phone, address);
        if (similar.length > 0) {
          duplicates.push({ name, similar: similar[0].name });
        }

        csvParsedData.push({
          name,
          nameKana,
          userName,
          userKana,
          postal,
          address,
          phone,
          email,
          memo
        });
      }

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
      if (csvParsedData.length > 0) {
        const previewTbody = document.getElementById('csv-preview-tbody');
        let html = '';
        csvParsedData.slice(0, 10).forEach(row => {
          html += `
            <tr class="hover:bg-gray-50">
              <td class="px-3 py-2">${row.name}</td>
              <td class="px-3 py-2 text-xs text-gray-600">${row.address.substring(0, 20)}...</td>
              <td class="px-3 py-2 text-xs">${row.phone || '-'}</td>
              <td class="px-3 py-2 text-xs">${row.userName || '-'}</td>
            </tr>
          `;
        });
        previewTbody.innerHTML = html;
        document.getElementById('csv-preview-count').textContent = `${csvParsedData.length}ä»¶`;
        document.getElementById('csv-preview-section').classList.remove('hidden');
        document.getElementById('csv-import-btn').disabled = false;
      }

      // é‡è¤‡è­¦å‘Š
      if (duplicates.length > 0) {
        const dupList = document.getElementById('csv-duplicate-list');
        dupList.innerHTML = duplicates.slice(0, 5).map(d =>
          `<p>ãƒ»${d.name} â†’ æ—¢å­˜: ${d.similar}</p>`
        ).join('');
        if (duplicates.length > 5) {
          dupList.innerHTML += `<p class="mt-1">ä»– ${duplicates.length - 5} ä»¶...</p>`;
        }
        document.getElementById('csv-duplicate-section').classList.remove('hidden');
      }
    }

    function executeCsvImport() {
      if (csvParsedData.length === 0) {
        showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
        return;
      }

      if (!confirm(`${csvParsedData.length}ä»¶ã®é–‹ç¤ºçµæœã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }

      let successCount = 0;
      csvParsedData.forEach(row => {
        // æ–°ã—ã„HNç•ªå·ã‚’ç”Ÿæˆ
        const newHn = `HN-${String(Math.floor(Math.random() * 900000) + 100000)}`;

        personData[newHn] = {
          hn: newHn,
          name: row.name,
          nameKana: row.nameKana,
          userName: row.userName,
          userKana: row.userKana,
          postal: row.postal,
          address: row.address,
          phone: row.phone,
          email: row.email,
          memo: row.memo,
          status: 'æœªç€æ‰‹',
          hasLawyer: false,
          lawyerCode: null,
          lawyerName: null,
          registeredAt: new Date().toISOString().slice(0, 10).replace(/-/g, '/')
        };
        successCount++;
      });

      showToast(`${successCount}ä»¶ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`, 'success');
      closeCsvUploadModal();

      // æœ€è¿‘ã®ç™»éŒ²ã‚’æ›´æ–°ï¼ˆç°¡æ˜“ç‰ˆï¼‰
      updateRecentRegistrations();
    }

    function updateRecentRegistrations() {
      const container = document.getElementById('recent-registrations');
      if (!container) return;

      // personDataã‹ã‚‰æœ€æ–°3ä»¶ã‚’å–å¾—
      const persons = Object.values(personData)
        .sort((a, b) => (b.registeredAt || '').localeCompare(a.registeredAt || ''))
        .slice(0, 3);

      let html = '';
      persons.forEach(p => {
        html += `
          <div class="p-3 bg-gray-50 rounded-lg flex justify-between items-center">
            <div>
              <p class="font-medium">${p.name}</p>
              <p class="text-xs text-gray-500">${p.hn} / ${p.registeredAt || '-'}ç™»éŒ²</p>
            </div>
            <span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded">ç™»éŒ²æ¸ˆ</span>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    function checkSimilarPersons() {
      const name = document.getElementById('new-person-name').value.trim();
      const phone = document.getElementById('new-person-phone').value.trim();
      const address = document.getElementById('new-person-address').value.trim();

      if (!name) {
        showToast('æ°åã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰é¡ä¼¼ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„', 'warning');
        return;
      }

      const similar = findSimilarPersons(name, phone, address);
      const resultDiv = document.getElementById('similar-check-result');
      const listDiv = document.getElementById('similar-person-list');

      if (similar.length === 0) {
        resultDiv.classList.add('hidden');
        showToast('é¡ä¼¼ã™ã‚‹ç™ºä¿¡è€…ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\næ–°è¦ç™»éŒ²ã‚’ç¶šã‘ã¦ãã ã•ã„ã€‚', 'success');
        return;
      }

      let html = '';
      similar.forEach(person => {
        const reasons = person.matchReasons ? person.matchReasons.join(', ') : '';
        const lawyerBadge = person.hasLawyer
          ? '<span class="px-2 py-0.5 bg-red-100 text-red-600 text-xs rounded ml-2">å¼è­·å£«ã‚ã‚Š</span>'
          : '';
        html += `
          <div class="flex items-center justify-between p-3 bg-white border border-yellow-200 rounded-lg">
            <div>
              <p class="font-bold text-gray-800">${person.name}${lawyerBadge}</p>
              <p class="text-xs text-gray-500">${person.hn} | ${person.phone}</p>
              <p class="text-xs text-yellow-600 mt-1">ä¸€è‡´: ${reasons}</p>
            </div>
            <button onclick="useExistingPerson('${person.hn}')" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm">
              ã“ã®äººã‚’ä½¿ã†
            </button>
          </div>
        `;
      });
      listDiv.innerHTML = html;
      resultDiv.classList.remove('hidden');
    }

    function useExistingPerson(hn) {
      const person = personData[hn];
      if (!person) return;

      if (confirm(`${person.name}ï¼ˆ${person.hn}ï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ\n\næ–°è¦ç™»éŒ²ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã€ã“ã®ç™ºä¿¡è€…ã«IPNã‚’ç´ä»˜ã‘ã¾ã™ã€‚`)) {
        closeNewPersonModal();
        // IPNç´ä»˜ã‘ç”»é¢ã‚’é–‹ã
        showToast(`${person.name}ã‚’é¸æŠã—ã¾ã—ãŸã€‚\nIPNç´ä»˜ã‘ç”»é¢ã‹ã‚‰ç´ä»˜ã‘ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚`, 'info');
      }
    }

    function searchIpnForNewPerson() {
      const ip = document.getElementById('new-person-ipn-search').value.trim();
      if (!ip) return;

      const results = ipnData.filter(d => !d.linked && d.ip.includes(ip));
      const listDiv = document.getElementById('new-person-ipn-list');

      if (results.length === 0) {
        listDiv.innerHTML = '<p class="text-gray-400 text-sm py-2">è©²å½“ã™ã‚‹æœªç´ä»˜ã‘IPNãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      let html = '';
      results.forEach(ipn => {
        const isSelected = selectedIpnsForNewPerson.includes(ipn.id);
        const btnClass = isSelected
          ? 'bg-green-500 text-white'
          : 'bg-gray-200 hover:bg-orange-500 hover:text-white';
        const btnText = isSelected ? 'âœ“ é¸æŠä¸­' : 'é¸æŠ';

        html += `
          <div class="flex items-center justify-between p-2 border border-gray-200 rounded text-sm">
            <div>
              <span class="font-mono">${ipn.ip}:${ipn.port}</span>
              <span class="text-gray-500 ml-2">${ipn.title}</span>
            </div>
            <button onclick="toggleIpnSelection('${ipn.id}')" class="px-2 py-1 rounded text-xs ${btnClass}">
              ${btnText}
            </button>
          </div>
        `;
      });
      listDiv.innerHTML = html;
    }

    function toggleIpnSelection(ipnId) {
      const idx = selectedIpnsForNewPerson.indexOf(ipnId);
      if (idx >= 0) {
        selectedIpnsForNewPerson.splice(idx, 1);
      } else {
        selectedIpnsForNewPerson.push(ipnId);
      }
      // å†æç”»
      searchIpnForNewPerson();
      updateSelectedIpnTags();
    }

    function updateSelectedIpnTags() {
      const container = document.getElementById('new-person-selected-ipns');
      const tagsDiv = document.getElementById('selected-ipn-tags');

      if (selectedIpnsForNewPerson.length === 0) {
        container.classList.add('hidden');
        return;
      }

      container.classList.remove('hidden');
      let html = '';
      selectedIpnsForNewPerson.forEach(ipnId => {
        const ipn = ipnData.find(d => d.id === ipnId);
        if (ipn) {
          html += `<span class="px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs">${ipn.ip} - ${ipn.title}</span>`;
        }
      });
      tagsDiv.innerHTML = html;
    }

    function confirmNewPersonRegistration() {
      const name = document.getElementById('new-person-name').value.trim();
      const phone = document.getElementById('new-person-phone').value.trim() || '-';
      const address = document.getElementById('new-person-address').value.trim();

      if (!name) {
        showToast('æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        document.getElementById('new-person-name').focus();
        return;
      }
      if (!address) {
        showToast('ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        document.getElementById('new-person-address').focus();
        return;
      }

      // é¡ä¼¼ãƒã‚§ãƒƒã‚¯ï¼ˆæœªå®Ÿè¡Œã®å ´åˆã‚‚å®Ÿè¡Œï¼‰
      const similar = findSimilarPersons(name, phone, address);
      if (similar.length > 0) {
        const personList = similar.map(p => `ãƒ»${p.name}ï¼ˆ${p.hn}ï¼‰`).join('\n');
        if (!confirm(`âš  é¡ä¼¼ã™ã‚‹ç™ºä¿¡è€…ãŒã„ã¾ã™ï¼š\n\n${personList}\n\næœ¬å½“ã«æ–°è¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) {
          return;
        }
      }

      // æ–°è¦ç™»éŒ²
      const newHn = 'HN-' + String(Date.now()).slice(-6);
      const newPerson = {
        hn: newHn,
        name: name,
        phone: phone,
        address: address,
        hasLawyer: false,
        lawyerName: null,
        settlement: 'æœªç€æ‰‹',
        amount: 0,
        docStatus: 'æœªé€ä»˜',
        lastContact: '-',
        linkedIpns: [],
        negoHistory: [],
        docHistory: []
      };

      // IPNã‚’ç´ä»˜ã‘
      selectedIpnsForNewPerson.forEach(ipnId => {
        const ipn = ipnData.find(d => d.id === ipnId);
        if (ipn) {
          ipn.linked = true;
          ipn.linkedTo = newHn;
          newPerson.linkedIpns.push(ipnId);
        }
      });

      personData[newHn] = newPerson;

      const ipnMsg = selectedIpnsForNewPerson.length > 0
        ? `\nIPNç´ä»˜ã‘: ${selectedIpnsForNewPerson.length}ä»¶`
        : '';

      showToast(`ç™ºä¿¡è€…ã‚’ç™»éŒ²ã—ã¾ã—ãŸ\n\nID: ${newHn}\næ°å: ${name}\nä½æ‰€: ${address}${ipnMsg}`, 'success');

      closeNewPersonModal();
    }

    // ========================================
    // å’Œè§£ç®¡ç†æ©Ÿèƒ½
    // ========================================

    let settlementPdfFile = null;

    // å’Œè§£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠ
    function selectSettlementStatus(status) {
      document.querySelectorAll('[id^="status-"]').forEach(radio => {
        radio.checked = false;
        radio.closest('div[class*="flex items-center"]').classList.remove('bg-yellow-50', 'bg-green-50', 'bg-gray-100');
        radio.closest('div[class*="flex items-center"]').classList.remove('border-yellow-300', 'border-green-300', 'border-gray-400');
        radio.closest('div[class*="flex items-center"]').classList.add('bg-gray-50', 'border-gray-200');
      });

      const radio = document.getElementById('status-' + status);
      radio.checked = true;
      const container = radio.closest('div[class*="flex items-center"]');
      container.classList.remove('bg-gray-50', 'border-gray-200');

      if (status === 'negotiating') {
        container.classList.add('bg-yellow-50', 'border-yellow-300');
      } else if (status === 'settled') {
        container.classList.add('bg-green-50', 'border-green-300');
      } else if (status === 'ended') {
        container.classList.add('bg-gray-100', 'border-gray-400');
      }

      // å’Œè§£æˆç«‹ä»¥å¤–ã§ã¯è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è–„ãã™ã‚‹
      const detailsSection = document.getElementById('settlement-details-section');
      if (status === 'settled') {
        detailsSection.classList.remove('opacity-50', 'pointer-events-none');
      } else {
        detailsSection.classList.add('opacity-50', 'pointer-events-none');
      }
    }

    // å’Œè§£æ›¸PDFã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    function handleSettlementPdfUpload(event) {
      const file = event.target.files[0];
      if (file) {
        if (file.type !== 'application/pdf') {
          showToast('PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
          return;
        }
        settlementPdfFile = file;
        document.getElementById('settlement-pdf-placeholder').classList.add('hidden');
        document.getElementById('settlement-pdf-info').classList.remove('hidden');
        document.getElementById('settlement-pdf-filename').textContent = file.name;

        // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
        const dropzone = document.getElementById('settlement-pdf-dropzone');
        dropzone.classList.remove('border-gray-300');
        dropzone.classList.add('border-green-400', 'bg-green-50');
      }
    }

    // å’Œè§£æ›¸PDFå‰Šé™¤
    function removeSettlementPdf() {
      settlementPdfFile = null;
      document.getElementById('settlement-pdf-input').value = '';
      document.getElementById('settlement-pdf-placeholder').classList.remove('hidden');
      document.getElementById('settlement-pdf-info').classList.add('hidden');
      document.getElementById('settlement-pdf-filename').textContent = '';

      // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«å¾©å…ƒ
      const dropzone = document.getElementById('settlement-pdf-dropzone');
      dropzone.classList.add('border-gray-300');
      dropzone.classList.remove('border-green-400', 'bg-green-50');
    }

    // å’Œè§£æƒ…å ±ä¿å­˜
    function saveSettlementDetails() {
      const status = document.querySelector('input[name="settlement"]:checked');
      if (!status) {
        showToast('å’Œè§£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
        return;
      }

      const statusId = status.id;
      const isSettled = statusId === 'status-settled';

      // å’Œè§£æˆç«‹ã®å ´åˆã¯å¿…é ˆãƒã‚§ãƒƒã‚¯
      if (isSettled) {
        const settlementDate = document.getElementById('settlement-date').value;
        const totalAmount = document.getElementById('settlement-total-amount').value;
        const monthlyAmount = document.getElementById('settlement-monthly-amount').value;
        const installmentCount = document.getElementById('settlement-installment-count').value;
        const firstPaymentDate = document.getElementById('settlement-first-payment-date').value;
        const warranty = document.querySelector('input[name="representation-warranty"]:checked');

        if (!settlementDate) {
          showToast('å’Œè§£æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
          document.getElementById('settlement-date').focus();
          return;
        }
        if (!totalAmount) {
          showToast('å’Œè§£é‡‘é¡ç·é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
          document.getElementById('settlement-total-amount').focus();
          return;
        }
        if (!firstPaymentDate) {
          showToast('åˆå›æ”¯æ‰•æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
          document.getElementById('settlement-first-payment-date').focus();
          return;
        }
        if (!settlementPdfFile) {
          showToast('å’Œè§£æ›¸PDFã‚’æ·»ä»˜ã—ã¦ãã ã•ã„', 'warning');
          return;
        }

        // ä¿å­˜å‡¦ç†ï¼ˆãƒ‡ãƒ¢ï¼‰
        const statusText = 'å’Œè§£æˆç«‹';
        const warrantyText = warranty ? (warranty.value === 'yes' ? 'ã‚ã‚Š' : 'ãªã—') : 'æœªè¨­å®š';

        const confirmMsg = `ä»¥ä¸‹ã®å†…å®¹ã§å’Œè§£æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã™ï¼š

ã€å’Œè§£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€‘${statusText}
ã€å’Œè§£æ—¥ã€‘${settlementDate}
ã€å’Œè§£é‡‘é¡ç·é¡ã€‘${Number(totalAmount).toLocaleString()}å††
ã€æœˆæ¬¡ã®æ”¯æ‰•é¡ã€‘${monthlyAmount ? Number(monthlyAmount).toLocaleString() + 'å††' : 'ä¸€æ‹¬æ‰•ã„'}
ã€å›æ•°ã€‘${installmentCount || 1}å›
ã€åˆå›æ”¯æ‰•æ—¥ã€‘${firstPaymentDate}
ã€è¡¨æ˜ä¿è¨¼ã€‘${warrantyText}
ã€å’Œè§£æ›¸PDFã€‘${settlementPdfFile.name}

ä¿å­˜ã—ã¦WDBã«é€£æºã—ã¾ã™ã‹ï¼Ÿ`;

        if (confirm(confirmMsg)) {
          showToast('å’Œè§£æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ\n\nWDBã«é€£æºã•ã‚Œã¾ã—ãŸã€‚å…¥é‡‘ç®¡ç†ç”»é¢ã§ç¢ºèªã§ãã¾ã™ã€‚', 'success');
        }
      } else {
        // äº¤æ¸‰ä¸­ã¾ãŸã¯çµ‚äº†ã®å ´åˆ
        const statusLabels = {
          'status-negotiating': 'äº¤æ¸‰ä¸­',
          'status-ended': 'çµ‚äº†'
        };
        const statusLabel = statusLabels[statusId] || 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°';

        if (confirm(`å’Œè§£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${statusLabel}ã€ã«æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ`)) {
          showToast(`å’Œè§£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${statusLabel}ã€ã«æ›´æ–°ã—ã¾ã—ãŸ`, 'success');
        }
      }
    }

    // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œ
    document.addEventListener('DOMContentLoaded', function() {
      const dropzone = document.getElementById('settlement-pdf-dropzone');
      if (dropzone) {
        dropzone.addEventListener('dragover', function(e) {
          e.preventDefault();
          dropzone.classList.add('border-green-400', 'bg-green-50');
        });

        dropzone.addEventListener('dragleave', function(e) {
          e.preventDefault();
          if (!settlementPdfFile) {
            dropzone.classList.remove('border-green-400', 'bg-green-50');
          }
        });

        dropzone.addEventListener('drop', function(e) {
          e.preventDefault();
          const file = e.dataTransfer.files[0];
          if (file) {
            if (file.type !== 'application/pdf') {
              showToast('PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
              dropzone.classList.remove('border-green-400', 'bg-green-50');
              return;
            }
            settlementPdfFile = file;
            document.getElementById('settlement-pdf-placeholder').classList.add('hidden');
            document.getElementById('settlement-pdf-info').classList.remove('hidden');
            document.getElementById('settlement-pdf-filename').textContent = file.name;
          }
        });
      }
    });
  </script>

</body>
</html>
