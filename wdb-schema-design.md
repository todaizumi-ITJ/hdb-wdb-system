# WDB（和解・入金データベース）スキーマ設計書

## 1. 設計思想

### 1.1 WDBとは
WDB（和解・入金DB）は、**「合意が成立した"あと"の世界を管理するDB」**です。

HDBが「人・事件・交渉」を扱うのに対し、WDBは「金額・期日・入金・未払い・遅延」だけを扱います。

> 感情・評価・交渉は一切入れないDB

### 1.2 HDBとの関係

```
HDB（発信者・交渉）
  └─ 0..n 件の WDB（和解・入金）
```

- 合意がなければWDBは存在しない
- WDBは必ず合意PDFを根拠に持つ

### 1.3 基本原則

| 原則 | 内容 |
|------|------|
| 金の事実のみ | 評価・交渉履歴は持たない |
| 追記専用 | 入金ログは修正不可 |
| 合意バージョン管理 | 条件変更は上書きせず新バージョン作成 |
| 権利者単位集計 | 最終的に「誰にいくら払うか」に収束 |
| **入金と承認の分離** | 不正防止のため、登録者と承認者を分ける |

---

## 2. 利用者ロール

### 2.1 ロール定義

| ロール | 主体 | できること |
|--------|------|-----------|
| **A** | **入金登録担当** | 入金事実の登録・CSVインポート |
| **A2** | **入金承認担当** | 登録内容の確認・承認・差戻し |
| B | 管理者 | 修正・合意変更・全体管理 |
| C | 弁護士 | 弁護士別集計・状況確認 |
| D | 経理／支払担当 | 権利者別集計・本人対応 |

> **重要**: UIは完全に分ける。同じ画面を権限で隠すのは事故の元

### 2.2 不正防止のための分離原則

```
入金登録（ロールA） → 承認待ち → 入金承認（ロールA2） → 入金確定
```

**制約**:
- 登録者と承認者は同一人物であってはならない
- システムが自動的に同一人物チェックを行う

---

## 3. テーブル構成

### 3.1 ER図（概念）

```
┌─────────────────────────────────────────────────────────────┐
│                    WDB テーブル構成                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌───────────────┐                                         │
│  │ w_settlement  │ ← 和解マスタ（親）                       │
│  │   (和解)      │                                         │
│  └───────┬───────┘                                         │
│          │                                                  │
│          │ 1:n（バージョン管理）                            │
│          ▼                                                  │
│  ┌───────────────────┐                                     │
│  │w_agreement_version│ ← 合意バージョン（履歴）            │
│  │   (合意履歴)      │                                     │
│  └───────┬───────────┘                                     │
│          │                                                  │
│          │ 1:n                                              │
│          ▼                                                  │
│  ┌───────────────────┐      ┌─────────────────┐           │
│  │w_payment_schedule │ ───▶ │ w_payment_log   │           │
│  │   (支払予定)      │      │   (入金実績)    │           │
│  └───────────────────┘      └─────────────────┘           │
│                                    │                        │
│                                    ▼                        │
│                             ┌─────────────────┐            │
│                             │w_match_request  │            │
│                             │  (照合申請)     │ ★NEW      │
│                             └─────────────────┘            │
│                                                             │
│  ┌─────────────────┐  ┌─────────────────────┐             │
│  │ m_rightholder   │  │ w_rightholder_payment│             │
│  │   (権利者M)     │  │   (権利者支払)       │             │
│  └─────────────────┘  └─────────────────────┘             │
│                                                             │
│  ┌─────────────────┐  ┌─────────────────┐                 │
│  │ m_payment_route │  │ w_inquiry_log   │                 │
│  │   (入金経路M)   │  │   (本人対応)    │                 │
│  └─────────────────┘  └─────────────────┘                 │
│                                                             │
│  ┌─────────────────┐  ┌─────────────────┐                 │
│  │ w_bank_deposit  │  │ w_reminder_log  │                 │
│  │   (銀行入金)    │  │   (催促記録)    │ ★NEW           │
│  └─────────────────┘  └─────────────────┘                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. テーブル詳細

### 4.1 w_settlement（和解マスタ）

和解案件の親レコード。

| カラム | 型 | 必須 | 説明 |
|--------|-----|------|------|
| wid | TEXT | PK | 和解ID（W-000001形式） |
| hn_id | TEXT | ✓ | 発信者ID（HDB連携） |
| rightholder_id | TEXT | FK✓ | 権利者ID |
| **lawyer_id** | TEXT | FK | 相手方弁護士ID（集計用） |
| current_version | INTEGER | ✓ | 現在有効な合意バージョン |
| status | TEXT | ✓ | 履行中/完了/不履行/遅延中 |
| hdb_settlement_id | INTEGER | - | HDB側の和解ID |

#### 状態遷移

```
履行中 → 完了（全額入金）
      → 不履行（遅延継続・連絡途絶）
      → 遅延中（期日超過）
```

---

### 4.2 w_agreement_version（合意バージョン）

合意内容の履歴管理。**上書きせず新バージョン作成**。

| カラム | 型 | 必須 | 説明 |
|--------|-----|------|------|
| version_id | INTEGER | PK | バージョンID |
| wid | TEXT | FK✓ | 和解ID |
| version_number | INTEGER | ✓ | バージョン番号（1, 2, 3...） |
| agreement_date | DATE | ✓ | 合意日 |
| total_amount | INTEGER | ✓ | 総額 |
| payment_method | TEXT | ✓ | 一括/分割 |
| installment_count | INTEGER | ✓ | 分割回数 |
| agreement_pdf | BLOB | ✓ | 合意書PDF（必須） |
| change_reason | TEXT | - | 変更理由（v2以降） |
| change_detail | TEXT | - | 変更詳細 |
| effective_from | DATE | ✓ | 有効開始日 |
| effective_to | DATE | - | 有効終了日（NULL=現在有効） |

---

### 4.3 w_payment_schedule（支払スケジュール）

分割払いの各回の予定。

| カラム | 型 | 必須 | 説明 |
|--------|-----|------|------|
| schedule_id | INTEGER | PK | スケジュールID |
| wid | TEXT | FK✓ | 和解ID |
| version_id | INTEGER | FK✓ | 合意バージョンID |
| installment_number | INTEGER | ✓ | 回数（1, 2, 3...） |
| due_date | DATE | ✓ | 期日 |
| amount | INTEGER | ✓ | 金額 |
| status | TEXT | ✓ | 未入金/入金済/一部入金/遅延/免除 |
| paid_amount | INTEGER | ✓ | 入金済金額 |
| paid_at | DATE | - | 入金完了日 |

---

### 4.4 w_bank_deposit（銀行入金データ）★NEW

PayPay銀行等からのCSVインポートデータ。

| カラム | 型 | 必須 | 説明 |
|--------|-----|------|------|
| deposit_id | TEXT | PK | 入金ID（DEP-XXXX形式） |
| deposit_date | DATE | ✓ | 入金日 |
| amount | INTEGER | ✓ | 入金額 |
| remitter_name | TEXT | ✓ | 振込名義 |
| remitter_name_kana | TEXT | - | 振込名義カナ |
| bank_transaction_id | TEXT | - | 銀行取引ID |
| status | TEXT | ✓ | 未照合/照合済 |
| matched_wid | TEXT | FK | 照合先和解ID |
| matched_schedule_no | INTEGER | - | 照合先スケジュール番号 |
| imported_at | DATETIME | ✓ | インポート日時 |
| imported_by | TEXT | ✓ | インポート者 |

---

### 4.5 w_match_request（入金照合申請）★NEW

入金登録から承認までのワークフロー管理。

| カラム | 型 | 必須 | 説明 |
|--------|-----|------|------|
| request_id | TEXT | PK | 申請ID（MR-XXX形式） |
| deposit_id | TEXT | FK | 銀行入金ID |
| wid | TEXT | FK✓ | 和解ID |
| schedule_no | INTEGER | ✓ | スケジュール番号 |
| match_type | TEXT | ✓ | 通常/例外 |
| amount | INTEGER | ✓ | 金額 |
| **registered_by** | TEXT | ✓ | 登録者 |
| registered_at | DATETIME | ✓ | 登録日時 |
| **status** | TEXT | ✓ | 承認待ち/承認済み/差戻し |
| **approved_by** | TEXT | - | 承認者 |
| approved_at | DATETIME | - | 承認日時 |
| reject_reason | TEXT | - | 差戻し理由 |

**制約**: `approved_by != registered_by`（同一人物不可）

---

### 4.6 w_exception_payment（例外入金）★NEW

現金・その他の例外入金を管理。

| カラム | 型 | 必須 | 説明 |
|--------|-----|------|------|
| exception_id | TEXT | PK | 例外入金ID |
| hn_id | TEXT | FK✓ | 発信者ID |
| wid | TEXT | FK | 和解ID（紐付け先） |
| amount | INTEGER | ✓ | 入金額 |
| payment_method | TEXT | ✓ | 現金/郵便/その他 |
| payment_date | DATE | ✓ | 入金日 |
| **registered_by** | TEXT | ✓ | 登録者 |
| registered_at | DATETIME | ✓ | 登録日時 |
| **status** | TEXT | ✓ | 承認待ち/承認済み/差戻し |
| **approved_by** | TEXT | - | 承認者 |
| approved_at | DATETIME | - | 承認日時 |
| note | TEXT | - | 備考 |

---

### 4.7 w_payment_log（入金実績ログ）★追記専用

入金の事実記録。**UPDATE/DELETE禁止**。

| カラム | 型 | 必須 | 説明 |
|--------|-----|------|------|
| log_id | INTEGER | PK | ログID |
| wid | TEXT | FK✓ | 和解ID |
| schedule_id | INTEGER | FK | 紐付け支払スケジュール |
| payment_date | DATE | ✓ | 入金日 |
| amount | INTEGER | ✓ | 入金額 |
| route_code | TEXT | ✓ | 入金経路（PPB/CASH/OTHER） |
| bank_transaction_id | TEXT | - | 銀行取引ID |
| remitter_name | TEXT | - | 振込名義 |
| receiver | TEXT | - | 受領者（現金の場合） |
| note | TEXT | - | 備考 |
| registered_by | TEXT | ✓ | 登録者 |
| approved_by | TEXT | ✓ | 承認者 |

---

### 4.8 w_reminder_log（催促記録）★NEW

未入金者への催促履歴。

| カラム | 型 | 必須 | 説明 |
|--------|-----|------|------|
| reminder_id | INTEGER | PK | 催促ID |
| wid | TEXT | FK✓ | 和解ID |
| schedule_no | INTEGER | ✓ | 対象スケジュール番号 |
| reminder_date | DATE | ✓ | 催促日 |
| reminder_type | TEXT | ✓ | 電話/メール/書面 |
| result | TEXT | ✓ | 連絡済/不通/約束取付/その他 |
| next_action | TEXT | - | 次回アクション |
| handled_by | TEXT | ✓ | 担当者 |
| note | TEXT | - | 備考 |

---

### 4.9 m_payment_route（入金経路マスタ）

| コード | 名称 | 説明 | 承認 |
|--------|------|------|------|
| PPB | PayPay銀行 | 通帳連動・通常経路 | **必要** |
| CASH | 現金持参 | 例外・要承認 | **必要** |
| OTHER | その他 | 郵便・代理振込など | **必要** |

> すべての入金経路で承認が必要（不正防止）

---

### 4.10 m_rightholder（権利者マスタ）

| カラム | 型 | 必須 | 説明 |
|--------|-----|------|------|
| rightholder_id | TEXT | PK | 権利者ID |
| name | TEXT | ✓ | 権利者名 |
| bank_name | TEXT | - | 銀行名 |
| branch_name | TEXT | - | 支店名 |
| account_type | TEXT | - | 普通/当座 |
| account_number | TEXT | - | 口座番号 |
| account_holder | TEXT | - | 口座名義 |
| contact_email | TEXT | - | 連絡先メール |
| contact_phone | TEXT | - | 連絡先電話 |

---

### 4.11 m_lawyer（弁護士マスタ）★NEW

相手方弁護士の管理（集計用）。

| カラム | 型 | 必須 | 説明 |
|--------|-----|------|------|
| lawyer_id | TEXT | PK | 弁護士ID（コード） |
| name | TEXT | ✓ | 弁護士名 |
| office_name | TEXT | - | 事務所名 |
| phone | TEXT | - | 電話番号 |
| is_active | INTEGER | ✓ | 有効フラグ |

---

## 5. 承認ワークフロー

### 5.1 入金承認フロー

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│ 入金登録        │     │ 承認待ち        │     │ 入金確定        │
│ (ロールA)       │ ──▶ │ (キュー)        │ ──▶ │ (ロールA2)      │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                              │
                              │ 差戻し
                              ▼
                        ┌─────────────────┐
                        │ 再登録必要      │
                        └─────────────────┘
```

### 5.2 一括承認機能

- 承認待ち一覧でチェックボックスによる複数選択
- 「一括承認」ボタンで選択項目を一括処理
- 同一人物チェックは各項目ごとに実施

### 5.3 不正防止チェック

```javascript
if (approver === registeredBy) {
  alert('⚠ 不正防止のため、登録者と同じ担当者は承認できません。');
  return;
}
```

---

## 6. CSVインポート機能

### 6.1 PayPay銀行CSVフォーマット

| カラム | 説明 |
|--------|------|
| 取引日 | 入金日 |
| お預り金額 | 入金額 |
| 振込依頼人名 | 振込名義 |
| 取引番号 | 銀行取引ID |

### 6.2 インポート時の処理

1. CSVファイル読み込み（Shift_JIS対応）
2. ヘッダー自動検出
3. 重複チェック（取引番号で判定）
4. 名前照合（カタカナ・漢字の両方で検索）
5. プレビュー表示
6. インポート実行

---

## 7. 集計機能

### 7.1 弁護士別集計

| 集計項目 | 説明 |
|----------|------|
| 和解件数 | 担当和解の総数 |
| 入金済件数 | 完了件数 |
| 未入金件数 | 残り件数 |
| 入金総額 | 入金済金額合計 |
| 未入金総額 | 残額合計 |

### 7.2 権利者別集計

| 集計項目 | 説明 |
|----------|------|
| 和解件数 | 権利者の和解総数 |
| 入金総額 | 入金済金額合計 |
| 未入金総額 | 残額合計 |

### 7.3 催促一覧

未入金かつ期日超過のスケジュールを自動抽出。

| 表示項目 | 説明 |
|----------|------|
| 発信者名 | 対象者 |
| 和解ID | 対象和解 |
| 回数 | 第N回 |
| 期日 | 支払期日 |
| 金額 | 未入金額 |
| 遅延日数 | 経過日数 |

---

## 8. 運用ルール

### 8.1 WDB登録条件

以下**すべて**を満たしたときのみ：

1. 和解成立（HDB側）
2. 合意書PDFが存在
3. 支払方法が確定（一括/分割）

> 人手登録は禁止。HDBの「和解成立」操作から自動生成

### 8.2 やってはいけないこと

| NG | 理由 |
|----|------|
| ❌ 和解前にWDBを作る | 根拠なし |
| ❌ 金額を後から変える | 合意バージョンで対応 |
| ❌ 入金実績を上書き | 証拠性喪失 |
| ❌ HDBと混在させる | 役割混同 |
| ❌ 登録者が自分で承認 | 不正リスク |

### 8.3 修正可能範囲

| 項目 | 可否 | 備考 |
|------|------|------|
| 合意書PDF差替 | ✅ | 新バージョン作成 |
| 未来の支払予定 | ✅ | 新バージョン作成 |
| 過去の入金実績 | ❌ | 追記のみ |
| ログ削除 | ❌ | 絶対禁止 |

---

## 9. 遅延・不履行の扱い

### 9.1 自動判定

- 期日＋7日超過 → 軽度遅延 🟡
- 期日＋14日超過 → 中度遅延 🟠
- 期日＋14日超過×複数回 → 不履行候補 🔴

> 人が判断しない

### 9.2 不履行時の連携

1. HDBに通知
2. 和解ステータス変更（HDB側）
3. 弁護士判断待ちに遷移

---

## 10. 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-31 | 初版作成 |
| 2026-02-01 | 入金登録・承認の分離（不正防止）、一括承認機能、PayPay銀行CSVインポート、弁護士別集計、催促機能追加 |
