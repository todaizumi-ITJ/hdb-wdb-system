# HDB（発信者情報データベース）スキーマ設計書

## 1. 設計思想

### 1.1 HDBとは
HDB（Human Database）は、発信者開示請求で得られた開示結果を管理し、**発信者（人）を中心**に据えた中核データベースです。

### 1.2 基本原則
- **主語は「人」**：IPNではなく、発信者個人を管理単位とする
- **開示後の世界**：開示があった極めて少数のIPNについて、その先にいる「人」を管理
- **判断結果を入れるDB**：判断させるDBではない

### 1.3 IPNDBとの違い

| 観点 | IPNDB | HDB |
|------|-------|-----|
| 主語 | IPアドレス（IPN） | 人（発信者） |
| 件数 | 数百万〜数千万 | 数千〜数万 |
| 役割 | 開示請求の母集団 | 開示「後」の管理 |
| 個人情報 | 原則なし | 氏名・住所・連絡先 |
| 法的フェーズ | 開示請求前〜中 | 開示後・交渉・回収 |

> IPNDBは「弾」、HDBは「命中した相手」

---

## 2. 利用者ロールと登録画面

### 2.1 ロール定義

| ロール | 主体 | 役割 |
|--------|------|------|
| A | 事務担当 | 開示結果登録・受任通知登録 |
| B | 管理者 | 全体管理・マスタ管理 |
| C | 弁護士 | 状況確認・判断 |

### 2.2 登録画面の分離

ロールA（事務担当）の登録画面は**2つに明確に分離**：

| 登録種別 | 説明 | トリガー |
|----------|------|----------|
| 📄 プロバイダ開示登録 | プロバイダから届いた開示結果を登録 | 開示結果受領時 |
| ⚖️ 弁護士受任通知登録 | 相手方弁護士からの受任通知を登録 | 受任通知受領時 |

各登録は以下の入力方法をサポート：
- **CSVアップロード**: 複数件を一括登録
- **手動入力**: 1件ずつ入力

---

## 3. テーブル構成

### 3.1 ER図（概念）

```
┌─────────────────────────────────────────────────────────────┐
│                    HDB テーブル構成                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐       ┌─────────────────┐                 │
│  │   human     │ 1   n │  h_disclosure   │                 │
│  │  (発信者)   │───────│  (開示結果)     │                 │
│  └─────────────┘       └─────────────────┘                 │
│        │                                                    │
│        │ 1                                                  │
│        │                                                    │
│        ├──────────┬──────────┬──────────┐                  │
│        │ n        │ n        │ n        │ n                │
│  ┌─────┴─────┐ ┌──┴───┐ ┌────┴────┐ ┌───┴────┐            │
│  │ h_mandate │ │h_doc │ │h_negoti │ │h_settle│            │
│  │ (受任)    │ │_send │ │ation    │ │ment    │            │
│  │           │ │(書類 │ │(交渉    │ │(和解)  │            │
│  │           │ │送付) │ │記録)    │ │        │            │
│  └───────────┘ └──────┘ └─────────┘ └────────┘            │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐                          │
│  │ m_lawyer   │  │ m_document  │                          │
│  │ (弁護士M)  │  │ (書類M)     │                          │
│  └─────────────┘  └─────────────┘                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. テーブル詳細

### 4.1 human（発信者テーブル）★中核

発信者（人）を管理する中核テーブル。

| カラム | 型 | 必須 | 説明 |
|--------|-----|------|------|
| hn_id | TEXT | PK | 発信者ID（HN-000001形式） |
| **contract_name** | TEXT | ✓ | 契約者名 |
| **contract_name_kana** | TEXT | - | 契約者名ふりがな |
| **user_name** | TEXT | - | 利用者名 |
| **user_name_kana** | TEXT | - | 利用者名ふりがな |
| **postal_code** | TEXT | - | 郵便番号 |
| **address** | TEXT | ✓ | 住所 |
| **phone** | TEXT | - | 電話番号 |
| **email** | TEXT | - | 電子メール |
| **memo** | TEXT | - | メモ |
| mandate_status | TEXT | ✓ | 受任ステータス |
| settlement_status | TEXT | ✓ | 和解ステータス |
| current_lawyer_id | TEXT | FK | 現在の担当弁護士 |
| **registration_type** | TEXT | ✓ | 登録種別（開示/受任） |
| created_at | DATETIME | ✓ | 作成日時 |
| updated_at | DATETIME | ✓ | 更新日時 |

#### 登録種別（registration_type）

| 値 | 意味 |
|----|------|
| disclosure | プロバイダ開示登録 |
| lawyer_notice | 弁護士受任通知登録 |

#### 受任ステータス（mandate_status）

| 値 | 意味 | 弁護士名義書類 |
|----|------|---------------|
| 🔴 未受任 | 依頼なし | ❌ 不可 |
| 🟡 受任確認中 | 依頼意思あり／書面未着 | ❌ 不可 |
| 🟢 受任済 | 受任通知PDFあり | ✅ 可 |

#### 和解ステータス（settlement_status）

| 値 | 意味 |
|----|------|
| ⚪ 未着手 | 未接触 |
| 🟡 交渉中 | やり取りあり・和解未成立 |
| 🟢 和解成立 | 合意あり・WDB連携 |
| ⚫ 訴訟中 | 訴訟進行中 |
| ✅ 終了 | 完了 |

---

### 4.2 h_disclosure（開示結果テーブル）

開示請求で得られた個々の結果を格納。

| カラム | 型 | 必須 | 説明 |
|--------|-----|------|------|
| hdn_id | TEXT | PK | 開示結果ID |
| hn_id | TEXT | FK | 紐付け先の発信者ID（NULL=未紐付け） |
| ipn_id | TEXT | ✓ | IP番号（IPNDBからの参照） |
| provider | TEXT | - | プロバイダ名 |
| disclosed_at | DATE | - | 開示日 |
| disclosed_name | TEXT | - | 開示氏名 |
| disclosed_address | TEXT | - | 開示住所 |
| status | TEXT | ✓ | 開示済/処理中 |
| note | TEXT | - | 備考 |

**重要**: HDBに入るのは原則として以下のみ
1. プロバイダから開示があった
2. 相手方弁護士から通知が来た
3. 本人から電話・連絡があった

❌ IPN抽出段階では絶対に入れない

---

### 4.3 h_mandate（受任管理テーブル）

弁護士の受任状況を履歴管理。

| カラム | 型 | 必須 | 説明 |
|--------|-----|------|------|
| mandate_id | INTEGER | PK | 受任ID |
| hn_id | TEXT | FK✓ | 発信者ID |
| lawyer_id | TEXT | FK✓ | 担当弁護士ID |
| mandate_status | TEXT | ✓ | 受任確認中/受任済/解任 |
| mandate_pdf | BLOB | - | 受任通知PDF（受任済の場合必須） |
| mandate_pdf_filename | TEXT | - | PDFファイル名 |
| requested_at | DATE | - | 依頼日 |
| mandated_at | DATE | - | 受任日（PDF受領日） |
| terminated_at | DATE | - | 解任日 |
| note | TEXT | - | 備考 |

**制約**: `mandate_status = '受任済'` の場合、`mandate_pdf` 必須

---

### 4.4 h_document_send（書類送付履歴テーブル）

書類送付の履歴を記録（編集不可・証跡保全）。

| カラム | 型 | 必須 | 説明 |
|--------|-----|------|------|
| send_id | INTEGER | PK | 送付ID |
| hn_id | TEXT | FK✓ | 発信者ID |
| doc_type_id | TEXT | FK✓ | 書類種別ID |
| doc_category | TEXT | ✓ | 名義（事務名義/弁護士名義） |
| sent_at | DATETIME | ✓ | 送付日時 |
| sent_by | TEXT | - | 送付者（担当者名） |
| lawyer_id | TEXT | FK | 弁護士名義の場合の弁護士ID |
| send_method | TEXT | - | 送付方法（郵送/メール/FAX/その他） |
| send_result | TEXT | ✓ | 結果（送付済/不達/受取拒否） |
| document_pdf | BLOB | - | 送付した書類の控え |
| note | TEXT | - | 備考 |

---

### 4.5 h_negotiation（交渉記録テーブル）

交渉のタイムライン（追記専用・編集禁止）。

| カラム | 型 | 必須 | 説明 |
|--------|-----|------|------|
| negotiation_id | INTEGER | PK | 交渉記録ID |
| hn_id | TEXT | FK✓ | 発信者ID |
| occurred_at | DATETIME | ✓ | 発生日時 |
| contact_type | TEXT | ✓ | 連絡種別（電話/メール/書面/内部メモ/その他） |
| content | TEXT | ✓ | 内容（事実のみ、評価・結論は書かない） |
| recorded_by | TEXT | ✓ | 記録者名 |
| created_at | DATETIME | ✓ | 記録日時 |

**重要**: UPDATEは原則禁止（証跡保全）

---

### 4.6 h_settlement（和解情報テーブル）

和解に関する情報（WDB連携）。

| カラム | 型 | 必須 | 説明 |
|--------|-----|------|------|
| settlement_id | INTEGER | PK | 和解ID |
| hn_id | TEXT | FK✓ | 発信者ID |
| settlement_status | TEXT | ✓ | 交渉中/和解成立/決裂 |
| settled_at | DATE | - | 和解成立日 |
| settlement_amount | INTEGER | - | 和解金額 |
| payment_method | TEXT | - | 支払方法（一括/分割） |
| installment_count | INTEGER | - | 分割回数 |
| first_payment_due | DATE | - | 初回入金期限 |
| agreement_pdf | BLOB | - | 合意書PDF（和解成立の場合必須） |
| wdb_wn | TEXT | - | WDBの合意番号（連携後に設定） |
| failed_at | DATE | - | 決裂日 |
| failure_reason | TEXT | - | 決裂理由 |

---

### 4.7 m_lawyer（弁護士マスタ）

| カラム | 型 | 必須 | 説明 |
|--------|-----|------|------|
| lawyer_id | TEXT | PK | 弁護士ID（コード入力） |
| name | TEXT | ✓ | 氏名 |
| office_name | TEXT | - | 事務所名 |
| email | TEXT | - | メールアドレス |
| phone | TEXT | - | 電話番号 |
| is_active | INTEGER | ✓ | 有効フラグ |

---

### 4.8 m_document（書類マスタ）

| カラム | 型 | 必須 | 説明 |
|--------|-----|------|------|
| doc_type_id | TEXT | PK | 書類種別ID |
| doc_name | TEXT | ✓ | 書類名 |
| doc_category | TEXT | ✓ | 名義（事務名義/弁護士名義） |
| requires_mandate | INTEGER | ✓ | 受任必須フラグ（1=弁護士名義） |
| description | TEXT | - | 説明 |
| sort_order | INTEGER | ✓ | 表示順 |
| is_active | INTEGER | ✓ | 有効フラグ |

---

## 5. CSVインポート機能

### 5.1 プロバイダ開示登録CSV

| カラム | 必須 | 説明 |
|--------|------|------|
| 契約者名 | ✓ | |
| ふりがな | - | |
| 利用者名 | - | |
| 利用者ふりがな | - | |
| 郵便番号 | - | |
| 住所 | ✓ | |
| 電話番号 | - | |
| 電子メール | - | |
| メモ | - | |

### 5.2 重複チェック

CSVインポート時に以下の項目で重複チェックを実施：
- 契約者名
- 電話番号
- 住所

---

## 6. 運用ルール

### 6.1 HDBに登録されるタイミング

1. プロバイダから開示があった → **プロバイダ開示登録**
2. 相手方弁護士から通知が来た → **弁護士受任通知登録**
3. 本人から電話・連絡があった → 状況に応じて選択

### 6.2 やってはいけないこと

- ❌ IPNを主キーにする
- ❌ 開示前IPNを大量投入する
- ❌ 和解・支払DBと混ぜる
- ❌ 作業者に判断させる設計にする

### 6.3 弁護士名義書類の送付条件

```
受任ステータス = '受任済' かつ mandate_pdf IS NOT NULL
```

上記を満たさない限り、弁護士名義書類の送付は**システム的に不可能**とする。

---

## 7. WDBとの関係

```
HDB（人）
  └─ 0..n 件の WDB（和解）
```

- 合意がなければWDBに行かない
- 合意があってもHDBは必ず存在する
- h_settlement.wdb_wn で WDB.agreement.wn と連携

---

## 8. 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-31 | 初版作成 |
| 2026-02-01 | 登録画面分離（プロバイダ開示/弁護士受任）、発信者項目更新、CSVインポート機能追加 |
